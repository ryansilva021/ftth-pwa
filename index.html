<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FTTH-PWA Mapa</title>

  <script>
    window.WORKER_URL = "https://ftth-pwa.lupiing37.workers.dev";
    window.__BUILD_ID__ = "FTTH-2026-02-25-MOBILE-GPS-REGISTRO-STEP3-AUTOSYNC";
    window.SUBMIT_KEY = "1Qaz2wsX3edc";
    window.PROJECT_CENTER = [-43.166, -22.412]; // [lng, lat]
    window.PROJECT_ZOOM = 12;
  </script>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --muted:#9ca3af;
      --border:#1f2a44;
      --ok:#22c55e;
      --warn:#f59e0b;
      --blue:#3b82f6;
      --purple:#a855f7;
      --orange:#f97316;
      --radius:16px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px calc(10px + var(--safe-top));
      background:var(--panel); position:sticky; top:0; z-index:5;
    }
    .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;color:var(--muted);max-width:65vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{
      display:flex;gap:6px;align-items:center;
      font-size:12px;color:#cbd5e1;background:var(--bg);
      border:1px solid var(--border);border-radius:999px;padding:8px 12px;
      min-height:40px;
    }
    .chip input{transform:scale(1.2); accent-color: var(--ok);}
    #map{width:100vw;height:calc(100vh - 64px);}

    /* Floating buttons (mobile-first) */
    .fabCol{
      position:fixed; right:14px; bottom:calc(14px + var(--safe-bottom)); z-index:6;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab{
      width:52px;height:52px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(17,26,46,.92); color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      font-size:20px;
    }
    .fab:active{transform:scale(0.98)}
    .fabSmall{width:44px;height:44px;font-size:18px}

    /* Bottom sheet */
    .sheetBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      z-index:10; display:none;
    }
    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      z-index:11; display:none;
      background:rgba(17,26,46,.98); border-top:1px solid rgba(255,255,255,.10);
      border-radius: 20px 20px 0 0;
      padding:12px 12px calc(12px + var(--safe-bottom));
      max-height:78vh; overflow:auto;
    }
    .sheetHandle{width:44px;height:5px;border-radius:99px;background:rgba(255,255,255,.25);margin:6px auto 10px}
    .sheetTitle{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sheetTitle h3{margin:0;font-size:16px}
    .sheetTitle .x{font-size:22px;line-height:1; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15)}
    .kv{font-size:12px;color:var(--muted);margin:6px 0 12px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.15); color:#fff; font-weight:700; min-height:44px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btnPrimary{background:var(--ok); color:#001b09; border:none;}
    .btnWarn{background:var(--warn); color:#1b1200; border:none;}
    .btnBlue{background:var(--blue); color:#00112a; border:none;}
    .btn:active{transform:scale(0.99)}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:#cbd5e1}
    .field input,.field select,.field textarea{
      border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22); color:#fff; padding:12px 12px;
      font-size:15px; outline:none;
    }
    .field textarea{min-height:84px; resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    a{color:#93c5fd}

    /* MapLibre popup readability on mobile */
    .maplibregl-popup-content{
      border-radius:14px !important;
      padding:12px 12px !important;
      font-size:14px !important;
      line-height:1.35 !important;
      max-width: 80vw !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div><b>üó∫Ô∏è FTTH</b></div>
      <div class="badge" id="badge">mobile</div>
      <div class="controls">
        <label class="chip"><input id="toggleCTOs" type="checkbox" checked /> CTOs</label>
        <label class="chip"><input id="toggleCaixas" type="checkbox" checked /> Caixas</label>
        <label class="chip"><input id="toggleRotas" type="checkbox" checked /> Rotas</label>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <!-- Floating actions -->
  <div class="fabCol" aria-label="A√ß√µes">
    <div class="fab" id="btnGPS" title="Minha localiza√ß√£o">üìç</div>
    <div class="fab fabSmall" id="btnFollow" title="Seguir GPS (liga/desliga)">üß≠</div>
    <div class="fab fabSmall" id="btnPend" title="Pendentes">üßæ</div>
    <div class="fab fabSmall" id="btnSync" title="Sincronizar pendentes">üîÑ</div>
    <div class="fab fabSmall" id="btnReg" title="Registrar (√∫ltimo selecionado)">‚úçÔ∏è</div>
  </div>

  <!-- Bottom sheet + backdrop -->
  <div class="sheetBackdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHandle"></div>
    <div class="sheetTitle">
      <h3 id="sheetHeading">Detalhes</h3>
      <div class="x" id="sheetClose" role="button" aria-label="Fechar">‚úï</div>
    </div>
    <div class="kv" id="sheetSub"></div>
    <div id="sheetBody"></div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const badge = document.getElementById("badge");
      if (badge) badge.textContent = `BUILD: ${window.__BUILD_ID__}`;

      const elToggleCTOs = document.getElementById("toggleCTOs");
      const elToggleCaixas = document.getElementById("toggleCaixas");
      const elToggleRotas = document.getElementById("toggleRotas");

      const btnGPS = document.getElementById("btnGPS");
      const btnFollow = document.getElementById("btnFollow");
      const btnPend = document.getElementById("btnPend");
      const btnSync = document.getElementById("btnSync");
      const btnReg = document.getElementById("btnReg");

      const sheet = document.getElementById("sheet");
      const sheetBackdrop = document.getElementById("sheetBackdrop");
      const sheetClose = document.getElementById("sheetClose");
      const sheetHeading = document.getElementById("sheetHeading");
      const sheetSub = document.getElementById("sheetSub");
      const sheetBody = document.getElementById("sheetBody");

      // Estado
      let selected = null; // {type:'cto'|'caixa'|'rota', props, lngLat}
      let map = null;

      // GPS
      let watchId = null;
      let followOn = false;
      let userMarker = null;

      function openSheet(title, subtitle, bodyHTML) {
        sheetHeading.textContent = title || "Detalhes";
        sheetSub.innerHTML = subtitle || "";
        sheetBody.innerHTML = bodyHTML || "";
        sheetBackdrop.style.display = "block";
        sheet.style.display = "block";
      }

      function showPopup(title, message) {
        openSheet(title || "Aviso", message || "", `
          <div class="btnRow">
            <button class="btn btnPrimary" id="btnOk">OK</button>
          </div>
        `);
        const ok = document.getElementById("btnOk");
        if (ok) ok.onclick = closeSheet;
      }

      let offlinePopupShown = false;
      function onBecameOffline() {
        if (offlinePopupShown) return;
        offlinePopupShown = true;
        if (badge) badge.textContent = "üî¥ Offline (registros ser√£o salvos no aparelho)";
        showPopup("Sem internet", "Voc√™ est√° offline. Pode continuar registrando ‚Äî os registros ficam salvos no aparelho e ser√£o sincronizados quando a internet voltar.");
      }
      function onBecameOnline() {
        offlinePopupShown = false;
        if (badge) badge.textContent = "üü¢ Online ‚Äî sincronizando...";
        syncQueue({ silentIfEmpty: true, showPopups: false });
      }

      function closeSheet() {
        sheetBackdrop.style.display = "none";
        sheet.style.display = "none";
      }
      sheetBackdrop.addEventListener("click", closeSheet);
      sheetClose.addEventListener("click", closeSheet);

      function setLayerVisible(layerId, visible) {
        if (!map?.getLayer(layerId)) return;
        map.setLayoutProperty(layerId, "visibility", visible ? "visible" : "none");
      }

      function wireToggles() {
        elToggleCTOs?.addEventListener("change", () => setLayerVisible("ctos-x", elToggleCTOs.checked));
                  setLayerVisible("ctos-x-blink", (elToggleCTOs?.checked ?? true));
elToggleCaixas?.addEventListener("change", () => setLayerVisible("caixas-layer", elToggleCaixas.checked));
        elToggleRotas?.addEventListener("change", () => setLayerVisible("rotas-layer", elToggleRotas.checked));
      }

      async function fetchJSON(path) {
        const res = await fetch(`${window.WORKER_URL}${path}`);
        if (!res.ok) throw new Error(`${path} -> ${res.status}`);
        return await res.json();
      }

      function openExternalNav(lng, lat, label) {
        const ll = `${lat},${lng}`;
        const q = encodeURIComponent(label || "Destino");
        // iOS: Apple Maps works well; Android: Google Maps. We can offer both, default by platform.
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        const apple = `https://maps.apple.com/?daddr=${encodeURIComponent(ll)}&q=${q}`;
        const google = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(ll)}&destination_place_id=&travelmode=driving`;

        // Open best first; also show alternative in sheet
        window.open(isIOS ? apple : google, "_blank", "noopener");
      }

      function showSelectedSheet() {
        if (!selected) {
          openSheet("Nenhuma sele√ß√£o", "Toque em uma CTO/caixa/rota no mapa.", `<div class="hint">Dica: use üìç para achar sua posi√ß√£o.</div>`);
          return;
        }

        const { type, props, lngLat } = selected;

        if (type === "cto") {
          const title = `CTO ${props.cto_id || ""}`;
          const subtitle = `üìå ${props.bairro || ""} ‚Ä¢ ${props.rua || ""}`;
          const body = `
            <div class="btnRow">
              <button class="btn btnBlue" id="goNav">üß≠ Navegar</button>
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">Capacidade: <b>${props.capacidade ?? ""}</b></div>
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goNav").onclick = () => openExternalNav(lngLat.lng, lngLat.lat, title);
          document.getElementById("goReg").onclick = () => openRegistro("MOVIMENTACOES", props.cto_id || "");
          return;
        }

        if (type === "caixa") {
          const title = `${props.tipo || "Caixa"} ${props.id || ""}`;
          const subtitle = props.obs ? `üìù ${escapeHTML(props.obs)}` : `üìå ${props.dt_criacao || ""}`;
          const img = props.img_url ? `<a href="${props.img_url}" target="_blank" rel="noopener">Ver imagem</a>` : "";
          const body = `
            <div class="btnRow">
              <button class="btn btnBlue" id="goNav">üß≠ Navegar</button>
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">${img}</div>
            <div class="hint">Criado: ${props.dt_criacao || ""}<br>Atualizado: ${props.dt_atualizacao || ""}</div>
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goNav").onclick = () => openExternalNav(lngLat.lng, lngLat.lat, title);
          document.getElementById("goReg").onclick = () => openRegistro("LOG_EVENTOS", `${props.tipo || "CAIXA"}:${props.id || ""}`);
          return;
        }

        if (type === "rota") {
          const title = `Rota ${props.rota_id || ""}`;
          const subtitle = `Pontos: ${props.pontos || ""} ‚Ä¢ Tipos: ${escapeHTML(String(props.tipos || ""))}`;
          const body = `
            <div class="btnRow">
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">Peso m√©dio: ${props.peso_medio || ""}</div>
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goReg").onclick = () => openRegistro("LOG_EVENTOS", `ROTA:${props.rota_id || ""}`);
        }
      }

      function escapeHTML(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Registro (offline-first): salva em localStorage (fila) e mostra export
      
      async function ensureSubmitKey() {
        const embedded = (window.SUBMIT_KEY || "").trim();
        if (embedded) return embedded;

        let k = localStorage.getItem("ftth_submit_key") || "";
        if (!k) {
          k = prompt("Chave de sincroniza√ß√£o (SUBMIT_KEY):") || "";
          k = k.trim();
          if (k) localStorage.setItem("ftth_submit_key", k);
        }
        return k;
      }

      async function syncQueue(opts = {}) {
        const { silentIfEmpty = false, showPopups = false } = opts;
        const q = getQueue();
        if (!q.length) {
          if (!silentIfEmpty) {
            if (badge) badge.textContent = "Sem pend√™ncias para sincronizar";
            if (showPopups) showPopup("Sem pend√™ncias", "N√£o h√° registros pendentes para sincronizar.");
          }
          return;
        }

        if (!navigator.onLine) {
          if (badge) badge.textContent = "üî¥ Offline ‚Äî pend√™ncias mantidas";
          if (showPopups) onBecameOffline();
          return;
        }

        const key = await ensureSubmitKey();
        if (!key) {
          if (badge) badge.textContent = "Sync cancelado (sem chave)";
          if (showPopups) showPopup("Chave ausente", "SUBMIT_KEY n√£o configurada no app.");
          return;
        }

        let sent = 0;
        let failed = 0;
        const nextQueue = [];

        if (badge) badge.textContent = `Sincronizando ${q.length}...`;

        for (let i = 0; i < q.length; i++) {
          const item = q[i];
          try {
            const res = await fetch(`${window.WORKER_URL}/api/submit`, {
              method: "POST",
              headers: { "content-type": "application/json", "x-ftth-key": key },
              body: JSON.stringify({ items: [item] })
            });

            const txt = await res.text();
            let data = null;
            try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

            if (!res.ok || data?.ok === false) throw new Error(data?.error || `HTTP ${res.status}`);
            sent++;

            // Caixas
            const caixas = await fetchJSON("/api/caixas_emenda_cdo");
            const caixasGeo = {
              type: "FeatureCollection",
              features: caixas.map((cx) => ({
                type: "Feature",
                geometry: { type: "Point", coordinates: [cx.lng, cx.lat] },
                properties: cx,
              })),
            };
            map.addSource("caixas", { type: "geojson", data: caixasGeo });
            map.addLayer({
              id: "caixas-layer",
              type: "circle",
              source: "caixas",
              paint: {
                "circle-radius": 7,
                "circle-color": [
                  "match",
                  ["upcase", ["to-string", ["get","tipo"]]],
                  "CDO", "#a855f7", // roxo
                  "CE", "#f97316",  // laranja
                  "#60a5fa",
                ],
                "circle-stroke-width": 1,
                "circle-stroke-color": "#000",
              },
            });
            setLayerVisible("caixas-layer", elToggleCaixas?.checked ?? true);

            // Rotas (GeoJSON FeatureCollection)
            const rotas = await fetchJSON("/api/rotas_fibras");
            map.addSource("rotas", { type: "geojson", data: rotas });
            map.addLayer({
              id: "rotas-layer",
              type: "line",
              source: "rotas",
              layout: { "line-join": "round", "line-cap": "round" },
              paint: {
                "line-color": [
                  "case",
                  ["in","BACKBONE",["to-string",["get","tipos"]]], "#3b82f6", // backbone azul
                  ["in","RAMAL",["to-string",["get","tipos"]]], "#000000",    // ramal preto
                  ["in","DROP",["to-string",["get","tipos"]]], "#22c55e",     // drop verde
                  "#f59e0b" // rota padr√£o laranja
                ],
                "line-width": [
                  "case",
                  ["in","BACKBONE",["to-string",["get","tipos"]]], 6,
                  ["in","RAMAL",["to-string",["get","tipos"]]], 3.5,
                  ["in","DROP",["to-string",["get","tipos"]]], 2,
                  3
                ],
                "line-opacity": 0.92
              },
            });
            setLayerVisible("rotas-layer", elToggleRotas?.checked ?? true);

            // Intera√ß√µes: toque seleciona e abre sheet (mobile-first)
            map.on("click", "ctos-x", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "cto", props, lngLat: e.lngLat };
              showSelectedSheet();
            });
            map.on("click", "caixas-layer", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "caixa", props, lngLat: e.lngLat };
              showSelectedSheet();
            });
            map.on("click", "rotas-layer", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "rota", props, lngLat: e.lngLat };
              showSelectedSheet();
            });

            // Cursor desktop (n√£o atrapalha mobile)
            map.on("mouseenter", "ctos-x", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "ctos-x", () => (map.getCanvas().style.cursor = ""));
            map.on("mouseenter", "caixas-layer", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "caixas-layer", () => (map.getCanvas().style.cursor = ""));
            map.on("mouseenter", "rotas-layer", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "rotas-layer", () => (map.getCanvas().style.cursor = ""));

            if (badge) badge.textContent = `BUILD: ${window.__BUILD_ID__} ‚Ä¢ OK`;
          } catch (err) {
            console.error(err);
            if (badge) badge.textContent = `ERRO: ${String(err?.message ?? err)}`;
          }
        });
          } catch (err) {
            console.error("load error", err);
            if (badge) badge.textContent = "Erro ao carregar camadas";
          }
        });

        return map;
      }

      window.addEventListener("offline", onBecameOffline);
      window.addEventListener("online", onBecameOnline);
      if (!navigator.onLine) onBecameOffline();
      setInterval(() => { if (navigator.onLine) syncQueue({ silentIfEmpty: true, showPopups: false }); }, 45000);

      initMap();
    });
  </script>
</body>
</html>
