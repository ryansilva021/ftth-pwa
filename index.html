<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTTH-PWA Mapa</title>

  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyBXm_bmI2IWdAYlRT4xTD3i62OKNRTnL7E",
      authDomain: "ftth-pwa.firebaseapp.com",
      projectId: "ftth-pwa",
      appId: "1:500132406841:web:0d00c18ae6d6e01c18cfe8"
    };

    window.WORKER_URL = "https://ftth-pwa.lupiing37.workers.dev";
    window.__BUILD_ID__ = "FTTH-FIREBASE-2026-02-22-MAP-D";

    // Centro/zoom padr√£o (ajuste como preferir)
    window.PROJECT_CENTER = [-43.166, -22.412]; // exemplo (lon, lat)
    window.PROJECT_ZOOM = 12;
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;background:#111a2e}
    .left{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;color:#9ca3af}
    button{padding:8px 10px;border:none;border-radius:8px;background:#22c55e;color:#000;font-weight:700;cursor:pointer}
    #map{width:100vw;height:calc(100vh - 56px)}
    .error{padding:12px;background:#1f2937;color:#fff}
    pre{margin:0;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div><b>üó∫Ô∏è FTTH Mapa</b></div>
      <div class="badge" id="badge">verificando acesso...</div>
    </div>
    <div class="right">
      <button id="btnLogout">Sair</button>
    </div>
  </header>

  <div id="map"></div>

  <script>
    firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();

    const badge = document.getElementById("badge");
    const setBadge = (t) => badge.textContent = t;

    function workerBase() {
      return (window.WORKER_URL || "").replace(/\/$/, "");
    }

    async function requireAdmin() {
      const user = auth.currentUser;
      if (!user) throw new Error("not_logged_in");

      const token = await user.getIdToken(true);
      const url = workerBase() + "/me";

      const r = await fetch(url, { headers: { Authorization: "Bearer " + token } });
      const data = await r.json().catch(() => null);

      if (!data?.ok) throw new Error("me_failed");
      if (data.admin !== true) throw new Error("not_admin");

      return data;
    }

    function initMap() {
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            osm: {
              type: "raster",
              tiles: [
                "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png",
              ],
              tileSize: 256,
              attribution: "&copy; OpenStreetMap contributors",
            },
          },
          layers: [{ id: "osm", type: "raster", source: "osm" }],
        },
        center: window.PROJECT_CENTER,
        zoom: window.PROJECT_ZOOM,
        attributionControl: true,
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");
      return map;
    }

    async function boot() {
      try {
        setBadge("validando login...");
        const me = await requireAdmin();
        setBadge(`admin: ${me.email || me.uid}`);

        initMap();
      } catch (e) {
        // Se n√£o tiver permiss√£o, volta pro login
        console.warn("Acesso negado:", e);
        window.location.href = "/login.html";
      }
    }

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await auth.signOut().catch(() => {});
      window.location.href = "/login.html";
    });

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }
      boot();
    });
  </script>
</body>
</html>
