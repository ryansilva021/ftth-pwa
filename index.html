<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FTTH Map</title>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<style>
body,html{margin:0;height:100%}
#map{width:100%;height:100%}
#login{position:absolute;top:20px;left:20px;background:#111;color:#fff;padding:15px;border-radius:8px}
</style>
</head>
<body>
<div id="login">
  <input id="user" placeholder="usuario"><br>
  <input id="pass" placeholder="senha" type="password"><br>
  <button onclick="login()">Entrar</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
const API="https://ftth-pwa.pages.dev/";

let role=null;

async function login(){
  const res=await fetch(API+"/api/login",{method:"POST",body:JSON.stringify({
    username:user.value,password:pass.value
  }),headers:{"Content-Type":"application/json"},credentials:"include"});
  const j=await res.json();
  if(j.ok){
    role=j.role;
    login.style.display="none";
    loadMap();
  }else alert("login invalido");
}

let map;

function loadMap(){
  map=new maplibregl.Map({
    container:"map",
    style:"https://demotiles.maplibre.org/style.json",
    center:[-41.97,-22.48],
    zoom:12
  });

  map.on("load",async()=>{
    await loadCTOS();

    if(role==="admin"){
      map.on("click",async e=>{
        const id=prompt("ID CTO:");
        if(!id) return;

        await fetch(API+"/api/ctos",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          credentials:"include",
          body:JSON.stringify({
            id:id,nome:id,
            lat:e.lngLat.lat,lng:e.lngLat.lng,
            rua:"",bairro:""
          })
        });

        await loadCTOS();
      });
    }
  });
}

async function loadCTOS(){
  const res=await fetch(API+"/api/ctos",{credentials:"include"});
  const geo=await res.json();

  if(map.getSource("ctos")) map.getSource("ctos").setData(geo);
  else{
    map.addSource("ctos",{type:"geojson",data:geo});
    map.addLayer({
      id:"ctos-layer",
      type:"circle",
      source:"ctos",
      paint:{"circle-radius":6,"circle-color":"#ff0000"}
    });
  }
}
</script>
</body>
</html>
