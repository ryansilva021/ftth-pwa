<script>
  const badge = document.getElementById("badge");
  badge.textContent = `BUILD: ${window.__BUILD_ID__}`;

  async function loadCTOs(map) {
    try {
      const res = await fetch(`${window.WORKER_URL}/api/ctos`);
      const ctos = await res.json();

      console.log("CTOs carregadas:", ctos.length);

      // Converter para GeoJSON
      const geojson = {
        type: "FeatureCollection",
        features: ctos.map(cto => ({
          type: "Feature",
          geometry: {
            type: "Point",
            coordinates: [cto.lng, cto.lat]
          },
          properties: {
            cto_id: cto.cto_id,
            bairro: cto.bairro,
            rua: cto.rua,
            capacidade: cto.capacidade
          }
        }))
      };

      map.addSource("ctos", {
        type: "geojson",
        data: geojson
      });

      map.addLayer({
        id: "ctos-layer",
        type: "circle",
        source: "ctos",
        paint: {
          "circle-radius": 6,
          "circle-color": "#22c55e",
          "circle-stroke-width": 1,
          "circle-stroke-color": "#000"
        }
      });

      // Popup ao clicar
      map.on("click", "ctos-layer", (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <b>${props.cto_id}</b><br>
            Bairro: ${props.bairro}<br>
            Rua: ${props.rua}<br>
            Capacidade: ${props.capacidade}
          `)
          .addTo(map);
      });

      map.on("mouseenter", "ctos-layer", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "ctos-layer", () => {
        map.getCanvas().style.cursor = "";
      });

    } catch (err) {
      console.error("Erro ao carregar CTOs:", err);
    }
  }

  function initMap() {
    const map = new maplibregl.Map({
      container: "map",
      style: {
        version: 8,
        sources: {
          osm: {
            type: "raster",
            tiles: [
              "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
              "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
              "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png",
            ],
            tileSize: 256,
            attribution: "&copy; OpenStreetMap contributors",
          },
        },
        layers: [{ id: "osm", type: "raster", source: "osm" }],
      },
      center: window.PROJECT_CENTER,
      zoom: window.PROJECT_ZOOM,
      attributionControl: true,
    });

    map.addControl(new maplibregl.NavigationControl(), "top-right");

    map.on("load", () => {
      loadCTOs(map);
    });

    return map;
  }

  // Boot direto (sem auth)
  initMap();
</script>
