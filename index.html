<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>Mapa FTTH</title>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.js"></script>
<style>
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; }
    /* iOS/Safari: garante viewport real */
    #map { position: fixed; inset: 0; width: 100%; height: 100vh; height: 100dvh; }

    .panel {
      position: absolute;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: calc(14px * var(--ui-scale));
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      font-family: Arial, sans-serif;
      font-size: calc(13px * var(--ui-scale));
      min-width: 260px;
    }

    /* Escala de texto (controle deslizante 100%–200%) */
    #legend{ font-size: calc(13px * var(--ui-scale) * var(--text-scale)); }
    #legend .panel-header{ font-size: calc(14px * var(--ui-scale) * var(--text-scale)); }
    #legend .panel-body{ font-size: inherit; }
    #legend *{ font-size: inherit; }
    .leaflet-popup-content{ font-size: calc(15px * var(--ui-scale) * var(--text-scale)); }
    .leaflet-popup-content h3, .leaflet-popup-content h4 { font-size: calc(17px * var(--ui-scale) * var(--text-scale)); }
    #controls { left: 16px; top: calc(60px + env(safe-area-inset-top)); }
    #legend { right: 16px; top: calc(60px + env(safe-area-inset-top)); min-width: 240px; }
    .legend-right { min-width: 190px; max-width: 280px; }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      font-size: calc(14px * var(--ui-scale));
      margin-bottom: calc(10px * var(--ui-scale));
    }
    .panel-body{ }
    .icon-btn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      line-height: 1;
    }
    /* Slide animation (minimize/expand) */
.panel .panel-body{
  overflow: hidden;
  max-height: 60vh;
  opacity: 1;
  transform: translateY(0);
  transition: max-height 260ms ease, opacity 180ms ease, transform 260ms ease;
  will-change: max-height, opacity, transform;
}
.panel.minimized .panel-body{
  max-height: 0 !important;
  opacity: 0;
  transform: translateY(-8px);
}
    .panel.minimized{ padding-bottom: calc(10px * var(--ui-scale)); min-width: 200px; }

    /* Popups maiores */

    /* Popups ainda maiores (CTO / CE-CDO) */
    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content {
      font-size: calc(15px * var(--ui-scale) * var(--text-scale));
      line-height: 1.35;
      margin: calc(16px * var(--ui-scale)) calc(18px * var(--ui-scale));
      min-width: calc(320px * var(--ui-scale));
      max-width: calc(520px * var(--ui-scale));
    }
    .leaflet-popup-content h3, .leaflet-popup-content h4 {
      margin: 0 0 calc(10px * var(--ui-scale)) 0;
      font-size: calc(17px * var(--ui-scale) * var(--text-scale));
    }
    .leaflet-popup-content table { width: 100%; border-collapse: collapse; }
    .leaflet-popup-content td { padding: calc(6px * var(--ui-scale)) 0; vertical-align: top; }

    .leaflet-popup-content-wrapper{ border-radius: 14px; }
    .leaflet-popup-content{ font-size: calc(14px * var(--ui-scale) * var(--text-scale)); line-height: 1.35; }
    .popup-big .leaflet-popup-content{ font-size: calc(15px * var(--ui-scale) * var(--text-scale)); }

    /* ===== MapLibre popup parity (Leaflet -> MapLibre) ===== */
    .maplibregl-popup-content-wrapper { border-radius: 14px; }
    .maplibregl-popup-content{
      font-size: calc(15px * var(--ui-scale) * var(--text-scale));
      line-height: 1.35;
      margin: calc(16px * var(--ui-scale)) calc(18px * var(--ui-scale));
      min-width: calc(320px * var(--ui-scale));
      max-width: calc(520px * var(--ui-scale));
      font-family: Arial, sans-serif;
    }
    .popup-big .maplibregl-popup-content{
      font-size: calc(15px * var(--ui-scale) * var(--text-scale));
      min-width: 360px;
      max-width: 720px;
    }
    @media (max-width: 768px){
      .maplibregl-popup-content{
        font-size: calc(17px * var(--ui-scale) * 1.6) !important;
        line-height: 1.28 !important;
        margin: calc(18px * var(--ui-scale)) calc(18px * var(--ui-scale)) !important;
        min-width: min(92vw, 520px) !important;
        max-width: min(92vw, 520px) !important;
      }
      .popup-big .maplibregl-popup-content{
        min-width: min(92vw, 520px) !important;
        max-width: min(92vw, 520px) !important;
      }
    }


    .row { margin-bottom: 10px; }
    .label { display: block; font-weight: 600; margin-bottom: 4px; color: #333; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
      font-size: calc(13px * var(--ui-scale));
      box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 64px; }

    .hint { font-size: 12px; color: #666; margin-top: 6px; }
    .badge {
      display: inline-block;
      width: 10px; height: 10px; border-radius: 50%;
      margin-right: 6px;
      border: 2px solid #222;
      vertical-align: middle;
    }

    .btn {
      display: inline-block;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }
    .btn-primary { border-color: #1f6feb; color: #1f6feb; }
    .btn-danger { border-color: #d1242f; color: #d1242f; }
    .btn-success { border-color: #1a7f37; color: #1a7f37; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 20000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      width: 460px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    .modal header {
      padding: 12px 14px;
      font-weight: 800;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal .body { padding: calc(14px * var(--ui-scale)); }
    .modal .footer {
      padding: 12px 14px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .close-x {
      cursor: pointer;
      font-size: 18px;
      line-height: 20px;
      opacity: 0.6;
    }
    .close-x:hover { opacity: 1; }

    .msg {
      margin-top: 10px;
      font-size: 12px;
      padding: 8px;
      border-radius: 10px;
      display: none;
    }
    .msg.ok { background: #e9f7ef; color: #0f5132; border: 1px solid #cfe8db; }
    .msg.err { background: #fdecec; color: #842029; border: 1px solid #f5c2c7; }

    .popup-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
  /* Bigger text inside CTO action buttons (Add/Remove) */
  .popup-actions .btn{ font-size: 1.2em; font-weight: 700; letter-spacing: 0.2px; }
  @media (max-width: 768px){
    .popup-actions .btn{ font-size: 1.5em; }
  }
    /* Botões do popup CTO (maiores para toque no mobile) */
    .popup-actions .btn{
      font-size: 17px;
      padding: 12px 14px;
      min-height: 48px;
      border-radius: 12px;
      flex: 1 1 46%;
    }
    @media (max-width: 768px){
      .popup-actions{ gap: 12px; }
      .popup-actions .btn{
        font-size: 20px;
        padding: 16px 18px;
        min-height: 56px;
        border-radius: 14px;
      }
    }

    .muted { color: #666; font-size: 12px; }

    /* Caixa marker (DivIcon) */
    .caixa-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #111;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      background: #ff6d00;
    }
    .caixa-icon.cdo { background: #6a1b9a; }
    .caixa-icon.ce  { background: #ff6d00; }

    .img-preview {
      margin-top: 8px;
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }
  
    /* Saving overlay */
    .saving-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.72);
      z-index: 30000;
      display: none;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
    }
    .saving-card {
      background: #fff;
      border-radius: 14px;
      padding: 16px 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      min-width: 260px;
      max-width: 92vw;
      border: 1px solid #eee;
    }
    .saving-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .spinner {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 3px solid #ddd;
      border-top-color: #1f6feb;
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .saving-title { font-weight: 900; font-size: calc(13px * var(--ui-scale)); color: #111; }
    .saving-sub { margin-top: 6px; font-size: 12px; color: #666; }


        /* ===== Mobile / Responsivo ===== */
    .layers-fab{ display:none; }

    :root{
      --ui-scale: 1.12;
      --text-scale: 1;
      --fs-xs: clamp(11px, 2.8vw, 13px);
      --fs-sm: clamp(12px, 3.2vw, 14px);
      --fs-md: clamp(14px, 3.8vw, 16px);
      --fs-lg: clamp(16px, 4.6vw, 18px);
      --touch: 44px;
    }
    body.field-mode{
      --ui-scale: 1.28;
    }

    /* FAB (botões inferiores) - apenas mobile */
    .fab { display:none !important; /* desativado */
      
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 25000;
      display: none;
      gap: 10px;
    }
    .fab .btn { box-shadow: 0 10px 24px rgba(0,0,0,0.16); border-radius: 14px; }

    /* Popups maiores (CTOs / Caixas / Emendas-CDO) */
    .popup-big .leaflet-popup-content-wrapper{ border-radius: 16px; }
    .popup-big .leaflet-popup-content{
      margin: calc(14px * var(--ui-scale)) calc(16px * var(--ui-scale));
      font-size: calc(16px * var(--ui-scale) * var(--text-scale));
      line-height: 1.35;
      min-width: 360px;
      max-width: 720px;
    }
    .popup-big .muted{ font-size: 0.92em; }

    /* Leaflet controls bigger */
    .leaflet-control-zoom a {
      width: calc(36px * var(--ui-scale));
      height: calc(36px * var(--ui-scale));
      line-height: calc(36px * var(--ui-scale));
    }

    @media (max-width: 768px) {
      /* Mapa sempre tela cheia */
      #map { height: 100vh; height: 100dvh; }

      /* Legenda: fixa no canto superior direito (compacta) */
      #legend{
        position: fixed !important;
        top: calc(12px + env(safe-area-inset-top)) !important;
        right: 12px !important;
        left: auto !important;
        bottom: auto !important;
        max-height: 42vh !important;
        overflow: auto !important;
        min-width: 180px !important;
        max-width: 62vw !important;
        z-index: 1250;
      }

      /* Camadas: vira painel flutuante aberto via botão */
      #controls{
        position: fixed !important;
        right: 12px !important;
        left: auto !important;
        bottom: calc(76px + env(safe-area-inset-bottom)) !important;
        top: auto !important;
        width: min(92vw, 420px) !important;
        max-height: min(62vh, 520px) !important;
        overflow: auto !important;
        display: none !important;
        z-index: 1200;
      }
      #controls.is-open{ display: block !important; }

      /* Botão Camadas no canto inferior direito */
      #layersFab{
        position: fixed !important;
        right: 14px !important;
        bottom: calc(14px + env(safe-area-inset-bottom)) !important;
        display: inline-flex !important;
        z-index: 1300;
      }

      /* HUD no topo central */
      #hud{
        top: calc(10px + env(safe-area-inset-top));
        font-size: var(--fs-sm);
      }

      /* Aumenta controles Leaflet */
      .leaflet-control-zoom a{
        width: var(--touch);
        height: var(--touch);
        line-height: var(--touch);
        font-size: var(--fs-lg);
      }
    }

    @media (max-width: 420px) {
      #legend{ max-width: 88vw !important; }
      #controls{ width: min(340px, 92vw) !important; }
      .layers-fab{ padding: 12px 14px; font-size: 15px; border-radius: 14px; }
    }
@media (max-width: 480px) {
      :root{
      --ui-scale: 1.12;
      --fs-xs: clamp(11px, 2.8vw, 13px);
      --fs-sm: clamp(12px, 3.2vw, 14px);
      --fs-md: clamp(14px, 3.8vw, 16px);
      --fs-lg: clamp(16px, 4.6vw, 18px);
      --touch: 44px;
    }
    body.field-mode{
      --ui-scale: 1.28;
    }
      .btn { font-size: 17px; }
      .popup-big .leaflet-popup-content{
        font-size: 20px;
        min-width: 92vw;
        max-width: 92vw;
      }
    }

    /* Prevent selection glitches on touch */
    #map { touch-action: pan-x pan-y; }


    /* ===== Layout Mobile/Legenda/Camadas (v18) ===== */
    #legend{
      position: fixed !important;
      top: 12px !important;
      right: 12px !important;
      left: auto !important;
      bottom: auto !important;
      z-index: 6000 !important;
      width: min(340px, 92vw) !important;
      pointer-events: auto;
    }
    #controls{
      position: fixed !important;
      top: 72px !important;
      left: 12px !important;
      right: auto !important;
      bottom: auto !important;
      z-index: 6000 !important;
      width: min(380px, 92vw) !important;
      pointer-events: auto;
    }

    @media (max-width: 768px){
      /* Legenda sempre no canto superior direito */
      #legend{
        top: calc(12px + env(safe-area-inset-top)) !important;
        right: 12px !important;
        left: auto !important;
        width: min(300px, 88vw) !important;
      }
      /* Camadas vira painel flutuante controlado pelo botão no canto inferior direito */
      #controls{
        display: none;
        top: auto !important;
        left: auto !important;
        right: 12px !important;
        bottom: calc(72px + env(safe-area-inset-bottom)) !important;
        width: min(92vw, 420px) !important;
        max-height: 60vh !important;
        overflow: auto !important;
      }
      #controls.is-open{ display: block; }
      #layersFab{ display: inline-flex !important; }
    }


    body { font-size: var(--fs-md); }

    /* Touch targets */
    button, .fab, .panel button {
      min-height: var(--touch);
      min-width: var(--touch);
      font-size: calc(var(--fs-md) * 1);
      line-height: 1.1;
    }
    input, select {
      min-height: var(--touch);
      font-size: var(--fs-md);
    }

    /* Popup: legível no mobile */
    .leaflet-popup { max-width: min(92vw, 420px) !important; }
    .leaflet-popup-content-wrapper { border-radius: 14px; }
    .leaflet-popup-content { margin: 12px 14px; font-size: var(--fs-md); line-height: 1.4; }
    .leaflet-tooltip { font-size: var(--fs-sm); }

    /* HUD superior (contadores) */
    #hud {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: calc(10px + env(safe-area-inset-top));
      z-index: 9999;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 8px 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      font-family: Arial, sans-serif;
      font-size: var(--fs-sm);
      display: flex;
      gap: 12px;
      align-items: center;
      pointer-events: none;
      max-width: 92vw;
      white-space: nowrap;
    }
    #hud span { display:inline-flex; gap:6px; align-items:center; }
    #hud b { font-weight: 700; }


  /* ==== MOBILE: AUMENTO SEVERO (legibilidade em campo) ==== */
  @media (max-width: 820px) {
    :root{
      --fs-xs: clamp(15px, 4.2vw, 18px);
      --fs-sm: clamp(16px, 4.6vw, 20px);
      --fs-md: clamp(18px, 5.2vw, 22px);
      --fs-lg: clamp(20px, 5.8vw, 26px);
    }

    body{ font-size: var(--fs-md); }

    /* Painéis e botões maiores */
    .panel{ border-radius: 18px; }
    .panel h3{ font-size: var(--fs-lg); }
    label, .hint, .small, .muted{ font-size: var(--fs-sm); }

    input, select{
      min-height: 52px;
      font-size: var(--fs-md) !important;
      padding: 12px 14px !important;
    }

    button{
      min-height: 52px;
      font-size: var(--fs-md) !important;
      padding: 12px 16px !important;
    }

    /* Zoom do Leaflet ( + / - ) gigante */
    .leaflet-control-zoom a{
      width: 56px !important;
      height: 56px !important;
      line-height: 56px !important;
      font-size: 34px !important;
    }

    /* Popups maiores */
    .leaflet-popup{
      max-width: min(94vw, 520px) !important;
    }
    .leaflet-popup-content-wrapper{
      border-radius: 16px !important;
    }
    .leaflet-popup-content{
      font-size: var(--fs-md) !important;
      line-height: 1.45 !important;
      margin: 14px 16px !important;
    }

    /* Legenda sempre legível */
    #legend{
      width: min(92vw, 420px) !important;
    }

    /* Botão Camadas (FAB) maior */
    #layersFab{
      width: 64px !important;
      height: 64px !important;
      font-size: 30px !important;
      border-radius: 18px !important;
    }

    /* HUD maior */
    #hud{
      font-size: var(--fs-md) !important;
      padding: 10px 12px !important;
      border-radius: 14px !important;
    }
  }


    /* ===== Severe Mobile: aumenta conteúdo interno da legenda e popups ===== */
    @media (max-width: 768px){
      /* Legenda: texto interno bem maior */
      #legend{
        font-size: calc(16px * var(--ui-scale) * 1.45) !important;
        line-height: 1.25 !important;
      }
      #legend .panel-header{
        font-size: calc(18px * var(--ui-scale) * 1.55) !important;
      }
      #legend .icon-btn{
        width: 46px !important;
        height: 46px !important;
        font-size: 26px !important;
      }
      #legend .panel-body{
        font-size: inherit !important;
      }
      #legend details summary{
        font-size: calc(16px * var(--ui-scale) * 1.55) !important;
        padding: 10px 0 !important;
      }
      #legend details{
        margin-top: 10px !important;
      }
      #legend b{
        font-size: 1.08em !important;
      }

      /* Popup Leaflet (CTO / CE / CDO) ainda maior e mais legível */
      .leaflet-popup-content{
        font-size: calc(17px * var(--ui-scale) * 1.6) !important;
        line-height: 1.28 !important;
        margin: calc(18px * var(--ui-scale)) calc(18px * var(--ui-scale)) !important;
        min-width: min(92vw, 520px) !important;
        max-width: min(92vw, 520px) !important;
      }
      .leaflet-popup-content-wrapper{
        border-radius: 18px !important;
      }

      /* Modal interno (clientes/CTO e caixas) maior */
      .modal{
        width: min(96vw, 620px) !important;
      }
      .modal header{
        font-size: calc(18px * var(--ui-scale) * 1.6) !important;
        padding: 16px 16px !important;
      }
      .modal .body{
        font-size: calc(16px * var(--ui-scale) * 1.45) !important;
      }
      .modal .body label{
        font-size: 1.05em !important;
        font-weight: 800 !important;
      }
      .modal .footer button{
        min-height: 60px !important;
        font-size: calc(16px * var(--ui-scale) * 1.4) !important;
      }
    }

  

    /* ===== Override (v19): Camadas no canto inferior esquerdo + independente da legenda ===== */
    /* Desktop */
    #controls{
      position: fixed !important;
      bottom: 16px !important;
      left: 16px !important;
      top: auto !important;
      right: auto !important;
    }

    /* Mobile: botão e painel de Camadas no canto inferior esquerdo */
    @media (max-width: 768px){
      #layersFab{
        left: 14px !important;
        right: auto !important;
        bottom: calc(14px + env(safe-area-inset-bottom)) !important;
      }
      #controls{
        left: 12px !important;
        right: auto !important;
        bottom: calc(72px + env(safe-area-inset-bottom)) !important;
        top: auto !important;
      }
    }

  
/* ===== Login overlay ===== */
.login-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 50000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  font-family: Arial, sans-serif;
}
.login-card{
  width: 420px;
  max-width: 100%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.28);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.08);
}
.login-card header{
  padding: 14px 16px;
  font-weight: 900;
  border-bottom: 1px solid #eee;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.login-card .body{ padding: 14px 16px; }
.login-card .footer{
  padding: 12px 16px;
  border-top: 1px solid #eee;
  display:flex;
  gap: 10px;
  justify-content: flex-end;
  flex-wrap: wrap;
}
.login-small{ font-size: 12px; color:#666; }
.login-msg{
  margin-top: 10px;
  font-size: 12px;
  padding: 8px 10px;
  border-radius: 10px;
  display: none;
  border: 1px solid transparent;
}
.login-msg.err{ background:#fdecec; color:#842029; border-color:#f5c2c7; }
.login-msg.ok{ background:#e9f7ef; color:#0f5132; border-color:#cfe8db; }

  
    /* ===== Auth bar ===== */
    .auth-bar{
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      max-width: calc(100vw - 20px);
    }
    .auth-user{ font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 42vw; }
    .auth-actions{ display:flex; gap:8px; }
    .btn-small{ padding: 6px 10px; font-size: 12px; border-radius: 10px; }

    /* ===== Admin modal ===== */
    .admin-backdrop{
      position: fixed;
      inset: 0;
      z-index: 20000;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .admin-modal{
      width: min(860px, 96vw);
      max-height: min(84vh, 84dvh);
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      display:flex;
      flex-direction: column;
    }
    .admin-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      background: rgba(250,250,250,0.95);
    }
    .admin-title{ font-weight: 700; }
    .admin-body{ padding: 12px 14px; overflow:auto; }
    .admin-tabs{ display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 10px; }
    .tab-btn{
      border: 1px solid rgba(0,0,0,0.12);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .tab-btn.active{ background: rgba(0,0,0,0.06); font-weight: 700; }
    .admin-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .admin-grid .row{ margin:0; }
    .admin-actions{ display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }

    /* Rotas (Admin): evita "scroll duplo" (textarea auto-expande; scroll fica só no modal) */
    #rotaPts{
      min-height: 140px;
      resize: none;
      overflow: hidden;
      line-height: 1.25;
    }
    .table{
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th, .table td{
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 8px 6px;
      text-align: left;
      vertical-align: middle;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      font-size: 11px;
    }
    .pill.on{ background: rgba(0,160,0,0.10); }
    .pill.off{ background: rgba(200,0,0,0.10); }
    .admin-hint{ font-size: 12px; opacity: 0.85; margin: 8px 0 0; }
    @media (max-width: 720px){
      .admin-grid{ grid-template-columns: 1fr; }
      .auth-user{ max-width: 52vw; }
    }


/* ===== V4.1: Legenda no canto superior esquerdo (fixa) ===== */
#legend{
  position: fixed !important;
  top: calc(12px + env(safe-area-inset-top)) !important;
  left: 12px !important;
  right: auto !important;
  bottom: auto !important;
  z-index: 6000 !important;
}


/* ===== V4.2: Painel somente Caixas/CDO (sem Camadas) ===== */
#controls{
  position: fixed !important;
  left: 12px !important;
  bottom: calc(12px + env(safe-area-inset-bottom)) !important;
  top: auto !important;
  right: auto !important;
  z-index: 6000 !important;
  width: min(380px, 92vw) !important;
  max-height: 56vh !important;
  overflow: auto !important;
}
@media (max-width: 768px){
  #controls{
    left: 12px !important;
    right: auto !important;
    bottom: calc(12px + env(safe-area-inset-bottom)) !important;
    width: min(92vw, 420px) !important;
  }
}


  .search-bar{
    position:absolute;
    top:10px;
    left:10px;
    z-index:600;
    display:flex;
    gap:6px;
    align-items:center;
    padding:8px;
    background:rgba(255,255,255,0.94);
    border:1px solid rgba(0,0,0,0.12);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    max-width:min(560px, calc(100vw - 20px));
  }
  .search-input{
    width:min(320px, 45vw);
    padding:8px 10px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.18);
    outline:none;
    font-size:13px;
  }
  .net-badge{
    font-size:12px;
    font-weight:800;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,0.14);
    background:#fff;
  }
  .net-badge.online{ }
  .net-badge.offline{ opacity:.7; }


    .cto-x-icon{
    width: 20px;
    height: 20px;
    transform: translateZ(0);
  }

  /* Ícone CTO em SVG: contorno preto + traço colorido por ocupação */
  .cto-x-icon svg{ display:block; width:20px; height:20px; }

  @keyframes ctoPulse {
    0%   { filter: drop-shadow(0 0 0 rgba(255,0,0,0)) drop-shadow(0 0 0 rgba(255,255,255,0)); }
    50%  { filter: drop-shadow(0 0 28px rgba(255,0,0,1)) drop-shadow(0 0 14px rgba(255,255,255,0.85)) drop-shadow(0 0 10px rgba(255,0,0,0.9)); }
    100% { filter: drop-shadow(0 0 0 rgba(255,0,0,0)) drop-shadow(0 0 0 rgba(255,255,255,0)); }
  }
  .cto-x-icon.cto-pulse{
    animation: ctoPulse 0.9s infinite ease-in-out;
    will-change: filter;
  }

@media (prefers-reduced-motion: reduce){
    .cto-x-icon.cto-pulse{ animation: none; }
  }


    /* ===== Mobile-first overrides ===== */
    @media (max-width: 768px){
      :root{ --ui-scale: 1; }
      html, body { height: 100%; }
      body { overflow: hidden; background: #000; }

      #map{ height: 100vh; width: 100vw; }

      /* HUD no topo, compacto */
      #hud{
        top: calc(10px + env(safe-area-inset-top));
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 10px;
        gap: 10px;
        font-size: 13px;
        border-radius: 14px;
        max-width: calc(100vw - 20px);
        white-space: nowrap;
      }

      /* Auth bar: botões grandes */
      .auth-bar{
        top: calc(10px + env(safe-area-inset-top));
        right: 10px;
        left: auto;
        transform: none;
        border-radius: 14px;
      }
      .auth-bar .auth-actions .btn{ min-height: 44px; padding: 10px 14px; }
      .auth-bar .auth-user{ font-size: 14px; }

      /* Legenda vira bottom sheet */
      #legend.panel.legend-right{
        left: 10px;
        right: 10px;
        top: auto !important;
        bottom: calc(10px + env(safe-area-inset-bottom));
        width: auto !important;
        max-width: none !important;
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,.25);
        max-height: 60vh;
        overflow: hidden;
      }
      #legend .panel-body{
        max-height: calc(60vh - 110px);
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      /* Quando minimizada: desliza pra baixo, mostrando só o header */
      #legend.minimized{
        transform: translateY(calc(60vh - 52px));
      }
      #legend{ transition: transform .2s ease; }

      /* Botão flutuante (menu) */
      .fab{
        position: fixed;
        z-index: 1200;
        right: 14px;
        bottom: calc(14px + env(safe-area-inset-bottom));
        width: 52px;
        height: 52px;
        border-radius: 16px;
        border: 2px solid rgba(0,0,0,.25);
        background: #fff;
        font-size: 22px;
        font-weight: 900;
        line-height: 1;
        box-shadow: 0 10px 30px rgba(0,0,0,.25);
        touch-action: manipulation;
      }

      /* Popups mais amigáveis no mobile */
      .leaflet-popup-content{ font-size: 15px; }
      .leaflet-control-zoom{ margin-top: calc(60px + env(safe-area-inset-top)); }
    }

    .fab{ display:none; }
    @media (max-width: 768px){ .fab{ display:block; } }


#btnNearMe:active{transform:scale(0.95);}

/* ===== Modal "Perto de mim" ===== */
.nearme-modal-backdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 10050;
  display: none;
  align-items: flex-end;
  justify-content: center;
  padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
}
.nearme-modal{
  width: min(640px, 100%);
  max-height: 72vh;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  overflow: hidden;
}
.nearme-modal header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(0,0,0,0.08);
}
.nearme-modal header .title{
  font-weight: 800;
  font-size: 14px;
}
.nearme-modal header .sub{
  font-size: 12px;
  opacity: 0.7;
  margin-top: 2px;
}
.nearme-close{
  border: none;
  background: rgba(0,0,0,0.06);
  border-radius: 10px;
  width: 36px; height: 36px;
  display:flex; align-items:center; justify-content:center;
  font-size: 18px;
  cursor: pointer;
}
.nearme-list{
  overflow:auto;
  max-height: calc(72vh - 56px);
  -webkit-overflow-scrolling: touch;
}
.nearme-item{
  width: 100%;
  border: none;
  background: #fff;
  padding: 12px 14px;
  display:flex;
  gap: 10px;
  align-items: center;
  text-align:left;
  cursor:pointer;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
.nearme-item:active{ background: rgba(0,0,0,0.04); }
.nearme-pill{
  flex: 0 0 auto;
  font-size: 11px;
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(0,0,0,0.06);
}
.nearme-main{
  flex: 1 1 auto;
  min-width: 0;
}
.nearme-main .name{
  font-weight: 800;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.nearme-main .meta{
  font-size: 12px;
  opacity: 0.75;
  margin-top: 2px;
}
.nearme-dist{
  flex: 0 0 auto;
  font-weight: 800;
  font-size: 12px;
  opacity: 0.9;
}


/* ============================
   DASHBOARD MOBILE (verde + dark)
   ============================ */
:root{
  --dash-green: #22c55e;
  --dash-green2:#16a34a;
  --dash-dark:#0b1220;
  --dash-card: rgba(11,18,32,0.86);
  --dash-stroke: rgba(255,255,255,0.10);
  --dash-txt: rgba(255,255,255,0.92);
  --dash-muted: rgba(255,255,255,0.70);
}
.dash{
  position: fixed;
  top: calc(10px + env(safe-area-inset-top));
  left: 10px;
  right: 10px;
  z-index: 20000;
  padding: 12px 12px 10px;
  border-radius: 18px;
  background: var(--dash-card);
  border: 1px solid var(--dash-stroke);
  box-shadow: 0 18px 40px rgba(0,0,0,0.28);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.dash-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-family: Arial, sans-serif;
  font-weight: 900;
  color: var(--dash-txt);
  letter-spacing: 0.2px;
  margin-bottom: 10px;
}
.dash-title .dot{
  width: 10px; height: 10px;
  border-radius: 999px;
  background: var(--dash-green);
  box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
}
.dash-cards{
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}
.kpi{
  border-radius: 16px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
}
.kpi-label{
  font-family: Arial, sans-serif;
  font-size: 12px;
  font-weight: 800;
  color: var(--dash-muted);
  margin-bottom: 6px;
}
.kpi-value{
  font-family: Arial, sans-serif;
  font-size: 22px;
  font-weight: 900;
  color: #fff;
  line-height: 1;
}
.kpi-warn{
  border-color: rgba(34,197,94,0.20);
  background: linear-gradient(135deg, rgba(34,197,94,0.16), rgba(22,163,74,0.06));
}
@media (max-width: 520px){
  .dash-cards{ grid-template-columns: 1fr; }
  .kpi-value{ font-size: 24px; }
}

/* ===== Drawer (hamburger menu) ===== */
.menu-btn{
  position: fixed;
  top: calc(10px + env(safe-area-inset-top));
  left: 10px;
  z-index: 25000;
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(11,18,32,0.86);
  color: rgba(255,255,255,0.92);
  box-shadow: 0 18px 40px rgba(0,0,0,0.28);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 20px;
  font-weight: 900;
}
.menu-btn:active{ transform: scale(0.98); }

.drawer-overlay{
  position: fixed;
  inset: 0;
  z-index: 24000;
  background: rgba(0,0,0,0.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease;
}

.drawer{
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 24500;
  width: 50vw;
  max-width: 520px;
  min-width: 320px;
  background: rgba(11,18,32,0.96);
  border-right: 1px solid rgba(255,255,255,0.10);
  box-shadow: 18px 0 40px rgba(0,0,0,0.35);
  transform: translateX(-102%);
  transition: transform 220ms ease;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  display:flex;
  flex-direction: column;
}

.drawer.open{ transform: translateX(0); }
.drawer-overlay.open{
  opacity: 1;
  pointer-events: auto;
}

.drawer-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 14px 14px 10px;
}

.drawer-title{
  display:flex;
  align-items:center;
  gap: 10px;
  color: rgba(255,255,255,0.92);
  font-family: Arial, sans-serif;
  font-weight: 900;
  letter-spacing: 0.2px;
}

.drawer-dot{
  width: 10px; height: 10px;
  border-radius: 999px;
  background: #22c55e;
  box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
}

.drawer-close{
  width: 40px;
  height: 40px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  cursor:pointer;
  font-size: 18px;
  font-weight: 900;
}
.drawer-close:active{ transform: scale(0.98); }

.drawer-content{
  padding: 0 14px 14px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* Colocando os painéis dentro do drawer (mapa fica clean) */
.in-drawer{
  position: static !important;
  left: auto !important;
  right: auto !important;
  top: auto !important;
  bottom: auto !important;
  z-index: auto !important;
  margin: 12px 0;
  box-shadow: none !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  background: rgba(255,255,255,0.06) !important;
  color: rgba(255,255,255,0.92);
}

.in-drawer .panel-header{
  color: rgba(255,255,255,0.92);
}
.in-drawer .label, .in-drawer .hint { color: rgba(255,255,255,0.70) !important; }
.in-drawer input, .in-drawer select, .in-drawer textarea{
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  border: 1px solid rgba(255,255,255,0.10);
}
.in-drawer input::placeholder, .in-drawer textarea::placeholder{ color: rgba(255,255,255,0.55); }

/* Dashboard quando dentro do drawer */
#dash.in-drawer{
  padding: 12px 12px 10px !important;
}
#dash.in-drawer .kpi{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
}
#dash.in-drawer .kpi-warn{
  border-color: rgba(34,197,94,0.20);
  background: linear-gradient(135deg, rgba(34,197,94,0.16), rgba(22,163,74,0.06));
}

/* No mobile muito estreito: garante usabilidade mantendo ~metade */
@media (max-width: 420px){
  .drawer{ width: 78vw; min-width: 0; }
}

/* ===== Drawer layout profissional (organização interna) ===== */
.drawer-content{
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Seções em acordeão */
.drawer-sec{
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.04);
  border-radius: 16px;
  overflow: hidden;
}

.drawer-sec summary{
  list-style: none;
  cursor: pointer;
  padding: 12px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  color: rgba(255,255,255,0.92);
  font-family: Arial, sans-serif;
  font-weight: 900;
  user-select: none;
}
.drawer-sec summary::-webkit-details-marker{ display:none; }

.drawer-sec .sec-left{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}
.drawer-sec .sec-ico{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(34,197,94,0.12);
  border: 1px solid rgba(34,197,94,0.25);
  flex: 0 0 auto;
}
.drawer-sec .sec-title{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.2px;
}
.drawer-sec .sec-right{
  opacity: 0.75;
  font-weight: 900;
  transform: rotate(0deg);
  transition: transform 140ms ease;
}
.drawer-sec[open] .sec-right{ transform: rotate(90deg); }

.drawer-sec-body{
  padding: 0 12px 12px;
}

/* Ajustes dos painéis originais quando estão dentro do drawer */
.in-drawer{
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;
  margin: 0 !important;
  padding: 0 !important; /* o padding fica no container da seção */
  background: transparent !important;
  border: none !important;
}

/* Alguns painéis usam .panel com padding próprio: neutraliza */
.in-drawer.panel{ box-shadow:none !important; }

/* Para evitar UI duplicada/bagunçada: escondemos o header original dos painéis dentro do drawer.
   O header da seção (summary) vira o "título" oficial. */
.in-drawer .panel-header{ display: none !important; }

/* Inputs mais "app-like" no drawer */
.drawer-sec-body input, .drawer-sec-body select, .drawer-sec-body textarea{
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  border: 1px solid rgba(255,255,255,0.10);
}

/* Dashboard dentro do drawer: grid confortável */
#dash.in-drawer .dash-cards{
  grid-template-columns: 1fr 1fr;
}
#dash.in-drawer .kpi-value{ font-size: 20px; }

/* Em telas pequenas, 1 coluna */
@media (max-width: 420px){
  #dash.in-drawer .dash-cards{ grid-template-columns: 1fr; }
}



/* Drawer respeita o slider de tamanho de texto */
.drawer{
  font-size: calc(14px * var(--ui-scale) * var(--text-scale));
}

/* ===== Fix: painéis dentro do drawer NÃO podem manter regras mobile fixed do mapa ===== */
#legend.in-drawer{
  position: static !important;
  top: auto !important;
  right: auto !important;
  left: auto !important;
  bottom: auto !important;
  max-height: none !important;
  overflow: visible !important;
  min-width: 0 !important;
  width: 100% !important;
}
#controls.in-drawer{
  position: static !important;
  top: auto !important;
  right: auto !important;
  left: auto !important;
  bottom: auto !important;
  width: 100% !important;
  min-width: 0 !important;
}

/* Quando a seção estiver fechada, garante que nada "vaze" */
.drawer-sec:not([open]) .drawer-sec-body{
  display: none;
}

/* Slider de texto mais limpo dentro do drawer */
#legend.in-drawer #textScaleRange{ width: 100%; }
#legend.in-drawer .row{ margin-bottom: 12px; }


.menu-btn.hidden{ opacity:0; pointer-events:none; }

/* ===== Mobile touch boost (iOS/Android) ===== */
@media (max-width: 600px){
  :root{
    --ui-scale: 1.32;
    --touch: 54px;
    --fs-xs: clamp(12px, 3.4vw, 14px);
    --fs-sm: clamp(13px, 3.8vw, 15px);
    --fs-md: clamp(15px, 4.4vw, 17px);
    --fs-lg: clamp(17px, 5.0vw, 19px);
  }
  .menu-btn{
    width: 56px;
    height: 56px;
    border-radius: 18px;
    font-size: 22px;
  }
  .drawer-close{
    width: 54px;
    height: 54px;
    border-radius: 18px;
    font-size: 22px;
  }
  /* HUD pills mais “tocáveis” */
  #hud{
    padding: 10px 12px !important;
    border-radius: 16px !important;
    gap: 10px !important;
  }
  #hud .hud-item{
    font-size: var(--fs-sm) !important;
  }
  /* Leaflet controls (zoom, layers) */
  .leaflet-control-zoom a{
    width: var(--touch) !important;
    height: var(--touch) !important;
    line-height: var(--touch) !important;
    font-size: 22px !important;
  }
  .leaflet-control-layers-toggle{
    width: var(--touch) !important;
    height: var(--touch) !important;
  }
  /* Botão flutuante (ex: geoloc) */
  .fab, #locBtn, .loc-btn{
    width: 58px !important;
    height: 58px !important;
    border-radius: 22px !important;
  }
}


/* =========================
   MOBILE OVERRIDES (FINAL)
   Forces larger touch targets + HUD sizing even inside Apps Script wrapper/iframe.
   ========================= */
html{ -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

@media (pointer: coarse), (max-width: 900px){
  :root{
    /* bump overall scale */
    --fs-xs: clamp(12px, 3.2vw, 14px);
    --fs-sm: clamp(14px, 3.6vw, 16px);
    --fs-md: clamp(16px, 4.2vw, 18px);
    --fs-lg: clamp(18px, 4.8vw, 20px);
    --touch: 52px; /* bigger tap targets */
  }

  body{ font-size: 16px; }

  /* Hamburger + close */
  #menuBtn, .menu-btn{
    width: 52px !important;
    height: 52px !important;
    font-size: 22px !important;
    border-radius: 16px !important;
  }
  #drawerClose, .drawer-close{
    width: 52px !important;
    height: 52px !important;
    font-size: 22px !important;
    border-radius: 16px !important;
  }

  /* HUD top pills */
  #hud{
    font-size: var(--fs-md) !important;
    padding: 12px 14px !important;
    border-radius: 16px !important;
    gap: 12px !important;
  }
  #hud .hud-item,
  #hud .hud-label,
  #hud .hud-value{
    font-size: var(--fs-sm) !important;
  }

  /* Leaflet controls */
  .leaflet-control-zoom a,
  .leaflet-bar a{
    width: var(--touch) !important;
    height: var(--touch) !important;
    line-height: var(--touch) !important;
    font-size: 20px !important;
  }

  /* Drawer typography */
  .drawer, #drawer{
    font-size: var(--fs-sm) !important;
  }
  .drawer h1,.drawer h2,.drawer h3,
  #drawer h1,#drawer h2,#drawer h3{
    font-size: var(--fs-md) !important;
  }

  /* KPIs inside drawer */
  .kpi-value{ font-size: clamp(26px, 7vw, 32px) !important; }
  .kpi-label{ font-size: var(--fs-xs) !important; }
}

/* extra small phones */
@media (max-width: 420px){
  #hud{ max-width: calc(100vw - 16px) !important; }
}



/* ======================================================================
   MOBILE TOP HEADER: connect MENU + HUD + USER, keep everything visible
   - Does NOT change JS logic/IDs
   - Adds a background bar behind the existing fixed controls
   - Forces dark theme equal to menu, increases sizes, fixes iOS transparency
   ====================================================================== */
:root{
  --top-bg: rgba(11,18,32,0.94);
  --top-border: rgba(255,255,255,0.16);
  --top-text: rgba(255,255,255,0.96);
  --top-pill: rgba(255,255,255,0.14);
  --top-pill-border: rgba(255,255,255,0.18);
  --side-w: 140px;
}

/* Background bar behind the header controls (doesn't block clicks) */
#sideBarBg{
  position: fixed;
  left: 10px;
  top: calc(10px + env(safe-area-inset-top));
  bottom: calc(10px + env(safe-area-inset-bottom));
  width: var(--side-w);
  z-index: 20000;
  border-radius: 22px;
  background: var(--top-bg);
  border: 1px solid var(--top-border);
  box-shadow: 0 18px 40px rgba(0,0,0,0.30);
  pointer-events: none;
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}

/* Ensure controls are above the side bar */
.menu-btn{ z-index: 26000 !important; background: var(--top-pill) !important; border-color: var(--top-pill-border) !important; color: var(--top-text) !important; -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); }
.menu-btn{ position: fixed !important; left: 18px !important; top: calc(18px + env(safe-area-inset-top)) !important; }

#hud{ z-index: 25500 !important; }
.auth-bar{ z-index: 25500 !important; }
/* Auth/User block anchored to bottom of sidebar (menu stays on top) */
.auth-bar{
  position: fixed !important;
  left: 18px !important;
  right: auto !important;
  top: auto !important;
  bottom: calc(18px + env(safe-area-inset-bottom)) !important;
  width: calc(var(--side-w) - 16px) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 10px !important;
  padding: 12px !important;
  border-radius: 18px !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
.auth-user{ max-width: 100% !important; justify-content: center !important; }
/* HUD becomes dark pills like menu (no transparency) */
#hud{
  z-index: 25500 !important;
  position: fixed !important;
  top: calc(10px + env(safe-area-inset-top)) !important;
  left: calc(50% + (var(--side-w) / 2)) !important;
  transform: translateX(-50%) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
  padding: 10px 12px !important;
  border-radius: 22px !important;
  background: var(--top-bg) !important;
  border: 1px solid var(--top-border) !important;
  box-shadow: 0 18px 40px rgba(0,0,0,0.30) !important;
  height: auto !important;
  max-width: calc(100vw - 20px - var(--side-w)) !important;
  white-space: normal !important;
  flex-wrap: wrap !important;
  pointer-events: none;
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}
#hud > span{
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--top-pill) !important;
  border: 1px solid var(--top-pill-border) !important;
  color: var(--top-text) !important;
  white-space: nowrap !important;
}
#hud > span b{
  color: var(--top-text) !important;
  font-weight: 900 !important;
  font-size: 1.15em !important;
}
/* Make the emoji icons larger (first char in span) */
#hud > span{ font-weight: 900 !important; font-size: 15px !important; }
#hud > span{ line-height: 1 !important; }

/* User/auth bar dark like menu */
.auth-bar{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  position: fixed !important;
  top: calc(10px + env(safe-area-inset-top) + 3px) !important;
  right: 10px !important;
  height: 64px !important;
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  padding: 0 !important;
}
.auth-bar .auth-user{
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--top-pill) !important;
  border: 1px solid var(--top-pill-border) !important;
  color: var(--top-text) !important;
  font-weight: 900 !important;
  max-width: 32vw;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.auth-bar .auth-actions{
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;
}
#btnLogout, #btnAdmin{
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  opacity: 1 !important;
  visibility: visible !important;
  padding: 10px 14px !important;
  border-radius: 999px !important;
  background: var(--top-pill) !important;
  border: 1px solid var(--top-pill-border) !important;
  color: var(--top-text) !important;
  font-weight: 900 !important;
}

/* Make sure menu icon visible */
.menu-btn .menu-icon{ font-size: 1.35em !important; line-height: 1 !important; }

/* Mobile: make everything bigger and keep aligned */
@media (max-width: 820px){
  #sideBarBg{
    left: 8px;
    right: 8px;
    height: 76px;
    border-radius: 24px;
  }
  .menu-btn{
    width: 70px !important;
    height: 70px !important;
    border-radius: 22px !important;
    font-size: 34px !important;
    top: calc(10px + env(safe-area-inset-top) + 3px) !important;
    left: 10px !important;
  }
  #hud{
    height: 76px !important;
    /* reserve space so HUD não encoste no menu nem no login */
    left: 92px !important;   /* 8px bar + 70px btn + ~14px gap */
    right: 260px !important; /* espaço para user + botões */
    transform: none !important;
    justify-content: center !important;
  }
  #hud > span{
    padding: 14px 16px !important;
    font-size: 18px !important;
  }
  #hud > span b{ font-size: 1.25em !important; }
  .auth-bar{
    height: 76px !important;
    right: 10px !important;
  }
  .auth-bar .auth-user{
    padding: 14px 16px !important;
    font-size: 17px !important;
  }
  #btnLogout, #btnAdmin{
    padding: 14px 16px !important;
    font-size: 16px !important;
  }

  /* Push Leaflet controls down so they don't collide */
  .leaflet-top{ top: calc(92px + env(safe-area-inset-top)) !important; }
}

@media (max-width: 420px){
  #sideBarBg{ height: 132px; }
  #hud{
    left: 8px !important; right: 8px !important; transform: none !important;
    top: calc(86px + env(safe-area-inset-top)) !important;
    height: auto !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
    left: 8px !important;
    right: 8px !important;
    transform: none !important;
    gap: 10px !important;
  }
  #hud > span{ width: 100% !important; justify-content: space-between !important; }
  /* Leaflet controls lower */
  .leaflet-top{ top: calc(150px + env(safe-area-inset-top)) !important; }
}

/* Drawer always above everything */
.drawer-overlay{ z-index: 30000 !important; }
.drawer{ z-index: 30500 !important; }

/* Best-effort: hide Apps Script info bar (may not work if Google changes markup) */
body > div[role="banner"]{ display:none !important; }


/* Sidebar auth buttons full width */
.auth-bar .btn{
  width: 100% !important;
  justify-content: center !important;
}
@media (max-width: 820px){
  .leaflet-control-container .leaflet-top.leaflet-left{
    left: calc(var(--side-w) + 16px) !important;
    top: calc(10px + env(safe-area-inset-top)) !important;
  }
}


/* =========================================================
   FINAL OVERRIDE: Sidebar left (menu top, user bottom) + HUD only on top
   (iOS-safe: overrides any earlier mobile header rules)
   ========================================================= */
@media (max-width: 9999px){
  :root{ --side-w: 140px; }

  /* Sidebar background */
  #sideBarBg{
    position: fixed !important;
    left: 10px !important;
    top: calc(10px + env(safe-area-inset-top)) !important;
    bottom: calc(10px + env(safe-area-inset-bottom)) !important;
    width: var(--side-w) !important;
    height: auto !important;
    z-index: 20000 !important;
    border-radius: 22px !important;
    background: var(--top-bg) !important;
    border: 1px solid var(--top-border) !important;
    box-shadow: 0 18px 40px rgba(0,0,0,0.30) !important;
    pointer-events: none !important;
    -webkit-backdrop-filter: blur(12px) !important;
    backdrop-filter: blur(12px) !important;
  }

  /* Menu stays on top-left inside sidebar */
  .menu-btn{
    position: fixed !important;
    left: 18px !important;
    top: calc(18px + env(safe-area-inset-top)) !important;
    right: auto !important;
    bottom: auto !important;
    z-index: 26000 !important;
    background: var(--top-pill) !important;
    border-color: var(--top-pill-border) !important;
    color: var(--top-text) !important;
  }

  /* Auth/user block anchored to bottom-left inside sidebar */
  .auth-bar{
    position: fixed !important;
    left: 18px !important;
    right: auto !important;
    top: auto !important;
    bottom: calc(18px + env(safe-area-inset-bottom)) !important;
    width: calc(var(--side-w) - 16px) !important;
    height: auto !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 10px !important;
    padding: 12px !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    z-index: 25500 !important;
  }
  .auth-bar .auth-user{
    width: 100% !important;
    max-width: 100% !important;
    justify-content: center !important;
  }
  .auth-bar .auth-actions{
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
  }
  #btnLogout, #btnAdmin{
    width: 100% !important;
    justify-content: center !important;
  }

  /* HUD stays at top, centered in remaining area (to the right of sidebar) */
  #hud{
    position: fixed !important;
    top: calc(10px + env(safe-area-inset-top)) !important;
    left: calc(50% + (var(--side-w) / 2)) !important;
    right: auto !important;
    transform: translateX(-50%) !important;
    max-width: calc(100vw - 20px - var(--side-w)) !important;
    z-index: 25500 !important;
    background: var(--top-bg) !important;
    border: 1px solid var(--top-border) !important;
    box-shadow: 0 18px 40px rgba(0,0,0,0.30) !important;
    pointer-events: none !important;
    -webkit-backdrop-filter: blur(12px) !important;
    backdrop-filter: blur(12px) !important;
  }

  /* Leaflet controls move to the right of sidebar */
  .leaflet-control-container .leaflet-top.leaflet-left{
    left: calc(var(--side-w) + 16px) !important;
    top: calc(10px + env(safe-area-inset-top)) !important;
  }
}

/* Mobile sizing tweaks */
@media (max-width: 820px){
  :root{ --side-w: 150px; }
  .menu-btn{ width: 70px !important; height: 70px !important; border-radius: 22px !important; }
  #hud{ padding: 12px 14px !important; }
  #hud > span{ padding: 14px 16px !important; font-size: 18px !important; }
  #hud > span b{ font-size: 1.25em !important; }
  .auth-bar{ padding: 12px !important; }
  .auth-bar .auth-user{ padding: 14px 14px !important; font-size: 17px !important; }
  #btnLogout, #btnAdmin{ padding: 14px 14px !important; font-size: 16px !important; }
}

@media (max-width: 420px){
  :root{ --side-w: 150px; }
  #hud{
    left: calc(var(--side-w) + 18px) !important;
    right: 10px !important;
    transform: none !important;
    justify-content: flex-start !important;
  }
  #hud > span{ width: 100% !important; justify-content: space-between !important; }
}


/* =========================
   V10: Remove lateral strip; keep only hamburger.
   Move auth/user inside drawer footer (bottom).
   ========================= */
:root{ --side-w: 0px !important; }

/* Remove any leftover sidebar background spacing */
#sideBarBg{ display:none !important; }

/* Keep only hamburger on the map */
.menu-btn{
  position: fixed !important;
  left: 12px !important;
  top: calc(12px + env(safe-area-inset-top)) !important;
  z-index: 26000 !important;
}

/* HUD stays alone on top (center) */
#hud{
  position: fixed !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  top: calc(10px + env(safe-area-inset-top)) !important;
  z-index: 25500 !important;
  max-width: calc(100vw - 20px) !important;
}

/* Leaflet zoom back to normal left */
@media (max-width: 820px){
  .leaflet-control-container .leaflet-top.leaflet-left{
    left: 10px !important;
    top: calc(86px + env(safe-area-inset-top)) !important; /* below HUD */
  }
}

/* Hide auth bar on map; it will be moved into drawer */
.auth-bar:not(.in-drawer){
  display: none !important;
}

/* Drawer footer (fixed bottom, outside scroll) */
.drawer{
  display: flex !important;
  flex-direction: column !important;
}
#drawerContent{
  flex: 1 1 auto !important;
  overflow: auto !important;
  -webkit-overflow-scrolling: touch;
}
#drawerFooter,
.drawer-footer{
  flex: 0 0 auto !important;
  padding: 12px !important;
  border-top: 1px solid rgba(255,255,255,0.10) !important;
  background: rgba(11,18,32,0.96) !important;
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}
/* Auth bar styles inside drawer */
.auth-bar.auth-in-drawer{
  position: static !important;
  inset: auto !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 10px !important;
}
.auth-bar.auth-in-drawer .btn{
  width: 100% !important;
  justify-content: center !important;
}


/* ===== V9: Admin modal theme (verde + preto) + layout responsivo ===== */
:root{
  --admin-bg: rgba(11,18,32,0.96);
  --admin-card: rgba(255,255,255,0.06);
  --admin-stroke: rgba(255,255,255,0.12);
  --admin-text: rgba(255,255,255,0.92);
  --admin-muted: rgba(255,255,255,0.72);
  --admin-green: #22c55e;
  --admin-green2:#16a34a;
}

.admin-backdrop{
  background: rgba(0,0,0,0.58) !important;
  padding: 12px !important;
}

.admin-modal{
  width: min(980px, 96vw) !important;
  max-height: min(88vh, 88dvh) !important;
  background: var(--admin-bg) !important;
  color: var(--admin-text) !important;
  border: 1px solid var(--admin-stroke) !important;
  border-radius: 18px !important;
  box-shadow: 0 24px 70px rgba(0,0,0,0.45) !important;
}

.admin-head{
  background: rgba(255,255,255,0.04) !important;
  border-bottom: 1px solid var(--admin-stroke) !important;
}

.admin-title, .admin-head *{
  color: var(--admin-text) !important;
}

.admin-body{
  padding: 12px 14px !important;
  overflow: auto !important;
}

.admin-hint{
  color: var(--admin-muted) !important;
}

.admin-tabs{
  gap: 10px !important;
}

.tab-btn{
  background: rgba(255,255,255,0.06) !important;
  color: var(--admin-text) !important;
  border: 1px solid var(--admin-stroke) !important;
  border-radius: 12px !important;
  padding: 10px 12px !important;
  font-weight: 800 !important;
}

.tab-btn.active{
  border-color: rgba(34,197,94,0.55) !important;
  box-shadow: 0 0 0 4px rgba(34,197,94,0.15) !important;
  background: linear-gradient(135deg, rgba(34,197,94,0.18), rgba(22,163,74,0.08)) !important;
}

.admin-grid{
  grid-template-columns: 1fr 1fr !important;
  gap: 12px !important;
}

.admin-grid .panel, .admin-body .panel{
  background: rgba(255,255,255,0.05) !important;
  border: 1px solid var(--admin-stroke) !important;
  border-radius: 16px !important;
  box-shadow: none !important;
}

.admin-body label, .admin-body .label{
  color: var(--admin-muted) !important;
  font-weight: 800 !important;
}

.admin-body input, .admin-body select, .admin-body textarea{
  background: rgba(255,255,255,0.06) !important;
  color: var(--admin-text) !important;
  border: 1px solid rgba(255,255,255,0.16) !important;
}

.admin-body input::placeholder, .admin-body textarea::placeholder{
  color: rgba(255,255,255,0.45) !important;
}

.admin-actions .btn, .admin-body .btn{
  background: rgba(255,255,255,0.06) !important;
  color: var(--admin-text) !important;
  border: 1px solid var(--admin-stroke) !important;
  border-radius: 14px !important;
  padding: 10px 12px !important;
  font-weight: 900 !important;
}

.admin-body .btn-primary{
  border-color: rgba(34,197,94,0.70) !important;
  color: #eafff2 !important;
  background: linear-gradient(135deg, rgba(34,197,94,0.20), rgba(22,163,74,0.10)) !important;
}

.admin-body .btn-danger{
  border-color: rgba(255,80,80,0.65) !important;
  color: rgba(255,235,235,0.95) !important;
  background: rgba(255,80,80,0.10) !important;
}

.admin-body .btn-success{
  border-color: rgba(34,197,94,0.70) !important;
  background: linear-gradient(135deg, rgba(34,197,94,0.22), rgba(22,163,74,0.10)) !important;
}

.admin-body .table{
  color: var(--admin-text) !important;
}
.admin-body .table th, .admin-body .table td{
  border-bottom: 1px solid rgba(255,255,255,0.10) !important;
}
.admin-body .pill{
  border: 1px solid rgba(255,255,255,0.16) !important;
  color: var(--admin-text) !important;
  background: rgba(255,255,255,0.06) !important;
}
.admin-body .pill.on{ background: rgba(34,197,94,0.14) !important; }
.admin-body .pill.off{ background: rgba(255,80,80,0.12) !important; }

/* Rotas Admin: garante visibilidade e rolagem */
#rotasAdminPanel{
  width: 100% !important;
  max-width: none !important;
}
#rotasAdminPanel textarea{
  min-height: 160px !important;
}
#rotasAdminPanel .admin-actions{
  position: sticky;
  bottom: 0;
  background: rgba(11,18,32,0.92);
  padding-top: 10px;
  margin-top: 10px;
}

/* Mobile: 1 coluna, tudo visível */
@media (max-width: 820px){
  .admin-modal{ width: 96vw !important; }
  .admin-grid{ grid-template-columns: 1fr !important; }
  .tab-btn{ flex: 1 1 auto; }
}


/* ===== V10: Rotas tab sizing + select visibility ===== */

/* Modal layout: head fixed, body scrollable */
.admin-modal{
  display:flex !important;
  flex-direction: column !important;
}
.admin-body{
  flex: 1 1 auto !important;
  min-height: 0 !important; /* enables internal scroll */
}

/* Keep tabs/header visible while scrolling content */
.admin-head{
  position: sticky !important;
  top: 0 !important;
  z-index: 10 !important;
}

/* Rotas tab: constrain height and allow scroll */
#rotasAdminPanel{
  max-height: calc(88vh - 190px) !important; /* modal max minus head/tabs */
  overflow: auto !important;
  padding-bottom: 12px !important;
}

/* Ensure the routes card doesn't spill out */
#rotasAdminPanel .panel{
  width: 100% !important;
  max-width: none !important;
}

/* Select: force readable light styling (options visible without hover) */
#rotasAdminPanel select,
#rotasAdminPanel .admin-body select{
  background: #ffffff !important;
  color: #111111 !important;
  border: 1px solid rgba(0,0,0,0.20) !important;
}
#rotasAdminPanel option{
  color: #111111 !important;
  background: #ffffff !important;
}

/* Buttons row: wrap nicely and don't overflow */
#rotasAdminPanel .admin-actions{
  position: sticky;
  bottom: 0;
  display:flex;
  gap:10px;
  flex-wrap: wrap;
}
#rotasAdminPanel .admin-actions .btn{
  flex: 1 1 160px;
}

/* Mobile: tighter max-height */
@media (max-width: 820px){
  #rotasAdminPanel{
    max-height: calc(88vh - 210px) !important;
  }
}


/* ===== V11: Centered & compact Admin modal for Rotas ===== */

/* Center modal perfectly */
.admin-backdrop{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
}

/* Compact and centered modal */
.admin-modal{
  margin: 0 auto !important;
  width: min(760px, 94vw) !important;   /* reduced width */
  max-height: min(78vh, 78dvh) !important; /* slightly shorter */
}

/* Make header smaller */
.admin-head{
  padding: 12px 16px !important;
}

/* Tabs row more compact */
.admin-tabs{
  gap: 8px !important;
}
.tab-btn{
  padding: 8px 10px !important;
  font-size: 0.92rem !important;
}

/* Rotas tab: tighter vertical footprint */
#rotasAdminPanel{
  max-height: calc(78vh - 150px) !important;
  overflow:auto !important;
}

/* Buttons: smaller and aligned */
#rotasAdminPanel .admin-actions{
  gap:8px !important;
}
#rotasAdminPanel .admin-actions .btn{
  flex: 1 1 140px;
  padding: 8px 10px !important;
  font-size: 0.92rem !important;
}

/* Reduce select height */
#rotasAdminPanel select{
  height: 38px !important;
}

/* Reduce textarea footprint */
#rotasAdminPanel textarea{
  min-height: 130px !important;
  max-height: 220px !important;
}

/* Mobile fine tuning */
@media (max-width: 720px){
  .admin-modal{
    width: 96vw !important;
    max-height: 82vh !important;
  }
  #rotasAdminPanel{
    max-height: calc(82vh - 150px) !important;
  }
}


/* ===== V12: Admin modal close reliability ===== */
.admin-backdrop{ z-index: 99999 !important; }
.admin-modal{ position: relative !important; }
.admin-close{
  position: absolute !important;
  top: 12px !important;
  right: 12px !important;
  width: 44px !important;
  height: 44px !important;
  border-radius: 14px !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
  background: rgba(255,255,255,0.06) !important;
  cursor: pointer !important;
  z-index: 100000 !important;
  pointer-events: auto !important;
}
.admin-close::before{
  content: "×";
  display: grid;
  place-items: center;
  width: 100%;
  height: 100%;
  font-size: 26px;
  line-height: 1;
  color: rgba(255,255,255,0.92);
  font-weight: 900;
}
.admin-close:active{
  transform: translateY(1px);
}


/* ===== V13: prevent admin overlay from blocking map ===== */
.admin-backdrop[aria-hidden="true"]{
  display:none !important;
  pointer-events:none !important;
}
.admin-backdrop.hidden{
  display:none !important;
  pointer-events:none !important;
}


/* ===== V14: enable smooth scroll inside Rotas tab ===== */
#rotasAdminPanel{
  overflow: auto !important;
  -webkit-overflow-scrolling: touch;
}
.admin-modal{
  overflow: hidden !important; /* keep scroll only inside body/panel */
}
.admin-body{
  overflow: auto !important;
}


/* ===== V15: Rotas scroll + Admin reopen ===== */
.admin-body{
  overflow:auto !important;
  max-height: calc(78vh - 120px) !important;
  overscroll-behavior: contain;
}
#rotasAdminPanel{
  max-height: calc(78vh - 170px) !important;
  overflow:auto !important;
  overscroll-behavior: contain;
  touch-action: pan-y;
}
#rotasAdminPanel *{
  touch-action: pan-y;
}


/* ===== V18: Rotas tab shows correctly inside Admin modal ===== */
.admin-modal .panel{
  position: static !important;
  z-index: auto !important;
  min-width: 0 !important;
  max-width: 100% !important;
  width: 100% !important;
  margin: 0 !important;
}
.admin-modal .panel.legend-right{ min-width:0 !important; max-width:100% !important; }
#rotasAdminPanel{ position: static !important; }
#adminRotasHost{ width:100% !important; }

</style>
<style id="mobile-fixes-v12">
/* ===== v12: fix user overflow + solid hamburger button ===== */
:root{
  --panel-bg: rgba(11,18,32,0.92);
  --panel-border: rgba(255,255,255,0.14);
  --panel-text: rgba(255,255,255,0.95);
}

.menu-btn{
  background: var(--panel-bg) !important;
  border: 1px solid var(--panel-border) !important;
  color: var(--panel-text) !important;
  opacity: 1 !important;
  box-shadow: 0 16px 34px rgba(0,0,0,0.35) !important;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
.menu-btn:active{ transform: translateY(1px); }

@media (max-width: 820px){
  .menu-btn{
    width: 66px !important;
    height: 66px !important;
    font-size: 32px !important;
    border-radius: 18px !important;
  }
}

/* Drawer footer: keep USER same width as Admin/Sair and prevent overflow */
#drawerFooter{ padding: 12px !important; }
#drawerFooter .auth-bar{
  width: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 10px !important;
  align-items: stretch !important;
}
#drawerFooter .auth-user{
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;

  display: flex !important;
  align-items: center !important;
  justify-content: center !important;

  padding: 14px 14px !important;
  border-radius: 18px !important;
  background: rgba(255,255,255,0.08) !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  color: var(--panel-text) !important;

  overflow: hidden !important;
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
  min-width: 0 !important;
}
#drawerFooter .auth-user *{
  min-width: 0 !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

#drawerFooter .auth-bar .btn{
  width: 100% !important;
  box-sizing: border-box !important;
  padding: 16px 14px !important;
  border-radius: 18px !important;
  font-size: 16px !important;
  font-weight: 900 !important;
  background: rgba(255,255,255,0.10) !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  color: var(--panel-text) !important;
}

/* =========================
   PATCH v13: Drawer on RIGHT + Locate button on LEFT
   ========================= */
.menu-btn{
  left: auto !important;
  right: 10px !important;
}

.drawer{
  left: auto !important;
  right: 0 !important;
  border-right: none !important;
  border-left: 1px solid rgba(255,255,255,0.10) !important;
  box-shadow: -18px 0 40px rgba(0,0,0,0.35) !important;
  transform: translateX(102%) !important;
}
.drawer.open{ transform: translateX(0) !important; }

/* Close button spacing stays OK on right */
#drawerClose{
  right: 14px !important;
  left: auto !important;
}

/* HUD: keep centered, but leave space for the right menu button */
#hud{
  max-width: calc(100vw - 120px) !important;
}

/* Floating locate button to LEFT */
.fab, .loc-btn{
  right: auto !important;
  left: 14px !important;
}

/* If there is a Leaflet control created for locate with inline right, force it left */
.leaflet-control .fab,
.leaflet-bottom .fab{
  right: auto !important;
  left: 14px !important;
}

/* Leaflet zoom/layers were pushed for left drawer previously; reset for right drawer */
.leaflet-top.leaflet-left{
  margin-left: 0 !important;
}
.leaflet-top.leaflet-right{
  margin-right: 0 !important;
}

</style>

<style id="responsive-presets">
/* =========================================================
   Presets de layout (zoom 100%)
   - 390x844 (iPhone)
   - 412x915 (Android)
   - 600x680 (referência)
   - 768x1024 (tablet)
   ========================================================= */

:root{
  /* default (tuned ~600px) */
  --hud-top: 14px;
  --hud-maxw: 420px;
  --hud-pad-y: 10px;
  --hud-pad-x: 12px;

  --hamb-size: 56px;
  --hamb-font: 28px;
  --hamb-top: 12px;
  --hamb-right: 12px;

  --loc-left: 14px;
  --loc-bottom: 18px;
}

/* HUD topo */
#hud{
  top: calc(var(--hud-top) + env(safe-area-inset-top)) !important;
  max-width: min(var(--hud-maxw), calc(100vw - 120px)) !important;
  padding: var(--hud-pad-y) var(--hud-pad-x) !important;
}

/* Hambúrguer (topo-direita) */
.menu-btn{
  position: fixed !important;
  top: calc(var(--hamb-top) + env(safe-area-inset-top)) !important;
  right: var(--hamb-right) !important;
  left: auto !important;
  width: var(--hamb-size) !important;
  height: var(--hamb-size) !important;
  font-size: var(--hamb-font) !important;
  z-index: 6000 !important;
}

/* Botão localização (baixo-esquerda). Suporta ids/classes comuns */
#locBtn, #btnLocate, .loc-btn, .location-btn, .fab-locate{
  position: fixed !important;
  left: var(--loc-left) !important;
  right: auto !important;
  bottom: calc(var(--loc-bottom) + env(safe-area-inset-bottom)) !important;
  z-index: 5500 !important;
}

/* Leaflet zoom: não colidir com HUD/hamb */
.leaflet-top.leaflet-left{
  top: calc(78px + env(safe-area-inset-top)) !important;
  left: 10px !important;
}
.leaflet-top.leaflet-right{
  top: calc(78px + env(safe-area-inset-top)) !important;
  right: 10px !important;
}

/* Drawer abrindo pela direita (seu padrão atual) */
#drawer{
  left: auto !important;
  right: 0 !important;
}

/* ===== iPhone 390x844 ===== */
@media (max-width: 399px){
  :root{
    --hud-top: 12px;
    --hud-maxw: 320px;
    --hud-pad-y: 10px;
    --hud-pad-x: 10px;

    --hamb-size: 54px;
    --hamb-font: 28px;
    --hamb-top: 10px;
    --hamb-right: 10px;

    --loc-left: 12px;
    --loc-bottom: 16px;
  }
  #hud{ font-size: 15px !important; }
  #hud .hud-item{ padding: 10px 12px !important; }
  #hud .hud-value{ font-size: 1.15em !important; }
}

/* ===== Android 412x915 ===== */
@media (min-width: 400px) and (max-width: 479px){
  :root{
    --hud-top: 12px;
    --hud-maxw: 350px;

    --hamb-size: 56px;
    --hamb-font: 28px;

    --loc-left: 12px;
    --loc-bottom: 16px;
  }
  #hud{ font-size: 15px !important; }
}

/* ===== Referência 600x680 ===== */
@media (min-width: 560px) and (max-width: 699px){
  :root{
    --hud-top: 14px;
    --hud-maxw: 420px;

    --hamb-size: 58px;
    --hamb-font: 29px;

    --loc-left: 14px;
    --loc-bottom: 18px;
  }
  #hud{ font-size: 16px !important; }
}

/* ===== Tablet 768x1024 ===== */
@media (min-width: 700px){
  :root{
    --hud-top: 16px;
    --hud-maxw: 520px;
    --hud-pad-y: 12px;
    --hud-pad-x: 14px;

    --hamb-size: 60px;
    --hamb-font: 30px;
    --hamb-top: 14px;
    --hamb-right: 14px;

    --loc-left: 16px;
    --loc-bottom: 22px;
  }
  #hud{ font-size: 17px !important; }
  #hud .hud-item{ padding: 12px 14px !important; }
}
</style>

<style id="ui-scale-overrides">
/* ===== UI SCALE (controlled by slider in menu footer) ===== */
:root{ --ui-scale: 1; }

/* Scale HUD + overlay controls using calc(var * --ui-scale) so iOS works (no CSS zoom) */
#hud{
  padding: calc(var(--hud-pad-y, 10px) * var(--ui-scale)) calc(var(--hud-pad-x, 12px) * var(--ui-scale)) !important;
  border-radius: calc(18px * var(--ui-scale)) !important;
}
#hud .hud-item{
  padding: calc(10px * var(--ui-scale)) calc(14px * var(--ui-scale)) !important;
  border-radius: calc(999px * var(--ui-scale)) !important;
}
#hud .hud-ico{ font-size: calc(1.25em * var(--ui-scale)) !important; }
#hud .hud-label{ font-size: calc(1em * var(--ui-scale)) !important; }
#hud .hud-value{ font-size: calc(1.18em * var(--ui-scale)) !important; }

/* Hamburger */
.menu-btn{
  width: calc(var(--hamb-size, 56px) * var(--ui-scale)) !important;
  height: calc(var(--hamb-size, 56px) * var(--ui-scale)) !important;
  font-size: calc(var(--hamb-font, 28px) * var(--ui-scale)) !important;
  border-radius: calc(18px * var(--ui-scale)) !important;
}

/* Location button (fab) */
.fab, #locBtn, .loc-btn, #btnLocate, .location-btn, .fab-locate{
  width: calc(58px * var(--ui-scale)) !important;
  height: calc(58px * var(--ui-scale)) !important;
  border-radius: calc(22px * var(--ui-scale)) !important;
}

/* Drawer typography + buttons */
#drawer, #drawer *{
  font-size: calc(1em * var(--ui-scale));
}
#drawer .btn, #drawer button, #drawer input[type="range"]{
  font-size: calc(1em * var(--ui-scale)) !important;
}
#drawerFooter .auth-bar .btn,
#drawerFooter .auth-bar button{
  padding: calc(12px * var(--ui-scale)) calc(14px * var(--ui-scale)) !important;
  border-radius: calc(16px * var(--ui-scale)) !important;
}

/* Fixed slider block above user in the footer */
#uiScaleBox{
  margin-bottom: 10px;
  padding: 10px 10px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
}
#uiScaleBox .label{
  font-weight: 900;
}
#uiScaleBox input[type="range"]{
  width: 100%;
}

/* Hide the original slider location inside the Legend section after we move it */
#legendPanel .row.ui-scale-row{
  display:none !important;
}
</style>



<style id="login-ui-upgrade">
/* =========================================================
   LOGIN: maior + responsivo + tema verde/preto (igual painel)
   ========================================================= */
:root{
  --panel-bg: rgba(11,18,32,0.96);
  --panel-bg-2: rgba(11,18,32,0.88);
  --panel-border: rgba(255,255,255,0.12);
  --panel-text: rgba(255,255,255,0.92);
  --panel-muted: rgba(255,255,255,0.72);
  --accent-green: #22c55e;
  --accent-green-2: #16a34a;
}

/* fundo do login */
.login-backdrop{
  background: rgba(0,0,0,0.62) !important;
  padding: 18px !important;
}

/* card maior e com o mesmo visual do painel */
.login-card{
  width: min(92vw, 560px) !important;
  max-width: 560px !important;
  max-height: min(86vh, 640px) !important;
  background: var(--panel-bg) !important;
  color: var(--panel-text) !important;
  border: 1px solid var(--panel-border) !important;
  border-radius: 18px !important;
  box-shadow: 0 24px 60px rgba(0,0,0,0.45) !important;
  overflow: hidden !important;
  display: flex !important;
  flex-direction: column !important;
}

.login-card header{
  border-bottom: 1px solid rgba(255,255,255,0.10) !important;
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)) !important;
  padding: 16px 18px !important;
  font-weight: 900 !important;
  font-size: clamp(16px, 2.6vw, 20px) !important;
}

.login-card .body{
  padding: 16px 18px !important;
  overflow: auto !important;
}

.login-card .label{
  color: var(--panel-muted) !important;
  font-weight: 800 !important;
  font-size: clamp(13px, 2.2vw, 15px) !important;
}

.login-card input{
  width: 100% !important;
  background: rgba(255,255,255,0.06) !important;
  color: var(--panel-text) !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  border-radius: 12px !important;
  padding: 14px 14px !important;
  font-size: clamp(15px, 2.6vw, 18px) !important;
  outline: none !important;
}

.login-card input::placeholder{
  color: rgba(255,255,255,0.45) !important;
}

.login-small{
  color: rgba(255,255,255,0.70) !important;
  font-size: clamp(12px, 2.1vw, 14px) !important;
  margin-top: 8px !important;
}

.login-msg.err{
  background: rgba(239,68,68,0.12) !important;
  border: 1px solid rgba(239,68,68,0.28) !important;
  color: rgba(255,255,255,0.92) !important;
  border-radius: 12px !important;
  padding: 10px 12px !important;
}

/* rodapé e botão */
.login-card .footer{
  margin-top: auto !important;
  border-top: 1px solid rgba(255,255,255,0.10) !important;
  padding: 14px 18px !important;
  display: flex !important;
  justify-content: flex-end !important;
}

.login-card .btn.btn-primary{
  background: linear-gradient(180deg, var(--accent-green), var(--accent-green-2)) !important;
  border: 1px solid rgba(0,0,0,0.18) !important;
  color: #08120c !important;
  font-weight: 900 !important;
  border-radius: 14px !important;
  padding: 12px 18px !important;
  font-size: clamp(14px, 2.4vw, 16px) !important;
}

.login-card .btn.btn-primary:active{
  transform: translateY(1px);
}

/* Mobile: card ainda maior e com mais área de toque */
@media (max-width: 480px){
  /* Login quase em tela cheia no mobile */
  .login-backdrop{
    padding: 10px !important;
    align-items: stretch !important;
  }
  .login-card{
    width: calc(100vw - 20px) !important;
    max-width: calc(100vw - 20px) !important;
    height: calc(100vh - 20px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
    max-height: calc(100vh - 20px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
    border-radius: 18px !important;
  }
  .login-card header{
    padding: 18px 18px !important;
    font-size: 20px !important;
  }
  .login-card .body{
    padding: 18px 18px !important;
  }
  .login-card .label{
    font-size: 15px !important;
  }
  .login-card input{
    padding: 16px 16px !important;
    font-size: 18px !important;
    border-radius: 14px !important;
  }
  .login-small{
    font-size: 14px !important;
  }
  .login-card .footer{
    padding: 14px 18px !important;
    justify-content: stretch !important;
    gap: 12px !important;
  }
  /* Botão Entrar em largura total */
  .login-card .footer button,
  .login-card .footer .btn,
  .login-card .footer input[type="button"]{
    width: 100% !important;
    padding: 14px 16px !important;
    font-size: 16px !important;
    border-radius: 14px !important;
  }
}
/* Tablet: um pouco mais largo */
@media (min-width: 700px){
  .login-card{ width: min(520px, 70vw) !important; }
}
</style>


<style id="color-fixes">
/* Login eye icon -> white */
.login-card .toggle-password,
.login-card .eye,
.login-card .password-toggle{
  color: #ffffff !important;
  fill: #ffffff !important;
}

/* HUD scale (nome + porcentagem) -> white */
.hud-scale-label,
.hud-scale-name,
.hud-scale-percent,
.hud-scale-value{
  color: #ffffff !important;
}
</style>


<style id="hud-scale-fix">
:root{ --hud-scale: 1; }
/* Preserve existing translateX and apply scale */
#hud{
  transform: translateX(-50%) scale(var(--hud-scale));
  transform-origin: top center;
}
#dash{
  transform: scale(var(--hud-scale));
  transform-origin: top left;
}

/* ===== HUD Scale - force white label and percentage ===== */
.hud-scale-label,
#hudScaleLabel,
#panelHudScale .panel-section-title {
  color: #ffffff !important;
  font-weight: 600;
}

.hud-scale-value,
#hudScaleValue,
#panelHudScale .percent {
  color: #ffffff !important;
  font-weight: 600;
}


/* ===== FORCE white text for HUD Scale section (override all) ===== */
.panel .hud-scale,
.panel .hud-scale *,
#panelHudScale,
#panelHudScale * {
  color: #ffffff !important;
}


/* ===== HUD scale (moved text size row) - correct selectors ===== */
#uiScaleBox .label{
  color:#ffffff !important;
}
#uiScaleBox #textScaleValue{
  color:#ffffff !important;
}
/* in case row isn't moved for any reason */
#legend .row.ui-scale-row .label,
#legend .row.ui-scale-row #textScaleValue{
  color:#ffffff !important;
}


/* ===== v19 UI swap: legend RIGHT, hamburger LEFT, legend themed like drawer ===== */

/* Hamburger always on the left */
#menuBtn.menu-btn{
  left: 10px !important;
  right: auto !important;
}

/* Legend fixed on the right (never left) */
#legend{
  position: fixed !important;
  right: 16px !important;
  left: auto !important;
  top: calc(10px + env(safe-area-inset-top)) !important;
  bottom: auto !important;
  z-index: 26000 !important;
}

/* Legend visual = same language as the drawer/panel theme */
#legend.panel{
  border-radius: 18px !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  background: rgba(11,18,32,0.86) !important;
  color: rgba(255,255,255,0.92) !important;
  box-shadow: 0 18px 40px rgba(0,0,0,0.28) !important;
  backdrop-filter: blur(10px) !important;
  -webkit-backdrop-filter: blur(10px) !important;
}

#legend.panel .panel-header{
  border-bottom: 1px solid rgba(255,255,255,0.08) !important;
  color: rgba(255,255,255,0.92) !important;
}

#legend .label,
#legend b,
#legend details summary,
#legend .hint,
#legend .muted{
  color: rgba(255,255,255,0.88) !important;
}

#legend input,
#legend select{
  border: 1px solid rgba(255,255,255,0.12) !important;
  background: rgba(255,255,255,0.06) !important;
  color: rgba(255,255,255,0.92) !important;
}

#legend input::placeholder{
  color: rgba(255,255,255,0.45) !important;
}

/* Buttons inside legend */
#legend button,
#legend .icon-btn{
  border: 1px solid rgba(255,255,255,0.12) !important;
  background: rgba(255,255,255,0.06) !important;
  color: rgba(255,255,255,0.92) !important;
}

#legend button:hover,
#legend .icon-btn:hover{
  background: rgba(255,255,255,0.10) !important;
}

/* Ensure minimized state still looks good on dark */
#legend.minimized{
  background: rgba(11,18,32,0.86) !important;
}


/* ===== Legend: FEEDER style -> black with thin white border ===== */
#legend .feeder,
#legend .legend-feeder,
#legend .route-feeder {
  background: #000000 !important;
  border: 1px solid rgba(255,255,255,0.9) !important;
  color: #ffffff !important;
}

/* if feeder uses line swatch */
#legend .swatch.feeder,
#legend .swatch-feeder {
  background: #000000 !important;
  border: 1px solid rgba(255,255,255,0.9) !important;
}


/* ===== Drawer position: force LEFT (hamburger opens panel on left) ===== */
.drawer, #drawer{
  left: 0 !important;
  right: auto !important;
  border-right: 1px solid rgba(255,255,255,0.10) !important;
  border-left: none !important;
  box-shadow: 18px 0 40px rgba(0,0,0,0.35) !important;
  transform: translateX(-102%) !important; /* closed off-canvas to the left */
}
.drawer.open, #drawer.open{
  transform: translateX(0) !important;
}


/* ===== CTO popup: theme like drawer/panel (dark glass) ===== */
.maplibregl-popup{
  z-index: 28000 !important;
}
.maplibregl-popup-content{
  background: rgba(11,18,32,0.92) !important;
  color: rgba(255,255,255,0.92) !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  border-radius: 18px !important;
  box-shadow: 0 18px 40px rgba(0,0,0,0.35) !important;
  backdrop-filter: blur(10px) !important;
  -webkit-backdrop-filter: blur(10px) !important;
  padding: 14px 14px 12px !important;
}

/* close button */
.maplibregl-popup-close-button{
  color: rgba(255,255,255,0.92) !important;
  font-size: 18px !important;
  padding: 10px 12px !important;
  border-radius: 14px !important;
}
.maplibregl-popup-close-button:hover{
  background: rgba(255,255,255,0.08) !important;
}

/* popup tip arrow */
.maplibregl-popup-tip{
  border-top-color: rgba(11,18,32,0.92) !important;
  border-bottom-color: rgba(11,18,32,0.92) !important;
}

/* inner text hierarchy */
.maplibregl-popup-content b,
.maplibregl-popup-content strong{
  color: rgba(255,255,255,0.95) !important;
}
.maplibregl-popup-content small,
.maplibregl-popup-content .muted,
.maplibregl-popup-content .sub{
  color: rgba(255,255,255,0.70) !important;
}

/* buttons inside popup */
.maplibregl-popup-content button{
  border-radius: 14px !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  background: rgba(255,255,255,0.06) !important;
  color: rgba(255,255,255,0.92) !important;
  font-weight: 800 !important;
}
.maplibregl-popup-content button:hover{
  background: rgba(255,255,255,0.10) !important;
}

/* keep your add/remove semantic borders if any inline styles exist */
.maplibregl-popup-content button.btn-add,
.maplibregl-popup-content button.add{
  border-color: rgba(59,130,246,0.55) !important;
}
.maplibregl-popup-content button.btn-remove,
.maplibregl-popup-content button.remove{
  border-color: rgba(239,68,68,0.55) !important;
}

/* inputs (if present in future) */
.maplibregl-popup-content input,
.maplibregl-popup-content select,
.maplibregl-popup-content textarea{
  border: 1px solid rgba(255,255,255,0.12) !important;
  background: rgba(255,255,255,0.06) !important;
  color: rgba(255,255,255,0.92) !important;
}


/* ===== CTO popup action buttons: color semantic ===== */
.maplibregl-popup-content button:first-of-type{
  background: rgba(34,197,94,0.20) !important;   /* green */
  border: 1px solid rgba(34,197,94,0.55) !important;
  color: #dcfce7 !important;
}
.maplibregl-popup-content button:first-of-type:hover{
  background: rgba(34,197,94,0.30) !important;
}

.maplibregl-popup-content button:last-of-type{
  background: rgba(239,68,68,0.18) !important;   /* red */
  border: 1px solid rgba(239,68,68,0.55) !important;
  color: #fee2e2 !important;
}
.maplibregl-popup-content button:last-of-type:hover{
  background: rgba(239,68,68,0.28) !important;
}


/* ===== Fix: keep popup close button neutral (not red) ===== */
.maplibregl-popup-close-button{
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  color: rgba(255,255,255,0.92) !important;
}
.maplibregl-popup-close-button:hover{
  background: rgba(255,255,255,0.10) !important;
}


/* ===== Fix (high-specificity): close button must NOT inherit add/remove colors ===== */
.maplibregl-popup-content > button.maplibregl-popup-close-button{
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  color: rgba(255,255,255,0.92) !important;
}
.maplibregl-popup-content > button.maplibregl-popup-close-button:hover{
  background: rgba(255,255,255,0.10) !important;
}

/* Also neutralize any positional selector hit */
.maplibregl-popup-content > button.maplibregl-popup-close-button:first-of-type,
.maplibregl-popup-content > button.maplibregl-popup-close-button:last-of-type{
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
  color: rgba(255,255,255,0.92) !important;
}


/* ===== Force password change modal: real full-screen overlay (avoid stray text on map) ===== */
#passBackdrop.backdrop{
  position: fixed !important;
  inset: 0 !important;
  z-index: 40000 !important;
  display: none; /* JS toggles to flex */
  align-items: center !important;
  justify-content: center !important;
  padding: 18px !important;
  background: rgba(0,0,0,0.55) !important;
  backdrop-filter: blur(6px) !important;
  -webkit-backdrop-filter: blur(6px) !important;
}
#passBackdrop.backdrop[style*="display:block"]{ display:flex !important; }
#passBackdrop .modal{
  margin: 0 !important;
  background: rgba(11,18,32,0.96) !important;
  color: rgba(255,255,255,0.92) !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  border-radius: 18px !important;
  box-shadow: 0 22px 55px rgba(0,0,0,0.45) !important;
}


/* ===== FIX: legenda abaixo do HUD (desktop + mobile) ===== */
#legend{
  top: calc(130px + env(safe-area-inset-top)) !important;
  bottom: auto !important;
}

/* No seu CSS existe um modo "bottom sheet" no mobile que coloca a legenda no rodapé.
   Isso força a legenda a ficar no topo (abaixo do HUD) também no mobile. */
@media (max-width: 768px){
  #legend,
  #legend.panel.legend-right{
    top: calc(130px + env(safe-area-inset-top)) !important;
    bottom: auto !important;
    left: 12px !important;
    right: auto !important;
    width: min(300px, 88vw) !important;
    max-height: 42vh !important;
    overflow: auto !important;
    transform: none !important; /* desativa "deslizar pra baixo" quando minimizada */
  }
}


/* ===== TESTE: legenda no canto inferior esquerdo ===== */
#legend{
  top: auto !important;
  bottom: calc(12px + env(safe-area-inset-bottom)) !important;
  left: 12px !important;
  right: auto !important;
}

/* Garantir o mesmo comportamento no mobile (sem virar bottom sheet centralizado) */
@media (max-width: 768px){
  #legend,
  #legend.panel.legend-right{
    top: auto !important;
    bottom: calc(12px + env(safe-area-inset-bottom)) !important;
    left: 12px !important;
    right: auto !important;
    width: min(300px, 88vw) !important;
    max-height: 42vh !important;
    overflow: auto !important;
    transform: none !important;
  }
}



/* Legend header: minimize button on the left */
#legend .panel-header{
  gap: 10px;
  justify-content: flex-start;
}
#legend .legend-title{
  font-weight: 900;
  flex: 1 1 auto;
}
#legend .icon-btn{
  flex: 0 0 auto;
}

</style>

</head>
<body>
<!-- Unified Side Header Background (mobile-friendly) -->

<!-- HAMBURGER MENU (drawer) -->
<button aria-controls="drawer" aria-expanded="false" aria-label="Abrir menu" class="menu-btn" id="menuBtn">
<span class="menu-icon">☰</span>
</button>
<div aria-hidden="true" class="drawer-overlay" id="drawerOverlay" tabindex="-1"></div>
<aside aria-label="Menu" class="drawer" id="drawer">
<div class="drawer-header">
<div class="drawer-title">
<span class="drawer-dot"></span>
<span>Painel</span>
</div>
<button aria-label="Fechar menu" class="drawer-close" id="drawerClose">✕</button>
</div>
<div class="drawer-content" id="drawerContent"></div>
<div class="drawer-footer" id="drawerFooter"></div>
</aside>
<div aria-hidden="true" class="login-backdrop" id="loginBackdrop">
<div aria-labelledby="loginTitle" aria-modal="true" class="login-card" role="dialog">
<header>
<div id="loginTitle">🔐 Login - Mapa FTTH</div>
</header>
<div class="body">
<div class="row">
<label class="label">Usuário</label>
<input autocomplete="username" id="loginUser" placeholder="ex: ryan" type="text"/>
</div>
<div class="row">
<label class="label">Senha</label>
<input autocomplete="current-password" id="loginPass" placeholder="••••••••" type="password"/>
</div>
<div class="login-small">Use suas credenciais fornecidas pelo administrador.</div>
<div class="login-msg err" id="loginMsg"></div>
</div>
<div class="footer">
<button class="btn btn-primary" id="btnLogin" type="button">Entrar</button>
</div>
</div>
</div>
<!-- Admin (Gestão de Usuários) -->
<div aria-hidden="true" class="admin-backdrop" id="adminBackdrop">
<div aria-label="Admin - Usuários" aria-modal="true" class="admin-modal" role="dialog">
<div class="admin-head">
<div>
<div class="admin-title">Admin • Gestão de Usuários</div>
<div class="admin-hint">Crie usuários, ative/desative e troque senhas sem editar a planilha.</div>
</div>
<button aria-label="Fechar" class="drawer-close" id="btnAdminClose" type="button">×</button>
</div>
<div class="admin-body">
<div class="admin-tabs">
<button class="tab-btn active" data-tab="list" id="tabListBtn" type="button">Lista</button>
<button class="tab-btn" data-tab="edit" id="tabEditBtn" type="button">Criar/Editar</button>
<button class="tab-btn" data-tab="pass" id="tabPassBtn" type="button">Trocar senha</button>
<button class="tab-btn" data-tab="rotas" id="tabRotasBtn" type="button">Rotas</button>
</div>
<div class="admin-tab" id="adminTabList">
<div class="admin-actions">
<button class="btn btn-secondary btn-small" id="btnUsersRefresh" type="button">Atualizar</button>
</div>
<div style="overflow:auto; margin-top:10px">
<table aria-label="Usuários" class="table">
<thead>
<tr>
<th>Usuário</th>
<th>Role</th>
<th>Status</th>
<th>Criado</th>
<th style="width:220px">Ações</th>
</tr>
</thead>
<tbody id="usersTbody"></tbody>
</table>
</div>
<div class="admin-hint" id="usersMsg"></div>
</div>
<div class="admin-tab" id="adminTabEdit" style="display:none">
<div class="admin-grid">
<div class="row">
<label class="label">Usuário</label>
<input id="editUser" placeholder="ex: tecnico1" type="text"/>
</div>
<div class="row">
<label class="label">Role</label>
<select id="editRole">
<option value="USER">USER</option>
<option value="ADMIN">ADMIN</option>
</select>
</div>
<div class="row">
<label class="label">Ativo</label>
<select id="editActive">
<option value="TRUE">TRUE</option>
<option value="FALSE">FALSE</option>
</select>
</div>
<div class="row">
<label class="label">Senha (opcional para editar)</label>
<input id="editPass" placeholder="defina para criar ou para trocar ao editar" type="password"/>
</div>
</div>
<div class="admin-actions">
<button class="btn btn-primary btn-small" id="btnUserSave" type="button">Salvar</button>
<button class="btn btn-secondary btn-small" id="btnUserClear" type="button">Limpar</button>
</div>
<div class="admin-hint" id="editMsg"></div>
</div>
<div class="admin-tab" id="adminTabPass" style="display:none">
<div class="admin-grid">
<div class="row">
<label class="label">Usuário</label>
<input id="passUser" placeholder="ex: tecnico1" type="text"/>
</div>
<div class="row">
<label class="label">Nova senha</label>
<input id="passNew" placeholder="••••••••" type="password"/>
</div>
</div>
<div class="admin-actions">
<button class="btn btn-primary btn-small" id="btnPassSave" type="button">Atualizar senha</button>
</div>
<div class="admin-hint" id="passMsg"></div>
</div>

<div class="admin-tab" id="adminTabRotas" style="display:none">
  <div class="admin-hint" style="margin-bottom:10px;">Gerencie rotas diretamente na aba <b>ROTAS_FIBRAS</b>. Apenas ADMIN.</div>
  <div id="adminRotasHost"></div>
</div>

</div>
</div>
</div>
<div id="errorBanner" style="display:none; position:fixed; inset:12px 12px auto 12px; z-index:99999; background:#b00020; color:#fff; padding:10px 12px; border-radius:10px; font-family:Arial,sans-serif; font-size:14px; box-shadow:0 6px 18px rgba(0,0,0,.25);">
<div style="font-weight:700; margin-bottom:6px;">Erro no mapa</div>
<div id="errorText" style="white-space:pre-wrap; line-height:1.25;"></div>
</div>
<div id="toast" style="display:none; position:absolute; bottom:16px; left:50%; transform:translateX(-50%); z-index:800; background:rgba(0,0,0,0.78); color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; max-width:90vw; text-align:center;"></div>
<!-- DASHBOARD MOBILE -->
<div aria-label="Dashboard" class="dash" id="dash" role="region">
<div class="dash-title">
<span class="dot"></span>
<span>Resumo</span>
</div>
<div class="dash-cards">
<div class="kpi">
<div class="kpi-label">CTOs totais</div>
<div class="kpi-value" id="kpiCtos">—</div>
</div>
<div class="kpi kpi-warn">
<div class="kpi-label">CTOs cheias</div>
<div class="kpi-value" id="kpiCtosCheias">—</div>
</div>
<div class="kpi">
<div class="kpi-label">Clientes ativos</div>
<div class="kpi-value" id="kpiClientes">—</div>
</div>
</div>
</div>
<div id="map"></div>
<!-- Auth Bar -->
<div class="auth-bar" id="authBar" style="display:none">
<div class="auth-user">👤 <b id="authUserLabel">—</b></div>
<div class="auth-actions">
<button class="btn btn-secondary btn-small" id="btnAdmin" style="display:none" type="button">Admin</button>
<button class="btn btn-danger btn-small" id="btnLogout" type="button">Sair</button>
</div>
</div>
<!-- Search / Network Bar -->
<div class="search-bar" id="searchBar" style="display:none">
<span class="net-badge" id="netBadge" title="Status de rede">—</span>
<input autocomplete="off" class="search-input" id="globalSearch" placeholder="Buscar CTO ou Caixa (ID)..." type="text"/>
<button class="btn btn-secondary btn-small" id="btnSearchGo" type="button">Ir</button>
<button class="btn btn-secondary btn-small" id="btnSearchClear" type="button">Limpar</button>
</div>
<!-- Force Password Change -->
<div aria-hidden="true" class="backdrop" id="passBackdrop" style="display:none">
<div class="modal" style="max-width:420px; width:92%; padding:16px;">
<div style="font-weight:800; margin-bottom:8px;">Troca de senha obrigatória</div>
<div style="opacity:.9; font-size:13px; margin-bottom:10px;">Por segurança, defina uma nova senha para continuar.</div>
<div class="form-row">
<label class="label">Nova senha</label>
<input autocomplete="new-password" id="forcePassNew" placeholder="mín. 10, maiúscula, minúscula e número" type="password"/>
</div>
<div class="form-row">
<label class="label">Confirmar nova senha</label>
<input autocomplete="new-password" id="forcePassNew2" placeholder="repita a nova senha" type="password"/>
</div>
<div class="login-msg err" id="forcePassMsg" style="display:block; margin-top:8px;"></div>
<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
<button class="btn btn-primary" id="btnForcePassSave" type="button">Salvar</button>
<button class="btn btn-danger" id="btnForcePassLogout" type="button">Sair</button>
</div>
</div>
</div>
<div aria-hidden="true" id="hud">
<span>📡 CTOs: <b id="hudCtos">—</b></span>
<span>🧰 Caixas: <b id="hudCaixas">—</b></span>
<span>🛣 Rotas: <b id="hudRotas">—</b></span>
</div>
<button aria-label="Abrir legenda" class="fab" id="fabLegend" type="button">☰</button>
<div aria-hidden="true" class="saving-overlay" id="savingOverlay">
<div class="saving-card">
<div class="saving-row">
<div aria-label="Carregando" class="spinner"></div>
<div>
<div class="saving-title" id="savingTitle">Salvando...</div>
<div class="saving-sub" id="savingSub">Aguarde um instante.</div>
</div>
</div>
</div>
</div>
<div class="panel legend-right" id="legend">
<div class="panel-header">
<button aria-label="Minimizar Legenda" class="icon-btn" id="legendMinBtn" onclick="toggleMinimize('legend')" type="button">—</button>
<div class="legend-title">Legenda</div>
</div>
<div class="row" style="margin-bottom:10px;">
<span class="label">Tamanho do texto</span>
<div style="display:flex; align-items:center; gap:10px;">
<input id="textScaleRange" max="200" min="100" step="5" type="range" value="150"/>
<span id="textScaleValue" style="min-width:48px; font-weight:800;">150%</span>
</div>
</div>
<div class="panel-body" id="legendBody">
<!-- preenchido dinamicamente -->
</div>
</div>
<script>

  // ===== Debug: mostrar erros na tela (útil no Apps Script) =====
  function showError(err){
    const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
    const banner = document.getElementById('errorBanner');
    const text = document.getElementById('errorText');
    if (text) text.textContent = msg;
    if (banner){
      banner.style.display = 'block';
      // Auto-hide after 60s (reset timer on new errors)
      clearTimeout(banner.__t);
      banner.__t = setTimeout(()=>{ banner.style.display='none'; }, 2000);
    }
  }



function showToast(msg){
  try{
    const el = document.getElementById('toast');
    if (!el){ alert(msg); return; }
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(el.__t);
    el.__t = setTimeout(()=>{ el.style.display='none'; }, 2500);
  } catch(_){ alert(msg); }
}

  window.addEventListener('error', (event) => {
    try {
      const msg = String(event && (event.message || (event.error && event.error.message) || 'Erro JS não identificado'));
      const filename = String((event && event.filename) || '');
      const targetSrc = String((event && event.target && event.target.src) || '');
      const src = filename || targetSrc;
      const loc = filename ? `
${filename}:${event.lineno||0}:${event.colno||0}` : '';

      // Ruído do iframe interno do Google Apps Script (OAuth / userCodeAppPanel)
      const isAppsScriptOAuth =
        src.includes('userCodeAppPanel') ||
        src.includes('script.googleusercontent.com');

      if (isAppsScriptOAuth && /createOAuthDialog|Failed to execute 'write' on 'Document'|Unexpected token '<'|Invalid or unexpected token/i.test(msg)) {
        return;
      }

      console.error('[window.error]', msg, loc, event.error);
      showError(msg + loc);
    } catch(_) {}
  });
  window.addEventListener('unhandledrejection', (e) => { try { showError(e.reason); } catch(_){} });


// ===== Auth helpers =====
const AUTH = { token: null, user: null, role: null, ready: false };

function getStoredToken(){
  try { return sessionStorage.getItem('ftth_token') || ''; } catch(_){ return ''; }
}
function setStoredToken(t){
  try { t ? sessionStorage.setItem('ftth_token', t) : sessionStorage.removeItem('ftth_token'); } catch(_){}
}



// ===== UI scale helpers =====
function getCssVarNumber_(name, fallback){
  try{
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if(!v) return fallback;
    const n = Number(String(v).replace(/[^0-9.+-]/g,''));
    return Number.isFinite(n) ? n : fallback;
  }catch(_){ return fallback; }
}

// Tamanho base da caixa (CE/CDO). No CSS original era ~20px.
function getCaixaSize(){
  const ui = getCssVarNumber_('--ui-scale', 1);
  // Em mobile campo, o CSS já aumenta ui-scale; aqui só aplicamos o scale.
  return Math.max(18, Math.round(20 * ui));
}

function updateNetworkBadge(){
  const b = document.getElementById('netBadge');
  if (!b) return;
  const online = navigator.onLine;
  b.textContent = online ? 'ONLINE' : 'OFFLINE';
  b.classList.toggle('online', online);
  b.classList.toggle('offline', !online);
}
window.addEventListener('online', updateNetworkBadge);
window.addEventListener('offline', updateNetworkBadge);

let __lastLoginPassword = '';

function showForcePasswordChange(){
  const bd = document.getElementById('passBackdrop');
  if (bd){ bd.style.display='flex'; bd.setAttribute('aria-hidden','false'); }
  const m = document.getElementById('forcePassMsg');
  if (m) m.textContent = '';
}
function hideForcePasswordChange(){
  const bd = document.getElementById('passBackdrop');
  if (bd){ bd.style.display='none'; bd.setAttribute('aria-hidden','true'); }
  const n1 = document.getElementById('forcePassNew'); const n2 = document.getElementById('forcePassNew2');
  if (n1) n1.value=''; if (n2) n2.value='';
}

function bindForcePasswordUI(){
  const save = document.getElementById('btnForcePassSave');
  if (save && !save.__bound){
    save.__bound = true;
    save.addEventListener('click', ()=>{
      const n1 = (document.getElementById('forcePassNew')?.value || '').trim();
      const n2 = (document.getElementById('forcePassNew2')?.value || '').trim();
      const m = document.getElementById('forcePassMsg');
      if (!n1 || !n2){ if (m) m.textContent='Preencha e confirme a nova senha.'; return; }
      if (n1 !== n2){ if (m) m.textContent='As senhas não conferem.'; return; }
      if (!__lastLoginPassword){ if (m) m.textContent='Sessão inválida. Faça login novamente.'; return; }
      if (m) m.textContent='Salvando...';
      callServer('changeMyPassword', [currentToken(), __lastLoginPassword, n1], ()=>{
        if (m) m.textContent='Senha atualizada.';
        __lastLoginPassword = '';
        hideForcePasswordChange();
      }, (err)=>{
        if (m) m.textContent = err?.message || 'Falha ao atualizar senha.';
      });
    });
  }
  const out = document.getElementById('btnForcePassLogout');
  if (out && !out.__bound){
    out.__bound = true;
    out.addEventListener('click', ()=> doLogout());
  }
}


function updateAuthBar(){
  const bar = document.getElementById('authBar');
  const lbl = document.getElementById('authUserLabel');
  const btnA = document.getElementById('btnAdmin');
  const btnL = document.getElementById('btnLogout');
  if (!bar || !lbl || !btnL) return;

  if (AUTH && AUTH.ready && AUTH.user) {
    bar.style.display = 'flex';
    lbl.textContent = AUTH.user + (AUTH.role ? ' • ' + AUTH.role : '');
    if (btnA) btnA.style.display = (String(AUTH.role||'').toUpperCase()==='ADMIN') ? 'inline-flex' : 'none';
  } else {
    bar.style.display = 'none';
  }
}

function bindAuthBar(){
  const btnL = document.getElementById('btnLogout');
  if (btnL && !btnL.__bound){
    btnL.__bound = true;
    btnL.addEventListener('click', () => doLogout());
  }
  const btnA = document.getElementById('btnAdmin');
  if (btnA && !btnA.__bound){
    btnA.__bound = true;
    btnA.addEventListener('click', () => openAdmin());
  }
}

function doLogout(){
  // encerra sessão no servidor e limpa estado local (best-effort)
  const t = currentToken();

  // remove mapa (se existir) e limpa referências
  try {
    if (window.__maplibreMap && typeof window.__maplibreMap.remove === 'function') {
      window.__maplibreMap.remove();
    }
  } catch (e) {}
  window.__maplibreMap = null;
  window.__markersById = new Map();
  window.__caixasById = new Map();

  const finish = () => {
    // limpa token local
    setStoredToken('');
    try { sessionStorage.removeItem('ftth_token'); } catch(_){}

    // reseta estado em memória
    try { AUTH.token = null; AUTH.user = null; AUTH.role = null; AUTH.ready = false; } catch(_){}

    // fecha UIs abertas
    try { if (typeof closeAdmin === 'function') closeAdmin(); } catch(_){}
    try { if (typeof closeDrawer === 'function') closeDrawer(); } catch(_){}

    // atualiza barra de auth (fica escondida)
    try { updateAuthBar(); } catch(_){}

    // volta para login sem recarregar
    try { showLogin(''); } catch(_){}
  };

  // tenta invalidar no servidor (best-effort), mas sempre finaliza
  callServer('logout', [t], finish, finish);
}



// ===== Rotas (Admin) UI =====
const ROUTE_ADMIN = {
  open: false,
  draw: false,
  points: [],
  tempMarkers: [],
  bound: false
};

function isAdmin_(){
  return String(AUTH?.role || '').toUpperCase() === 'ADMIN';
}

function buildRotasPanelEl_(){
  const el = document.createElement('div');
  el.id = 'rotasAdminPanel';
  el.className = 'panel'; // reuse panel styling; will be normalized to in-drawer
  el.innerHTML = `
    <div class="panel-header">
      <span>Rotas (Admin)</span>
      <button class="icon-btn" id="btnRotasHelp" title="Ajuda">?</button>
    </div>
    <div class="panel-body">
      <div class="row">
        <label class="label">Rotas existentes</label>
        <select id="rotaSelect"></select>
        <div class="hint">Selecione para carregar no formulário. Apenas ADMIN pode editar.</div>
      </div>

      <div class="admin-actions" style="margin-top:8px">
        <button class="btn btn-small" id="btnRotaLoad">Carregar</button>
        <button class="btn btn-small" id="btnRotaNew">Nova</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.10); margin:12px 0">

      <div class="row">
        <label class="label">ID da rota</label>
        <input id="rotaIdInput" placeholder="ex: ROTA_001" />
      </div>

      <div class="admin-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="row">
          <label class="label">Tipo</label>
          <select id="rotaTipo">
            <option value="BACKBONE">BACKBONE (azul)</option>
            <option value="FEEDER">FEEDER (preto)</option>
            <option value="DISTRIBUICAO">DISTRIBUIÇÃO (preto)</option>
            <option value="DROP">DROP (verde)</option>
          </select>
        </div>
        <div class="row">
          <label class="label">Espessura (peso)</label>
          <input id="rotaPeso" type="number" min="1" max="20" step="1" placeholder="auto" />
        </div>
      </div>

      <div class="row">
        <label class="label">Pontos (1 por linha)</label>
        <textarea id="rotaPts" placeholder="lat,lng&#10;lat,lng&#10;..."></textarea>
        <div class="hint">Aceita: <b>lat,lng</b> ou <b>lng,lat</b>. Você também pode desenhar clicando no mapa.</div>
      </div>

      <div class="admin-actions">
        <button class="btn btn-success" id="btnRotaSave">Salvar</button>
        <button class="btn" id="btnRotaDraw">Desenhar no mapa</button>
        <button class="btn" id="btnRotaClear">Limpar pontos</button>
        <button class="btn btn-danger" id="btnRotaDelete">Remover rota</button>
      </div>

      <div class="msg ok" id="rotaMsgOk"></div>
      <div class="msg err" id="rotaMsgErr"></div>
    </div>
  `;
  return el;
}

function showRotaMsg_(ok, text){
  const okEl = document.getElementById('rotaMsgOk');
  const errEl = document.getElementById('rotaMsgErr');
  if (okEl) okEl.style.display = ok ? 'block' : 'none';
  if (errEl) errEl.style.display = ok ? 'none' : 'block';
  if (okEl && ok) okEl.textContent = text || 'OK';
  if (errEl && !ok) errEl.textContent = text || 'Erro';
}

function normalizeTipo_(t){
  const s = String(t || '').trim().toUpperCase();
  if (!s) return 'BACKBONE';
  if (s.includes('BACK')) return 'BACKBONE';
  if (s.includes('DROP')) return 'DROP';
  if (s.includes('FEED')) return 'FEEDER';
  if (s.includes('DISTR')) return 'DISTRIBUICAO';
  return s;
}

function defaultPesoForTipo_(tipo){
  const t = normalizeTipo_(tipo);
  if (t === 'BACKBONE') return 10;
  if (t === 'DROP') return 4;
  return 7; // FEEDER/DISTR
}

function parsePointsTextarea_(txt){
  const out = [];
  // aceita tanto quebras reais quanto sequências literais "\\n" (ex.: texto gerado/colado)
  txt = String(txt||'').replace(/\\r\\n/g,'\n').replace(/\\n/g,'\n');
  const lines = String(txt||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  for (const line of lines){
    const parts = line.split(/[,\s;]+/).map(s=>s.trim()).filter(Boolean);
    if (parts.length < 2) continue;
    let a = Number(parts[0].replace(',','.'));
    let b = Number(parts[1].replace(',','.'));
    if (!Number.isFinite(a) || !Number.isFinite(b)) continue;

    // assume lat,lng; if looks swapped, swap
    let lat = a, lng = b;
    if (Math.abs(lat) > 90 && Math.abs(lng) <= 90) { // likely lng,lat
      lng = a; lat = b;
    }
    if (Math.abs(lat) > 90 || Math.abs(lng) > 180) continue;
    out.push({ lat, lng });
  }
  return out;
}


function autosizeTextarea_(ta){
  try{
    if (!ta) return;
    ta.style.height = 'auto';
    ta.style.overflowY = 'hidden';
    ta.style.height = (ta.scrollHeight + 2) + 'px';
  } catch(_){}
}

function setTextareaFromPoints_(){
  const ta = document.getElementById('rotaPts');
  if (ta) ta.value = ROUTE_ADMIN.points.map(p => `${p.lat},${p.lng}`).join('\n');
  // mantém os pontos visíveis no mapa (camada nativa)
  try { updateRotaEditPoints_(); } catch(_){}
}

function clearTempRouteMarkers_(){
  try{
    for (const m of ROUTE_ADMIN.tempMarkers) { try { m.remove(); } catch(_){} }
  }catch(_){}
  
    ROUTE_ADMIN.tempMarkers = [];
  }
function ensureRotaEditLayers_(){
  const map = window.__maplibreMap;
  if (!map || map.__rotaEditLayerReady) return;
  map.__rotaEditLayerReady = true;

  const empty = { type:'FeatureCollection', features:[] };
  try{
    if (!map.getSource('rota-edit-points')) {
      map.addSource('rota-edit-points', { type:'geojson', data: empty });
    }
    if (!map.getLayer('rota-edit-points-circle')) {
      map.addLayer({
        id: 'rota-edit-points-circle',
        type: 'circle',
        source: 'rota-edit-points',
        paint: {
          'circle-radius': 5,
          'circle-color': '#111',
          'circle-opacity': 0.85,
          'circle-stroke-width': 2,
          'circle-stroke-color': '#fff',
          'circle-stroke-opacity': 0.95
        }
      });
    }
  }catch(e){
    // não derrubar a UI por causa da camada de pontos
    console.warn('[rota-edit] não foi possível criar camada de pontos:', e);
  }
}

function updateRotaEditPoints_(){
  const map = window.__maplibreMap;
  if (!map) return;
  ensureRotaEditLayers_();

  const feats = (ROUTE_ADMIN.points || []).map(p => ({
    type:'Feature',
    geometry:{ type:'Point', coordinates:[Number(p.lng), Number(p.lat)] },
    properties:{}
  }));

  const fc = { type:'FeatureCollection', features: feats };
  try{
    const src = map.getSource('rota-edit-points');
    if (src && typeof src.setData === 'function') src.setData(fc);
  }catch(e){
    console.warn('[rota-edit] setData falhou:', e);
  }
}

function clearRotaEditPoints_(){
  const map = window.__maplibreMap;
  if (!map) return;
  try{
    const src = map.getSource('rota-edit-points');
    if (src && typeof src.setData === 'function') src.setData({ type:'FeatureCollection', features:[] });
  }catch(_){}
}


function setDrawMode_(on){
  ROUTE_ADMIN.draw = !!on;
  const b = document.getElementById('btnRotaDraw');
  if (b) b.textContent = ROUTE_ADMIN.draw ? 'Parar desenho' : 'Desenhar no mapa';

  // Ao parar o desenho, esconda os pontos (deixa só a linha da rota no mapa).
  if (!ROUTE_ADMIN.draw) {
    try { clearRotaEditPoints_(); } catch(_) {}
  }

  showRotaMsg_(true, ROUTE_ADMIN.draw
    ? 'Modo desenho: clique no mapa para adicionar pontos.'
    : 'Modo desenho desativado.');
}

function bindRotasAdminUI_(){
  if (ROUTE_ADMIN.bound) return;
  ROUTE_ADMIN.bound = true;

  const help = document.getElementById('btnRotasHelp');
  if (help) help.addEventListener('click', ()=> {
    alert('ADMIN: Adicionar/Remover rotas na aba ROTAS_FIBRAS.\n\n1) Selecione uma rota e clique "Carregar"\n2) Edite ID/Tipo/Peso/Pontos\n3) Clique "Salvar"\n\nPontos: uma coordenada por linha (lat,lng). Use "Desenhar no mapa" para coletar pontos.');
  });

  const btnLoad = document.getElementById('btnRotaLoad');
  if (btnLoad) btnLoad.addEventListener('click', loadSelectedRotaToForm_);

  const btnNew = document.getElementById('btnRotaNew');
  if (btnNew) btnNew.addEventListener('click', ()=> {
    document.getElementById('rotaIdInput').value = '';
    document.getElementById('rotaTipo').value = 'BACKBONE';
    document.getElementById('rotaPeso').value = String(defaultPesoForTipo_('BACKBONE'));
    ROUTE_ADMIN.points = [];
    clearTempRouteMarkers_();
    clearRotaEditPoints_();
    setTextareaFromPoints_();
    showRotaMsg_(true, 'Formulário pronto para nova rota.');
  });

  const btnClear = document.getElementById('btnRotaClear');
  if (btnClear) btnClear.addEventListener('click', ()=> {
    ROUTE_ADMIN.points = [];
    clearTempRouteMarkers_();
    clearRotaEditPoints_();
    setTextareaFromPoints_();
    showRotaMsg_(true, 'Pontos limpos.');
  });

  const btnSave = document.getElementById('btnRotaSave');
  if (btnSave) btnSave.addEventListener('click', saveRotaFromForm_);

  const btnDel = document.getElementById('btnRotaDelete');
  if (btnDel) btnDel.addEventListener('click', deleteRotaFromForm_);

  const btnDraw = document.getElementById('btnRotaDraw');
  if (btnDraw) btnDraw.addEventListener('click', ()=> {
    const turningOn = !ROUTE_ADMIN.draw;
    setDrawMode_(turningOn);

    if (turningOn){
      // Fecha a aba/modal para o usuário ir direto pro mapa desenhar
      try{ if (typeof closeAdmin === 'function') closeAdmin(); } catch(_){}
      try{ if (typeof closeDrawer === 'function') closeDrawer(); } catch(_){}
      try{ showToast('Modo desenho: clique no mapa para adicionar pontos.'); } catch(_){}
      // dá foco no mapa (atalhos/scroll)
      try{ document.getElementById('map')?.focus?.(); } catch(_){}
    }
  });

  const taPts = document.getElementById('rotaPts');
  if (taPts && !taPts.__autosizeBound){
    taPts.__autosizeBound = true;
    taPts.addEventListener('input', ()=> autosizeTextarea_(taPts));
    // auto-ajusta na abertura
    setTimeout(()=> autosizeTextarea_(taPts), 0);
  }

  // hook map click for drawing
  try{
    const map = window.__maplibreMap;
    if (map && !map.__rotaDrawBound){
      map.__rotaDrawBound = true;
      try{ ensureRotaEditLayers_(); updateRotaEditPoints_(); }catch(_){}
      map.on('click', (e)=>{
        if (!ROUTE_ADMIN.draw) return;
        const lng = e?.lngLat?.lng;
        const lat = e?.lngLat?.lat;
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        ROUTE_ADMIN.points.push({ lat, lng });
        try{ updateRotaEditPoints_(); }catch(_){}
        // temp marker
        try{
          const el = document.createElement('div');
          el.style.width='10px'; el.style.height='10px';
          el.style.border='2px solid #fff';
          el.style.borderRadius='999px';
          el.style.background='rgba(0,0,0,0.65)';
          const mk = new maplibregl.Marker({ element: el, anchor:'center' }).setLngLat([lng, lat]).addTo(map);
          ROUTE_ADMIN.tempMarkers.push(mk);
        }catch(_){}
        setTextareaFromPoints_();
      });
    }
  }catch(_){}
}

function refreshRotasSelect_(data){
  const sel = document.getElementById('rotaSelect');
  if (!sel) return;
  sel.innerHTML = '';
  const feats = Array.isArray(data?.rotas?.features) ? data.rotas.features : [];
  const uniq = new Map();
  for (const f of feats){
    const id = String(f?.properties?.rotaId || '').trim();
    if (!id) continue;
    if (!uniq.has(id)){
      uniq.set(id, {
        rotaId:id,
        tipo: String(f?.properties?.tipo||''),
        peso: f?.properties?.peso
      });
    }
  }
  const arr = Array.from(uniq.values()).sort((a,b)=>a.rotaId.localeCompare(b.rotaId));
  const opt0 = document.createElement('option');
  opt0.value = ''; opt0.textContent = '-- selecione --';
  sel.appendChild(opt0);
  for (const r of arr){
    const opt = document.createElement('option');
    opt.value = r.rotaId;
    const tipo = normalizeTipo_(r.tipo);
    opt.textContent = `${r.rotaId} (${tipo})`;
    sel.appendChild(opt);
  }
}

function loadSelectedRotaToForm_(){
  const data = window.__DATA__ || {};
  const sel = document.getElementById('rotaSelect');
  const rotaId = String(sel?.value || '').trim();
  if (!rotaId){ showRotaMsg_(false,'Selecione uma rota.'); return; }

  const feats = Array.isArray(data?.rotas?.features) ? data.rotas.features : [];
  const f = feats.find(x => String(x?.properties?.rotaId||'').trim() === rotaId);
  if (!f){ showRotaMsg_(false,'Rota não encontrada nos dados atuais. Recarregue.'); return; }

  document.getElementById('rotaIdInput').value = rotaId;
  const tipo = normalizeTipo_(f?.properties?.tipo || 'BACKBONE');
  document.getElementById('rotaTipo').value = (tipo === 'DISTRIBUICAO') ? 'DISTRIBUICAO' : tipo;
  document.getElementById('rotaPeso').value = String(Number(f?.properties?.peso || defaultPesoForTipo_(tipo)));

  // points from geometry
  const coords = f?.geometry?.coordinates;
  ROUTE_ADMIN.points = [];
  clearTempRouteMarkers_();
  if (Array.isArray(coords)){
    for (const c of coords){
      if (!Array.isArray(c) || c.length < 2) continue;
      const lng = Number(c[0]); const lat = Number(c[1]);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
      ROUTE_ADMIN.points.push({ lat, lng });
    }
  }
  setTextareaFromPoints_();
  try{ updateRotaEditPoints_(); }catch(_){}
  showRotaMsg_(true, 'Rota carregada.');
}

function saveRotaFromForm_(){
  if (!isAdmin_()){ showRotaMsg_(false,'Apenas ADMIN.'); return; }
  const token = currentToken();
  if (!token) { showLogin(); return; }

  const rotaId = String(document.getElementById('rotaIdInput')?.value || '').trim();
  if (!rotaId){ showRotaMsg_(false,'ID da rota é obrigatório.'); return; }

  const tipo = normalizeTipo_(document.getElementById('rotaTipo')?.value || 'BACKBONE');
  let peso = Number(document.getElementById('rotaPeso')?.value || '');
  if (!Number.isFinite(peso) || peso <= 0) peso = defaultPesoForTipo_(tipo);

  // points: prefer textarea content (user may paste)
  const pts = parsePointsTextarea_(document.getElementById('rotaPts')?.value || '');
  if (pts.length < 2){ showRotaMsg_(false,'Informe ao menos 2 pontos.'); return; }

  showRotaMsg_(true,'Salvando rota...');
  callServer('adminUpsertRota', [token, { rotaId, tipo, peso, points: pts }], (res)=>{
    showRotaMsg_(true,'Rota salva. Recarregando...');
    loadData();
  }, (err)=>{
    showRotaMsg_(false, err?.message || String(err));
  });
}

function deleteRotaFromForm_(){
  if (!isAdmin_()){ showRotaMsg_(false,'Apenas ADMIN.'); return; }
  const token = currentToken();
  if (!token) { showLogin(); return; }
  const rotaId = String(document.getElementById('rotaIdInput')?.value || '').trim() || String(document.getElementById('rotaSelect')?.value || '').trim();
  if (!rotaId){ showRotaMsg_(false,'Informe/Selecione a rota.'); return; }
  if (!confirm('Remover a rota "'+rotaId+'"? Isso apagará todas as linhas em ROTAS_FIBRAS.')) return;

  showRotaMsg_(true,'Removendo rota...');
  callServer('adminDeleteRota', [token, rotaId], ()=>{
    showRotaMsg_(true,'Rota removida. Recarregando...');
    ROUTE_ADMIN.points = [];
    clearTempRouteMarkers_();
    clearRotaEditPoints_();
    setTextareaFromPoints_();
    loadData();
  }, (err)=>{
    showRotaMsg_(false, err?.message || String(err));
  });
}


// ===== Admin UI =====
const ADMIN_UI = { open:false, users:[] };

function openAdmin(){
  if (String(AUTH.role||'').toUpperCase() !== 'ADMIN') {
    showError('Acesso restrito ao ADMIN.');
    return;
  }
  const bd = document.getElementById('adminBackdrop');
  if (!bd) return;
  bd.style.display = 'flex';
  bd.setAttribute('aria-hidden','false');
  ADMIN_UI.open = true;
  bindAdminUI();
  adminSwitchTab('list');
  refreshUsers();
}

function closeAdmin(){
  const bd = document.getElementById('adminBackdrop');
  if (!bd) return;
  bd.style.display = 'none';
  bd.setAttribute('aria-hidden','true');
  ADMIN_UI.open = false;
}

function bindAdminUI(){
  const closeBtn = document.getElementById('btnAdminClose');
  if (closeBtn && !closeBtn.__bound){
    closeBtn.__bound = true;
    closeBtn.addEventListener('click', closeAdmin);
  }
  const bd = document.getElementById('adminBackdrop');
  if (bd && !bd.__bound){
    bd.__bound = true;
    bd.addEventListener('click', (e) => { if (e.target === bd) closeAdmin(); });
  }

  // tabs
  ['tabListBtn','tabEditBtn','tabPassBtn','tabRotasBtn'].forEach(id=>{
    const b = document.getElementById(id);
    if (b && !b.__bound){
      b.__bound = true;
      b.addEventListener('click', ()=> adminSwitchTab(b.getAttribute('data-tab')));
    }
  });

  const r = document.getElementById('btnUsersRefresh');
  if (r && !r.__bound){ r.__bound = true; r.addEventListener('click', refreshUsers); }

  const save = document.getElementById('btnUserSave');
  if (save && !save.__bound){ save.__bound = true; save.addEventListener('click', saveUserFromForm); }

  const clear = document.getElementById('btnUserClear');
  if (clear && !clear.__bound){ clear.__bound = true; clear.addEventListener('click', clearUserForm); }

  const pass = document.getElementById('btnPassSave');
  if (pass && !pass.__bound){ pass.__bound = true; pass.addEventListener('click', savePasswordFromForm); }
}

function adminSwitchTab(tab){
  const tabs = {
    list: document.getElementById('adminTabList'),
    edit: document.getElementById('adminTabEdit'),
    pass: document.getElementById('adminTabPass'),
    rotas: document.getElementById('adminTabRotas'),
  };
  Object.keys(tabs).forEach(k=>{
    if (tabs[k]) tabs[k].style.display = (k===tab) ? 'block' : 'none';
  });
  const btns = {
    list: document.getElementById('tabListBtn'),
    edit: document.getElementById('tabEditBtn'),
    pass: document.getElementById('tabPassBtn'),
    rotas: document.getElementById('tabRotasBtn'),
  };
  Object.keys(btns).forEach(k=>{
    if (btns[k]) btns[k].classList.toggle('active', k===tab);
  });
  if (tab === 'rotas') {
    try{
      var host = document.getElementById('adminRotasHost');
      if (host && !host.__mounted){
        host.__mounted = true;
        var rotPanel = document.getElementById('rotasAdminPanel');
        if (!rotPanel) rotPanel = buildRotasPanelEl_();
        host.appendChild(rotPanel);
        try{ bindRotasAdminUI_(); }catch(_){ }
        try{ refreshRotasSelect_(window.__DATA__||{}); }catch(_){ }
      }
    }catch(_){ }
  }

  if (tab === 'edit') {
    const u = document.getElementById('editUser');
    if (u) u.focus();
  }
}

function refreshUsers(){
  const msg = document.getElementById('usersMsg');
  if (msg) msg.textContent = 'Carregando...';
  callServer('adminListUsers', [currentToken()], (res) => {
    ADMIN_UI.users = (res && Array.isArray(res.users)) ? res.users : [];
    renderUsersTable();
    if (msg) msg.textContent = ADMIN_UI.users.length ? '' : 'Nenhum usuário encontrado.';
  }, (err) => {
    if (msg) msg.textContent = err?.message || 'Falha ao carregar usuários.';
  });
}

function renderUsersTable(){
  const tb = document.getElementById('usersTbody');
  if (!tb) return;
  tb.innerHTML = '';
  (ADMIN_UI.users || []).forEach(u=>{
    const tr = document.createElement('tr');

    const tdU = document.createElement('td');
    tdU.textContent = u.user;
    tr.appendChild(tdU);

    const tdR = document.createElement('td');
    tdR.innerHTML = '<span class="pill">'+ (u.role||'USER') +'</span>';
    tr.appendChild(tdR);

    const tdS = document.createElement('td');
    tdS.innerHTML = '<span class="pill '+(u.active?'on':'off')+'">'+(u.active?'ATIVO':'INATIVO')+'</span>';
    tr.appendChild(tdS);

    const tdC = document.createElement('td');
    tdC.textContent = (u.createdAt && String(u.createdAt)) ? String(u.createdAt).slice(0,19).replace('T',' ') : '';
    tr.appendChild(tdC);

    const tdA = document.createElement('td');
    tdA.style.whiteSpace = 'nowrap';

    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn btn-secondary btn-small';
    btnEdit.type = 'button';
    btnEdit.textContent = 'Editar';
    btnEdit.addEventListener('click', ()=>{ fillUserForm(u); adminSwitchTab('edit'); });

    const btnToggle = document.createElement('button');
    btnToggle.className = 'btn btn-secondary btn-small';
    btnToggle.type = 'button';
    btnToggle.textContent = u.active ? 'Desativar' : 'Ativar';
    btnToggle.addEventListener('click', ()=> toggleUserActive(u));

    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-danger btn-small';
    btnDel.type = 'button';
    btnDel.textContent = 'Excluir';
    btnDel.addEventListener('click', ()=> deleteUser(u));

    tdA.appendChild(btnEdit);
    tdA.appendChild(document.createTextNode(' '));
    tdA.appendChild(btnToggle);
    tdA.appendChild(document.createTextNode(' '));
    tdA.appendChild(btnDel);
    tr.appendChild(tdA);

    tb.appendChild(tr);
  });
}

function fillUserForm(u){
  document.getElementById('editUser').value = u.user || '';
  document.getElementById('editRole').value = (u.role || 'USER').toUpperCase();
  document.getElementById('editActive').value = u.active ? 'TRUE' : 'FALSE';
  document.getElementById('editPass').value = '';
  const m = document.getElementById('editMsg');
  if (m) m.textContent = 'Editando: ' + (u.user||'');
}

function clearUserForm(){
  document.getElementById('editUser').value = '';
  document.getElementById('editRole').value = 'USER';
  document.getElementById('editActive').value = 'TRUE';
  document.getElementById('editPass').value = '';
  const m = document.getElementById('editMsg');
  if (m) m.textContent = '';
}

function saveUserFromForm(){
  const user = (document.getElementById('editUser')?.value || '').trim();
  const role = (document.getElementById('editRole')?.value || 'USER').trim();
  const active = (document.getElementById('editActive')?.value || 'TRUE').trim();
  const pass = (document.getElementById('editPass')?.value || '').trim();

  const m = document.getElementById('editMsg');
  if (m) m.textContent = 'Salvando...';

  callServer('adminUpsertUser', [currentToken(), user, pass, role, active], () => {
    if (m) m.textContent = 'Salvo com sucesso.';
    clearUserForm();
    refreshUsers();
    adminSwitchTab('list');
  }, (err) => {
    if (m) m.textContent = err?.message || 'Falha ao salvar.';
  });
}

function toggleUserActive(u){
  const nextActive = u.active ? 'FALSE' : 'TRUE';
  callServer('adminUpsertUser', [currentToken(), u.user, '', u.role, nextActive], () => {
    refreshUsers();
  }, (err) => showError(err?.message || 'Falha ao atualizar status.'));
}

function deleteUser(u){
  if (!confirm('Excluir usuário "'+u.user+'"?')) return;
  callServer('adminDeleteUser', [currentToken(), u.user], () => {
    refreshUsers();
  }, (err) => showError(err?.message || 'Falha ao excluir usuário.'));
}

function savePasswordFromForm(){
  const user = (document.getElementById('passUser')?.value || '').trim();
  const pass = (document.getElementById('passNew')?.value || '').trim();
  const m = document.getElementById('passMsg');
  if (m) m.textContent = 'Atualizando...';
  callServer('adminSetPassword', [currentToken(), user, pass], () => {
    if (m) m.textContent = 'Senha atualizada.';
    document.getElementById('passNew').value = '';
    refreshUsers();
  }, (err) => {
    if (m) m.textContent = err?.message || 'Falha ao atualizar senha.';
  });
}


function showLogin(msg){
  const bd = document.getElementById('loginBackdrop');
  if (bd) { bd.style.display = 'flex'; bd.setAttribute('aria-hidden','false'); }
  const m = document.getElementById('loginMsg');
  if (m) {
    if (msg) { m.textContent = msg; m.style.display = 'block'; }
    else { m.textContent = ''; m.style.display = 'none'; }
  }
}
function hideLogin(){
  const bd = document.getElementById('loginBackdrop');
  if (bd) { bd.style.display = 'none'; bd.setAttribute('aria-hidden','true'); }
  const m = document.getElementById('loginMsg');
  if (m) { m.textContent = ''; m.style.display = 'none'; }
}

function callServer(fnName, args, onSuccess, onFail){
  if (!(window.google && google.script && google.script.run)) {
    (onFail || function(e){ showError(e); })('google.script.run indisponível. Publique/execute como WebApp (Apps Script).');
    return;
  }
  const runner = google.script.run
    .withSuccessHandler(function(res){
      if (res == null) {
        const e = new Error('Resposta vazia do servidor.');
        (onFail || function(err){ showError(err?.message || String(err)); })(e);
        return;
      }
      (onSuccess || function(){})(res);
    })
    .withFailureHandler(onFail || function(err){ showError(err?.message || String(err)); });


  if (typeof runner[fnName] !== 'function') {
    const msg = `Função do servidor não encontrada: ${fnName}. ` +
      `Atualize o Code.gs (incluindo as funções de rotas Admin) e publique uma NOVA versão do Web App.`;
    (onFail || function(err){ showError(err?.message || String(err)); })(new Error(msg));
    return;
  }
  (runner[fnName]).apply(runner, Array.isArray(args) ? args : []);
}

function bootstrapAuth(){
  const t = getStoredToken();
  if (!t) { AUTH.token=null; AUTH.user=null; AUTH.role=null; AUTH.ready=false; updateAuthBar(); showLogin(); bindLogin(); return; }

  callServer('checkSession', [t], (res) => {
    AUTH.token = t; AUTH.user = res.user; AUTH.role = res.role; AUTH.ready = true;
    hideLogin();
    bindLogin();
    bindAuthBar();
    updateAuthBar();
    scheduleMapInit();
}, (err) => {
    setStoredToken('');
    AUTH.token = null; AUTH.user = null; AUTH.role = null; AUTH.ready = false;
    updateAuthBar();
    showLogin(err?.message || 'Sessão expirada. Faça login.');
    bindLogin();
  });
}

function bindLogin(){
  const btn = document.getElementById('btnLogin');
  const u = document.getElementById('loginUser');
  const p = document.getElementById('loginPass');

  if (btn && !btn.__bound){ btn.__bound = true; btn.addEventListener('click', doLogin); }
  const onKey = (e) => { if (e.key === 'Enter') { e.preventDefault(); doLogin(); } };
  if (u && !u.__bound){ u.__bound=true; u.addEventListener('keydown', onKey); }
  if (p && !p.__bound){ p.__bound=true; p.addEventListener('keydown', onKey); }
}

function doLogin(){
  const u = (document.getElementById('loginUser')?.value || '').trim();
  const p = (document.getElementById('loginPass')?.value || '').trim();
  if (!u || !p) { showLogin('Preencha usuário e senha.'); return; }

  const btn = document.getElementById('btnLogin');
  if (btn) btn.disabled = true;

  callServer('login', [u, p], (res) => {
    if (btn) btn.disabled = false;
    AUTH.token = res.token; AUTH.user = res.user; AUTH.role = res.role; AUTH.ready = true;
    __lastLoginPassword = p;
    if (res && res.mustChangePassword){
      bindForcePasswordUI();
      showForcePasswordChange();
    }
    setStoredToken(res.token);
    hideLogin();
    bindAuthBar();
    updateAuthBar();
    scheduleMapInit();
}, (err) => {
    if (btn) btn.disabled = false;
    showLogin(err?.message || 'Falha no login.');
  });
}

function currentToken(){
  return AUTH.token || getStoredToken();
}


  // ===== Projeto (centro fixo) =====
  const PROJECT_CENTER = [-41.9800, -22.2603]; // [lng, lat]
  const PROJECT_ZOOM = 14;


  let map;
  let ctosLayer = null;
  let rotasLayer = null;
  let caixasLayer = null;

function bindSearchUI(){
  const inp = document.getElementById('globalSearch');
  const go = document.getElementById('btnSearchGo');
  const cl = document.getElementById('btnSearchClear');
  if (inp && !inp.__bound){
    inp.__bound = true;
    inp.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); doGlobalSearch(); }});
  }
  if (go && !go.__bound){ go.__bound=true; go.addEventListener('click', doGlobalSearch); }
  if (cl && !cl.__bound){ cl.__bound=true; cl.addEventListener('click', ()=>{ if(inp) inp.value=''; }); }
}

function doGlobalSearch(){
  const q = (document.getElementById('globalSearch')?.value || '').trim().toLowerCase();
  if (!q) return;
  // procura em dados já carregados
  const hit = findFeatureById(q);
  if (!hit){ showToast('Nada encontrado para: ' + q); return; }
  if (map && hit.latlng){
    map.setView(hit.latlng, Math.max(map.getZoom(), 18), { animate:true });
    if (hit.marker && hit.marker.openPopup) hit.marker.openPopup();
  }
}

function findFeatureById(q){
  // MapLibre: procura em registries de markers (CTO/CAIXA)
  const key = String(q || '').toLowerCase();
  const regs = [window.__CTO_MARKERS_BY_ID__, window.__CAIXA_MARKERS_BY_ID__];
  for (const reg of regs){
    if (!reg) continue;
    const hit = reg.get ? reg.get(key) : reg[key];
    if (hit && hit.lngLat){
      return { marker: hit.marker, latlng: hit.lngLat, props: hit.props };
    }
  }
  // fallback: busca por name
  const regsByName = [window.__CTO_MARKERS_BY_NAME__, window.__CAIXA_MARKERS_BY_NAME__];
  for (const reg of regsByName){
    if (!reg) continue;
    const hit = reg.get ? reg.get(key) : reg[key];
    if (hit && hit.lngLat){
      return { marker: hit.marker, latlng: hit.lngLat, props: hit.props };
    }
  }
  return null;
}


  // Reabrir popup automaticamente após salvar/atualizar Caixa/CDO
  let __OPEN_CAIXA_ID_AFTER_RELOAD__ = null;

  const UI = {
  filterCaixa: null,
  btnAddCaixaMode: null,
  btnCancelCaixaMode: null,
  caixaModeHint: null,
};


  // ========= Text scale slider (100%–200%) =========
  function applyTextScale(pct){
    const clamped = Math.max(100, Math.min(200, Number(pct) || 100));
    const scale = clamped / 100;
    document.documentElement.style.setProperty('--text-scale', String(scale));
    document.documentElement.style.setProperty('--hud-scale', String(scale));
        const out = document.getElementById('textScaleValue');
    if (out) out.textContent = clamped + '%';
    try { localStorage.setItem('textScalePct', String(clamped)); } catch(_){}
  }

  function initTextScaleSlider(){
    const range = document.getElementById('textScaleRange');
    if (!range) return;
    let pct = 150;
    try {
      const saved = localStorage.getItem('textScalePct');
      if (saved) pct = Number(saved);
      else {
        // padrão: mobile maior
        pct = (window.innerWidth <= 768) ? 160 : 120;
      }
    } catch(_) {}
    pct = Math.max(100, Math.min(200, pct || 150));
    range.value = String(pct);
    applyTextScale(pct);

    range.addEventListener('input', function(){
      applyTextScale(range.value);
    }, { passive: true });
  }

  // Modal state (CTO)
  const modalState = {
    open: false,
    action: null, // 'add' | 'remove'
    ctoId: null,
  };

  // Caixa/CDO state
  const caixaState = {
    addMode: false,
    latlng: null,
    editingId: null, // quando for editar via popup, se quiser evoluir no futuro
    pendingImg: null, // { dataUrl, name, mime }
  };

  // ========= UI scale (mobile) =========
  function getMarkerScale() {
    const w = window.innerWidth || 1024;
    const dpr = Math.min(window.devicePixelRatio || 1, 2); // evita exagero
    // Escala para símbolos no mapa (circleMarker etc.) — em pixels, não muda com zoom do mapa
    let base = 1;
    if (w <= 480) base = 3.8;
    else if (w <= 768) base = 3.0;
    else base = 1.35;
    const fm = document.body && document.body.classList.contains("field-mode") ? 1.35 : 1;
    return base * (dpr >= 2 ? 1.05 : 1) * fm;
  }

  function getUiScaleCss() {
    const w = window.innerWidth || 1024;
    // Escala para UI (painéis, botões, popups) — menor que a escala dos símbolos
    if (w <= 480) return 1.55;
    if (w <= 768) return 1.38;
    return 1.12;
  }

  function getLineScale() {
    const w = window.innerWidth || 1024;
    if (w <= 480) return 2.6;
    if (w <= 768) return 2.2;
    return 1.35;
  }


  function applyUiScale() {
    document.documentElement.style.setProperty('--ui-scale', String(getUiScaleCss()));
  }

  function debounce(fn, wait) {
    let t = null;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function toggleMinimize(panelId){
    const el = document.getElementById(panelId);
    if(!el) return;
    el.classList.toggle('minimized');

    const btn =
      panelId === 'controls' ? document.getElementById('controlsMinBtn') :
      panelId === 'legend' ? document.getElementById('legendMinBtn') :
      null;

    if(btn){
      const isMin = el.classList.contains('minimized');
      btn.textContent = isMin ? '▢' : '—';
      btn.setAttribute('aria-label', isMin ? 'Restaurar' : 'Minimizar');
    }
  }

  function isMobileViewport() {
    return (window.innerWidth || 1024) <= 768;
  }

  // Abre/fecha painéis (FAB)
  function togglePanel(which) {
    const controls = document.getElementById('controls');
    const legend = document.getElementById('legend');
    if (!controls) return;

    // Legenda fica sempre visível; o botão "Camadas" controla apenas o painel de camadas no mobile.
    if (which === 'legend') {
      // Se no futuro você quiser esconder a legenda, dá pra implementar aqui.
      return;
    }

    if (isMobileViewport()) {
      controls.classList.toggle('is-open');
      // Evita conflito com estilos inline de versões anteriores
      controls.style.display = controls.classList.contains('is-open') ? 'block' : 'none';
    } else {
      // Desktop: alterna visibilidade do painel
      const isShown = (el) => (el.style.display !== 'none' && getComputedStyle(el).display !== 'none');
      controls.style.display = isShown(controls) ? 'none' : 'block';
    }
  }
  function applyPanelsDefaultVisibility(){
    const controls = document.getElementById('controls');
    const legend = document.getElementById('legend');
    const layersFab = document.getElementById('layersFab');
    if (!controls || !legend) return;

    if (isMobileViewport()){
      // Mobile: legenda fixa no canto superior direito; camadas abre via botão no canto inferior direito
      legend.style.display = 'block';
      legend.style.left = 'auto';
      legend.style.right = '12px';
      legend.style.top = `calc(12px + env(safe-area-inset-top))`;
      controls.classList.remove('is-open');
      controls.style.display = 'none';
      if (layersFab) layersFab.style.display = 'inline-flex';
    } else {
      // Desktop: camadas visível à esquerda; legenda no canto superior direito
      controls.style.display = 'block';
      legend.style.display = 'block';
      legend.style.left = 'auto';
      legend.style.right = '12px';
      legend.style.top = `calc(12px + env(safe-area-inset-top))`;
      if (layersFab) layersFab.style.display = 'none';
    }
  }


  // Fecha painéis ao tocar no mapa (mobile)
  function closePanelsMobile() { /* mantido para compatibilidade */ }

  function initMap() {
  // MapLibre: recria instância do mapa de forma segura
  try {
    if (window.__maplibreMap && typeof window.__maplibreMap.remove === 'function') {
      try { window.__maplibreMap.remove(); } catch(_) {}
      window.__maplibreMap = null;
    }
    const c = document.getElementById('map');
    if (!c) return;
    c.innerHTML = '';
  } catch(_) {}

// ===== MapLibre GL JS (nativo) =====
    map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: [
              'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256,
            attribution: '&copy; OpenStreetMap'
          }
        },
        layers: [
          { id: 'osm', type: 'raster', source: 'osm' }
        ]
      },
      center: PROJECT_CENTER,
      zoom: PROJECT_ZOOM,
      attributionControl: true
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    window.__maplibreMap = map;
// UI refs
  UI.filterCaixa = document.getElementById('filterCaixa');
  UI.btnAddCaixaMode = document.getElementById('btnAddCaixaMode');
  UI.btnCancelCaixaMode = document.getElementById('btnCancelCaixaMode');
  UI.caixaModeHint = document.getElementById('caixaModeHint');
const fieldBtn = document.getElementById('fieldModeBtn');
    if (fieldBtn) {
      const sync = () => {
        const on = document.body.classList.contains('field-mode');
        fieldBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        fieldBtn.title = on ? 'Modo Campo: ligado' : 'Modo Campo: desligado';
      };
      fieldBtn.addEventListener('click', () => {
        document.body.classList.toggle('field-mode');
        applyUiScale();
        // Reaplica tamanhos e estilos
        renderLayers(window.__DATA__ || {});
        sync();
      });
      sync();
    }


    if (UI.filterCaixa) UI.filterCaixa.addEventListener('input', () => renderLayers(window.__DATA__));

    if (UI.btnAddCaixaMode) UI.btnAddCaixaMode.addEventListener('click', () => setCaixaAddMode(true));
    if (UI.btnCancelCaixaMode) UI.btnCancelCaixaMode.addEventListener('click', () => setCaixaAddMode(false));

    map.on('click', (e) => {
      // No mobile: toque no mapa fecha painéis (se não estiver em modo adicionar)

      if (!caixaState.addMode) return;
      caixaState.latlng = { lat: e.lngLat.lat, lng: e.lngLat.lng };
      openCaixaModal();
    });

    // preview imagem
    const __caixaImgEl = document.getElementById('caixaImg');
    if (__caixaImgEl) __caixaImgEl.addEventListener('change', onCaixaImgPicked);

    // Ajusta espessura das rotas conforme zoom
    map.on('zoom', () => {
      const w = Math.max(2, Math.round(2 * getMarkerScale()));
      try {
        if (map.getLayer('rotas-line')) map.setPaintProperty('rotas-line', 'line-width', w);
      } catch(_) {}
    });


    // Re-render ao mudar orientação/tamanho (mobile)
    window.addEventListener('resize', debounce(() => {
      if (window.__DATA__) renderLayers(window.__DATA__);
    }, 180));

    loadData();
  }

  function setCaixaAddMode(on) {
    caixaState.addMode = !!on;
    UI.btnAddCaixaMode.disabled = caixaState.addMode;
    UI.btnCancelCaixaMode.disabled = !caixaState.addMode;
    UI.caixaModeHint.style.display = caixaState.addMode ? 'block' : 'none';
    if (!caixaState.addMode) caixaState.latlng = null;
  }

  function loadData() {
    if (!(window.google && google.script && google.script.run)) {
      // Rodando fora do Apps Script ou google.script indisponível: mantém apenas o mapa base
      map.setView([-23.55052, -46.633308], 12);
      showError('google.script.run indisponível (HTML fora do Apps Script ou bloqueio de sandbox). O mapa base foi carregado, mas os dados não puderam ser buscados.');
      return;
    }

    const token = currentToken();
    if (!token) { showLogin(); return; }

    callServer('getMapData', [token], (data) => {
      window.__DATA__ = data;
      renderLayers(data);
      try { updateHUDFromData(data); } catch(_) {}
      try { updateLegendFromData(data); } catch(_) {}
      try { updateDashboardFromData(data); } catch(_) {}
      try { if (typeof refreshRotasSelect_==='function') refreshRotasSelect_(data); } catch(_) {}

      // Reabre o popup da Caixa/CDO após recarregar (se houver pendência)
      if (__OPEN_CAIXA_ID_AFTER_RELOAD__) {
        openCaixaPopupById(__OPEN_CAIXA_ID_AFTER_RELOAD__);
        __OPEN_CAIXA_ID_AFTER_RELOAD__ = null;
      }
    }, (err) => {
      const msg = err?.message || String(err);
      if (/Sessão expirada|Não autenticado/i.test(msg)) {
        setStoredToken('');
        showLogin(msg);
        return;
      }
      alert('Erro ao carregar dados: ' + msg);
    });
  }

  function styleRota(feature) {
    const tipo = (feature.properties?.tipo || 'BACKBONE').toUpperCase();
    const peso = Number(feature.properties?.peso || 6);

    // Cores por tipo
    if (tipo === 'FEEDER') {
      return { color: '#000000', weight: peso * getLineScale(), opacity: 0.95 };
    }
    if (tipo === 'DROP') {
      return { color: '#00a3a3', weight: peso * getLineScale(), opacity: 0.95, dashArray: '6 6' };
    }
    return { color: '#0b57d0', weight: peso * getLineScale(), opacity: 0.95 }; // BACKBONE
  }

  
  
  
function updateDashboardFromData(data){
  try{
    const counts = data?.counts || {};
    const ctosTotal = Number(counts.ctos_total ?? counts.ctos ?? (Array.isArray(data?.ctos?.features) ? data.ctos.features.length : 0)) || 0;
    const ctosCheias = Number(counts.ctos_cheias ?? 0) || 0;
    const clientesAtivos = Number(counts.clientes_ativos ?? 0) || 0;

    const el1 = document.getElementById('kpiCtos');
    const el2 = document.getElementById('kpiCtosCheias');
    const el3 = document.getElementById('kpiClientes');

    if (el1) el1.textContent = ctosTotal ? String(ctosTotal) : '—';
    if (el2) el2.textContent = String(ctosCheias);
    if (el3) el3.textContent = String(clientesAtivos);
  }catch(_){}
}

function updateHudFromData(data){
  try{
    const ctos = Array.isArray(data?.ctos?.features) ? data.ctos.features.length : (Array.isArray(data?.ctos) ? data.ctos.length : (Number(data?.counts?.ctos)||0));
    const caixas = Array.isArray(data?.caixas?.features) ? data.caixas.features.length : (Array.isArray(data?.caixas) ? data.caixas.length : (Number(data?.counts?.caixas)||0));
    const rotas = Array.isArray(data?.rotas?.features) ? data.rotas.features.length : (Array.isArray(data?.rotas) ? data.rotas.length : (Number(data?.counts?.rotas)||0));
    const elC = document.getElementById('hudCtos');
    const elCa = document.getElementById('hudCaixas');
    const elR = document.getElementById('hudRotas');
    if (elC) elC.textContent = String(ctos);
    if (elCa) elCa.textContent = String(caixas);
    if (elR) elR.textContent = String(rotas);
  }catch(_){}
}
function updateLegendFromData(data){
    const el = document.getElementById('legendBody');
    if(!el) return;

    const rotas = (normalizeGeoJsonFC_(data?.rotas)?.features) || (Array.isArray(data?.rotas) ? data.rotas : []);
    const ctos = (normalizeGeoJsonFC_(data?.ctos)?.features) || (Array.isArray(data?.ctos) ? data.ctos : []);
    const caixas = (normalizeGeoJsonFC_(data?.caixas)?.features) || (Array.isArray(data?.caixas) ? data.caixas : []);

    const countBy = (arr, fn) => {
      const out = {};
      for(const it of arr){
        const k = fn(it);
        out[k] = (out[k] || 0) + 1;
      }
      return out;
    };

    const rotasByTipo = countBy(rotas, f => String(f?.properties?.tipo || 'BACKBONE').toUpperCase());
    const caixasByTipo = countBy(caixas, f => String(f?.properties?.tipo || f?.properties?.tipoCaixa || 'CAIXA').toUpperCase());

    const ctoOcc = (f) => Number(f?.properties?.ocupacao || 0);
    const ctosOccBy = {
      '0–49%': ctos.filter(f => ctoOcc(f) < 50).length,
      '50–79%': ctos.filter(f => ctoOcc(f) >= 50 && ctoOcc(f) < 80).length,
      '80%+': ctos.filter(f => ctoOcc(f) >= 80).length,
    };

    const filtroCto = (UI.filterCto?.value || '').trim();
    const filtroCx  = (UI.filterCaixa?.value || '').trim();

    el.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
        <div style="flex:1;min-width:110px;">
          <div style="font-weight:900;">Resumo</div>
          <div>CTOs: <b>${ctos.length}</b></div>
          <div>Caixas/CDO: <b>${caixas.length}</b></div>
          <div>Rotas: <b>${rotas.length}</b></div>
        </div>
        <div style="flex:1;min-width:110px;">
          <div style="font-weight:900;">Filtros</div>
          <div>CTO: <b>${escapeHtml(filtroCto || '—')}</b></div>
          <div>Caixa: <b>${escapeHtml(filtroCx || '—')}</b></div>
        </div>
      </div>

      <details open>
        <summary style="cursor:pointer;font-weight:900;margin-bottom:8px;">Rotas</summary>
        <div class="row" style="margin-bottom:8px;">
          <div><span style="display:inline-block;width:26px;height:4px;background:#0b57d0;border-radius:2px;vertical-align:middle;margin-right:8px;"></span>BACKBONE <b>(${rotasByTipo.BACKBONE||0})</b></div>
          <div><span style="display:inline-block;width:26px;height:4px;background:#000;border:1px solid rgba(255,255,255,0.9);border-radius:2px;vertical-align:middle;margin-right:8px;box-sizing:border-box;"></span>FEEDER <b>(${rotasByTipo.FEEDER||0})</b></div>
          <div><span style="display:inline-block;width:26px;height:0;border-top:4px dashed #00a3a3;vertical-align:middle;margin-right:8px;"></span>DROP <b>(${rotasByTipo.DROP||0})</b></div>
        </div>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:900;margin-bottom:8px;">CTOs (Ocupação)</summary>
        <div class="row" style="margin-bottom:8px;">
          <div><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#2e7d32;vertical-align:middle;margin-right:8px;"></span>0–49% <b>(${ctosOccBy['0–49%']})</b></div>
          <div><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#f9a825;vertical-align:middle;margin-right:8px;"></span>50–79% <b>(${ctosOccBy['50–79%']})</b></div>
          <div><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#c62828;vertical-align:middle;margin-right:8px;"></span>80%+ <b>(${ctosOccBy['80%+']})</b></div>
        </div>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:900;margin-bottom:8px;">Caixas / CDO</summary>
        <div class="row" style="margin-bottom:8px;">
          ${Object.keys(caixasByTipo).sort().map(k => `<div><b>${escapeHtml(k)}</b>: ${caixasByTipo[k]}</div>`).join('')}
        </div>
      </details>
    `;
  }
function getCtoColor(props) {
  // Cor por ocupação: verde (<50), amarelo (>=50), vermelho (>=80)
  const oc = getCtoOcupacaoPct(props);
  if (oc >= 80) return '#c62828';
  if (oc >= 50) return '#f9a825';
  return '#2e7d32';
}

function getCtoOcupacaoPct(props){
  // Tenta várias chaves comuns e, se existir, calcula por usadas/capacidade
  const candidates = [
    props.ocupacao, props.OCUPACAO, props.ocupacaoPct, props.ocupacao_percent,
    props.ocupacao_percentual, props.ocupacaoPercent, props.occupancy, props.occupancyPct
  ];
  for (const v of candidates){
    const n = Number(v);
    if (Number.isFinite(n) && n >= 0) return n;
  }
  const used = Number(props.usadas ?? props.OCUPADAS ?? props.ocupadas ?? props.portas_usadas ?? props.portasOcupadas);
  const cap  = Number(props.capacidade ?? props.CAPACIDADE ?? props.total ?? props.portas_total ?? props.portasTotal);
  if (Number.isFinite(used) && Number.isFinite(cap) && cap > 0){
    return (used / cap) * 100;
  }
  return 0;
}

function getCtoRadius(props) {
  // Fixo: tamanho por capacidade
  const scale = getMarkerScale();
  const cap = Number(props.capacidade || 8);
  if (cap <= 8) return 10 * scale;
  if (cap <= 16) return 13 * scale;
  if (cap <= 24) return 16 * scale;
  return 19 * scale;
}

  function buildCtoPopup(props) {
    const id = props.id;
    const cap = props.capacidade ?? '';
    const cli = props.clientes ?? '';
    const oc = props.ocupacao ?? '';
    const bairro = props.bairro ?? '';
    const rua = props.rua ?? '';

    const hist = Array.isArray(props.historico) ? props.historico : [];
    const histHtml = hist.length
      ? `<div style="margin-top:10px;">
          <div style="font-weight:800; margin-bottom:6px;">Histórico</div>
          <div style="max-height:140px; overflow:auto; border:1px solid #eee; border-radius:10px; padding:8px;">
            ${hist.slice().reverse().map(h => {
              const d = (h.data || '').replace('T',' ').replace('Z','');
              const t = h.tipo || '';
              const c = h.cliente || '';
              const u = h.usuario || '';
              const o = h.observacao || '';
              return `<div style="margin-bottom:8px;">
                <div style="font-weight:800;">${t} <span class="muted">${d}</span></div>
                <div class="muted">Cliente: <b>${escapeHtml(c)}</b> ${u ? ' | Usuário: ' + escapeHtml(u) : ''}</div>
                ${o ? `<div class="muted">Obs: ${escapeHtml(o)}</div>` : ''}
              </div>`;
            }).join('')}
          </div>
        </div>`
      : `<div class="muted" style="margin-top:10px;">Sem movimentações.</div>`;

    return `
      <div style="min-width:260px;">
        <div style="font-weight:900; font-size:14px;">${escapeHtml(id)}</div>
        <div style="margin-top:6px;"><b>Capacidade:</b> ${escapeHtml(String(cap))}</div>
        <div><b>Clientes:</b> ${escapeHtml(String(cli))}</div>
        <div><b>Ocupação:</b> ${escapeHtml(String(oc))}%</div>
        <div><b>Status:</b> ${escapeHtml(props.status || '')}</div>
        <div class="muted" style="margin-top:6px;">${escapeHtml(rua)}${bairro ? ' - ' + escapeHtml(bairro) : ''}</div>

        <div class="popup-actions">
          <button class="btn btn-primary" onclick="openModal('add','${escapeAttr(id)}')">+ Adicionar</button>
          <button class="btn btn-danger" onclick="openModal('remove','${escapeAttr(id)}')">- Remover</button>
        </div>

        ${histHtml}
      </div>
    `;
  }

  function buildCaixaPopup(props) {
    const id = props.id || '';
    const tipo = (props.tipo || 'CE').toUpperCase();
    const obs = props.obs || '';
    const imgUrl = toDriveDirectUrl(props.imgUrl || '');

    const tipoLabel = tipo === 'CDO' ? 'CDO' : 'Caixa de Emenda (CE)';

    const imgHtml = imgUrl
      ? `<div style="margin-top:10px;">
          <a href="${escapeAttr(imgUrl)}" target="_blank" rel="noopener noreferrer" title="Abrir imagem em nova aba"><img src="${escapeAttr(imgUrl)}" style="width:100%; max-height:180px; object-fit:cover; border-radius:10px; border:1px solid #eee; cursor:pointer;" /></a>
        </div>`
      : `<div class="muted" style="margin-top:10px;">Sem imagem.</div>`;

    return `
      <div style="min-width:260px;">
        <div style="font-weight:900; font-size:14px;">${escapeHtml(id)}</div>
        <div style="margin-top:6px;"><b>Tipo:</b> ${escapeHtml(tipoLabel)}</div>
        ${obs ? `<div style="margin-top:6px;"><b>Obs:</b> ${escapeHtml(obs)}</div>` : ''}
        ${imgHtml}

        <div class="popup-actions">
          <button class="btn btn-primary" onclick="openUpdateFotoCaixa('${escapeAttr(id)}')">📷 Atualizar foto</button>
          <button class="btn btn-danger" onclick="deleteCaixa('${escapeAttr(id)}')">🗑 Excluir</button>
        </div>
        <input id="file_${escapeAttr(id)}" type="file" accept="image/*" style="display:none" onchange="onUpdateFotoPicked('${escapeAttr(id)}', this)"/>
      </div>
    `;
  }

  function buildCaixaIcon(tipo) {
    // MapLibre nativo: mantido apenas por compatibilidade (não usado no render atual).
    const t = (tipo || 'CE').toUpperCase();
    const cls = t === 'CDO' ? 'cdo' : 'ce';
    const s = 20;
    return { cls, size: s, html: `<div class="caixa-icon ${cls}" style="width:${s}px;height:${s}px;"></div>` };
  }

function normalizeGeoJsonFC_(x){
  if (!x) return null;
  if (typeof x === 'string') {
    try { x = JSON.parse(x); } catch(_) { return null; }
  }
  // Already a FeatureCollection
  if (x.type === 'FeatureCollection' && Array.isArray(x.features)) return x;
  // Single Feature
  if (x.type === 'Feature' && x.geometry) return { type:'FeatureCollection', features:[x] };
  // Array of features
  if (Array.isArray(x)) {
    const feats = x.filter(f => f && (f.type === 'Feature' || f.geometry));
    const features = feats.map(f => (f.type === 'Feature' ? f : ({ type:'Feature', properties: f.properties || {}, geometry: f.geometry })));
    return { type:'FeatureCollection', features };
  }
  // Some backends wrap as {features:[...]} without type
  if (Array.isArray(x.features)) return { type:'FeatureCollection', features: x.features };
  return null;

function clonePlain_(obj){
  if (obj == null) return obj;
  try { return JSON.parse(JSON.stringify(obj)); } catch(e){ return obj; }
}
}


function getRefBoundsFromData_(data){
  // Usa CTOs e Caixas como referência de área (evita "fly to" por coordenadas fora do município).
  const pts = [];
  try {
    const ctos = Array.isArray(data && data.ctos) ? data.ctos : [];
    for (const c of ctos){
      const lat = Number(String(c && (c.lat ?? c.LAT ?? c.latitude ?? c.Lat ?? '')).replace(',','.'));
      const lng = Number(String(c && (c.lng ?? c.LNG ?? c.longitude ?? c.Lng ?? '')).replace(',','.'));
      if (Number.isFinite(lat) && Number.isFinite(lng)) pts.push([lng, lat]);
    }
  } catch(_){}
  try {
    const caixas = Array.isArray(data && (data.caixas || data.CAIXAS || data.caixasCdo)) ? (data.caixas || data.CAIXAS || data.caixasCdo) : (Array.isArray(data && data.caixasList) ? data.caixasList : []);
    for (const c of caixas){
      const lat = Number(String(c && (c.lat ?? c.LAT ?? c.latitude ?? c.Lat ?? '')).replace(',','.'));
      const lng = Number(String(c && (c.lng ?? c.LNG ?? c.longitude ?? c.Lng ?? '')).replace(',','.'));
      if (Number.isFinite(lat) && Number.isFinite(lng)) pts.push([lng, lat]);
    }
  } catch(_){}
  if (!pts.length) return null;

  let minLng=Infinity, minLat=Infinity, maxLng=-Infinity, maxLat=-Infinity;
  for (const [lng,lat] of pts){
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
    if (lng<minLng) minLng=lng;
    if (lng>maxLng) maxLng=lng;
    if (lat<minLat) minLat=lat;
    if (lat>maxLat) maxLat=lat;
  }
  if (!Number.isFinite(minLng) || !Number.isFinite(minLat)) return null;

  // margem dinâmica (mínimo ~0.03°, máximo ~0.25°)
  const spanLng = Math.max(0.0001, maxLng-minLng);
  const spanLat = Math.max(0.0001, maxLat-minLat);
  const margin = Math.max(0.03, Math.min(0.25, Math.max(spanLng, spanLat) * 0.35));

  return { minLng: minLng - margin, minLat: minLat - margin, maxLng: maxLng + margin, maxLat: maxLat + margin };
}

function sanitizeRotasGeoJson_(fc, refBounds){
  if (!fc || !Array.isArray(fc.features)) return fc;
  if (!refBounds) return fc;

  function inBounds(lng,lat){
    return lng >= refBounds.minLng && lng <= refBounds.maxLng && lat >= refBounds.minLat && lat <= refBounds.maxLat;
  }

  function fixCoord(coord){
    if (!Array.isArray(coord) || coord.length < 2) return null;
    let a = Number(String(coord[0]).replace(',','.'));
    let b = Number(String(coord[1]).replace(',','.'));
    if (!Number.isFinite(a) || !Number.isFinite(b)) return null;

    // Heurística: se "lat" estiver fora de [-90,90] e "lng" dentro, provavelmente está invertido.
    // Normal esperado: [lng, lat]
    let lng=a, lat=b;
    if (Math.abs(lat) > 90 && Math.abs(lng) <= 90){
      lng=b; lat=a;
    }
    // ainda inválido?
    if (Math.abs(lat) > 90 || Math.abs(lng) > 180) return null;
    return [lng, lat];
  }

  function sanitizeLine(coords){
    if (!Array.isArray(coords)) return null;
    const out = [];
    for (const c of coords){
      const fixed = fixCoord(c);
      if (!fixed) continue;
      // Mantém só coords na área de referência (com margem)
      if (inBounds(fixed[0], fixed[1])) out.push(fixed);
    }
    return out.length >= 2 ? out : null;
  }

  const outFeatures = [];
  let dropped = 0;

  for (const f of fc.features){
    const g = f && f.geometry;
    if (!g || !g.type) { dropped++; continue; }

    if (g.type === 'LineString'){
      const line = sanitizeLine(g.coordinates);
      if (!line) { dropped++; continue; }
      outFeatures.push({ ...f, geometry: { ...g, coordinates: line } });
      continue;
    }

    if (g.type === 'MultiLineString'){
      const lines = [];
      for (const part of (g.coordinates || [])){
        const line = sanitizeLine(part);
        if (line) lines.push(line);
      }
      if (!lines.length) { dropped++; continue; }
      outFeatures.push({ ...f, geometry: { ...g, coordinates: lines } });
      continue;
    }

    // Ignora outros tipos (não deveria existir em ROTAS_FIBRAS)
    dropped++;
  }

  const out = { type: 'FeatureCollection', features: outFeatures };
  try {
    if (dropped) console.warn('[rotas] descartadas por coordenadas fora da área:', dropped);
  } catch(_){}
  return out;
}


function computeBoundsFromGeoJson_(fc){
  const gj = normalizeGeoJsonFC_(fc);
  if (!gj || !Array.isArray(gj.features) || !gj.features.length) return null;
  let minLng= Infinity, minLat= Infinity, maxLng= -Infinity, maxLat= -Infinity;
  const pushCoord = (c) => {
    if (!c || c.length < 2) return;
    const lng = Number(c[0]), lat = Number(c[1]);
    if (!Number.isFinite(lng) || !Number.isFinite(lat)) return;
    if (lng < minLng) minLng = lng;
    if (lat < minLat) minLat = lat;
    if (lng > maxLng) maxLng = lng;
    if (lat > maxLat) maxLat = lat;
  };
  const walk = (coords) => {
    if (!coords) return;
    if (typeof coords[0] === 'number') { pushCoord(coords); return; }
    for (const cc of coords) walk(cc);
  };
  for (const f of gj.features) {
    const g = f && f.geometry;
    if (!g) continue;
    walk(g.coordinates);
  }
  if (![minLng,minLat,maxLng,maxLat].every(Number.isFinite)) return null;
  // bounds degenerados: expande um pouco
  if (minLng === maxLng) { minLng -= 0.0005; maxLng += 0.0005; }
  if (minLat === maxLat) { minLat -= 0.0005; maxLat += 0.0005; }
  return { minLng, minLat, maxLng, maxLat };
}

function computeBoundsFromData_(data){
  try{
    const b1 = computeBoundsFromGeoJson_(data?.ctos);
    const b2 = computeBoundsFromGeoJson_(data?.caixas);
    const b3 = computeBoundsFromGeoJson_(data?.rotas);
    const bs = [b1,b2,b3].filter(Boolean);
    if (!bs.length) return null;
    return {
      minLng: Math.min(...bs.map(b => b.minLng)),
      minLat: Math.min(...bs.map(b => b.minLat)),
      maxLng: Math.max(...bs.map(b => b.maxLng)),
      maxLat: Math.max(...bs.map(b => b.maxLat)),
    };
  }catch(_){
    return null;
  }
}

  
// ===== FIX: ensure clonePlain_ is defined in the global scope (Apps Script sandbox + MapLibre worker serialization)
function clonePlain_(obj){
  if (obj == null) return obj;
  try { return JSON.parse(JSON.stringify(obj)); } catch(e){ return obj; }
}

function renderLayers(data) {
    if (!data) return;
    const map = window.__maplibreMap;
    if (!map) return;
    if (!map.isStyleLoaded || !map.isStyleLoaded()) {
      try { map.once('load', () => renderLayers(data)); } catch(_) {}
      return;
    }

    // Registries
    window.__CTO_MARKERS_BY_ID__ = new Map();
    window.__CTO_MARKERS_BY_NAME__ = new Map();
    window.__CAIXA_MARKERS_BY_ID__ = new Map();
    window.__CAIXA_MARKERS_BY_NAME__ = new Map();

    // Limpa markers existentes
    if (window.__CTO_MARKERS__) { window.__CTO_MARKERS__.forEach(m => { try { m.remove(); } catch(_){} }); }
    if (window.__CAIXA_MARKERS__) { window.__CAIXA_MARKERS__.forEach(m => { try { m.remove(); } catch(_){} }); }
    window.__CTO_MARKERS__ = [];
    window.__CAIXA_MARKERS__ = [];

    // Remove layers/sources de rotas
    try {
      if (map.getLayer('rotas-line')) map.removeLayer('rotas-line');
      if (map.getSource('rotas')) map.removeSource('rotas');
    } catch(_) {}

    // ROTAS (LineString/MultiLineString)
    let rotas = normalizeGeoJsonFC_(data.rotas);
    // IMPORTANT: objetos vindos do sandbox do Apps Script podem não ser serializáveis pelo worker.
    rotas = clonePlain_(rotas);
    const __refBounds = getRefBoundsFromData_(data);
    rotas = sanitizeRotasGeoJson_(rotas, __refBounds);
    rotas = clonePlain_(rotas);

    try { console.log('[rotas] features:', rotas && rotas.features ? rotas.features.length : null); } catch(_) {}
    map.once('idle', () => {}); // noop para estabilizar
    if (rotas) {
      try {
        map.addSource('rotas', { type: 'geojson', data: rotas });
        map.addLayer({
          id: 'rotas-line',
          type: 'line',
          source: 'rotas',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-color': ['match',
              ['downcase', ['to-string', ['get', 'tipo']]],
              'backbone', '#1d4ed8',
              'feeder',   '#111111',
              'distribuicao', '#111111',
              'distribuição', '#111111',
              'distribution', '#111111',
              'drop',     '#16a34a',
              /* default */ '#1f6feb'
            ],
            'line-width': ['match',
              ['downcase', ['to-string', ['get', 'tipo']]],
              'backbone', 6,
              'feeder',   4,
              'distribuicao', 4,
              'distribuição', 4,
              'distribution', 4,
              'drop',     3,
              /* default */ 4
            ],
            'line-opacity': 0.92
          }
        });
      } catch (e) {
        // se já existia (race), tenta setData
        try {
          if (map.getSource('rotas')) map.getSource('rotas').setData(clonePlain_(rotas));
        } catch(_) {}
      }

      // Popup ao clicar na rota
      const rotaClickHandler = (e) => {
        try {
          const feats = map.queryRenderedFeatures(e.point, { layers: ['rotas-line'] });
          if (!feats || !feats.length) return;
          const f = feats[0];
          const p = (f && f.properties) ? f.properties : {};
          const html = `
            <div style="min-width:220px;">
              <div style="font-weight:900;">${escapeHtml(p.rotaId || '')}</div>
              <div><b>TIPO:</b> ${escapeHtml(p.tipo || '')}</div>
              <div><b>PESO:</b> ${escapeHtml(String(p.peso ?? ''))}</div>
              <div><b>Pontos:</b> ${escapeHtml(String(p.pontos ?? ''))}</div>
            </div>`;
          new maplibregl.Popup({ closeButton: true, closeOnClick: true, offset: 12, className: 'popup-big' })
            .setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map);
        } catch(_) {}
      };
      // remove handler antigo (se houver)
      if (window.__ROTA_CLICK_HANDLER__) {
        try { map.off('click', 'rotas-line', window.__ROTA_CLICK_HANDLER__); } catch(_) {}
      }
      window.__ROTA_CLICK_HANDLER__ = rotaClickHandler;
      try { map.on('click', 'rotas-line', rotaClickHandler); } catch(_) {}
      try {
        map.on('mouseenter', 'rotas-line', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'rotas-line', () => { map.getCanvas().style.cursor = ''; });
      } catch(_) {}
    }

    // CAIXAS/CDO (markers DOM + popup)
    const filtroCx = (UI.filterCaixa && UI.filterCaixa.value ? UI.filterCaixa.value : '').trim().toUpperCase();
    const caixas = (data.caixas && data.caixas.features) ? data.caixas.features : [];
    for (const ft of caixas) {
      const props = ft.properties || {};
      const id = String(props.id || '').trim();
      const name = String(props.name || '').trim();
      const idUp = id.toUpperCase();
      if (filtroCx && !idUp.includes(filtroCx)) continue;

      const coords = ft.geometry && ft.geometry.coordinates;
      if (!coords || coords.length < 2) continue;
      const lng = Number(coords[0]), lat = Number(coords[1]);
      if (!Number.isFinite(lng) || !Number.isFinite(lat)) continue;

      const tipo = props.tipo || '';
      const cls = (String(tipo).toUpperCase() === 'CDO') ? 'cdo' : 'ce';
      const s = getCaixaSize();
      const el = document.createElement('div');
      el.className = `caixa-icon ${cls}`;
      el.style.width = s + 'px';
      el.style.height = s + 'px';

      const popupHtml = buildCaixaPopup(props);
      const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true, offset: 18, className: 'popup-big' })
        .setHTML(popupHtml);

      const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
        .setLngLat([lng, lat])
        .setPopup(popup)
        .addTo(map);

      window.__CAIXA_MARKERS__.push(marker);
      const key = id.toLowerCase();
      if (key) window.__CAIXA_MARKERS_BY_ID__.set(key, { marker, popup, lngLat: {lng, lat}, props });
      const nkey = name.toLowerCase();
      if (nkey) window.__CAIXA_MARKERS_BY_NAME__.set(nkey, { marker, popup, lngLat: {lng, lat}, props });
    }

    // CTOs (markers DOM SVG + popup)
    const ctos = (data.ctos && data.ctos.features) ? data.ctos.features : [];
    for (const ft of ctos) {
      const props = ft.properties || {};
      const id = String(props.id || props.cto || '').trim();
      const name = String(props.name || '').trim();

      const coords = ft.geometry && ft.geometry.coordinates;
      if (!coords || coords.length < 2) continue;
      const lng = Number(coords[0]), lat = Number(coords[1]);
      if (!Number.isFinite(lng) || !Number.isFinite(lat)) continue;

      const ocPct = getCtoOcupacaoPct(props);
      const pulse = ocPct >= 80;
      const strokeColor = getCtoColor(props);

      const size = 20;
      const el = document.createElement('div');
      el.className = pulse ? 'cto-x-icon cto-pulse' : 'cto-x-icon';
      el.style.width = size + 'px';
      el.style.height = size + 'px';
      el.innerHTML = `
        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false">
          <path d="M4 4 L16 16 M16 4 L4 16" stroke="rgba(255,255,255,0.98)" stroke-width="7.0" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 4 L16 16 M16 4 L4 16" stroke="#000" stroke-width="6.0" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 4 L16 16 M16 4 L4 16" stroke="${strokeColor}" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;

      const popupHtml = buildCtoPopup(props);
      const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true, offset: 18, className: 'popup-big' })
        .setHTML(popupHtml);

      const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
        .setLngLat([lng, lat])
        .setPopup(popup)
        .addTo(map);

      window.__CTO_MARKERS__.push(marker);
      const key = id.toLowerCase();
      if (key) window.__CTO_MARKERS_BY_ID__.set(key, { marker, popup, lngLat: {lng, lat}, props });
      const nkey = name.toLowerCase();
      if (nkey) window.__CTO_MARKERS_BY_NAME__.set(nkey, { marker, popup, lngLat: {lng, lat}, props });
    }

    // Fit bounds só na primeira vez
    if (!window.__FITTED__) {
      const b = computeBoundsFromData_(data);
      if (b) {
        try {
          map.fitBounds([[b.minLng, b.minLat], [b.maxLng, b.maxLat]], { padding: 40, duration: 0 });
        } catch(_) {}
      } else {
        map.setCenter(PROJECT_CENTER);
        map.setZoom(PROJECT_ZOOM);
      }
      window.__FITTED__ = true;
    }

    updateLegendFromData(data);
    updateHudFromData(data);
    updateDashboardFromData(data);
}


  // ========= Reabrir popup da Caixa/CDO por ID =========
  function openCaixaPopupById(id) {
    const map = window.__maplibreMap;
    if (!map) return;

    const targetId = String(id || '').trim().toLowerCase();
    const reg = window.__CAIXA_MARKERS_BY_ID__;
    const hit = reg && (reg.get ? reg.get(targetId) : reg[targetId]);
    if (!hit) return;

    try {
      map.easeTo({ center: [hit.lngLat.lng, hit.lngLat.lat], zoom: Math.max(map.getZoom(), 16), duration: 450 });
    } catch(_) {}

    try {
      if (hit.popup) hit.popup.addTo(map);
    } catch(_) {}
  }

  // ========= Saving overlay =========
  function showSavingOverlay(title, sub) {
    const ov = document.getElementById('savingOverlay');
    if (!ov) return;
    const t = document.getElementById('savingTitle');
    const s = document.getElementById('savingSub');
    if (t) t.textContent = title || 'Salvando...';
    if (s) s.textContent = sub || 'Aguarde um instante.';
    ov.style.display = 'flex';
    ov.setAttribute('aria-hidden', 'false');
  }

  function hideSavingOverlay() {
    const ov = document.getElementById('savingOverlay');
    if (!ov) return;
    ov.style.display = 'none';
    ov.setAttribute('aria-hidden', 'true');
  }

  // ========= Modal CTO =========
  function openModal(action, ctoId) {
    modalState.open = true;
    modalState.action = action;
    modalState.ctoId = ctoId;

    var _mt = document.getElementById('modalTitle'); if(_mt) _mt.textContent =
      action === 'add' ? 'Adicionar cliente' : 'Remover cliente';

    document.getElementById('modalCto').value = ctoId;
    document.getElementById('modalCliente').value = '';
    document.getElementById('modalUsuario').value = '';
    document.getElementById('modalObs').value = '';

    hideMsg();

    document.getElementById('modalConfirm').className =
      action === 'add' ? 'btn btn-primary' : 'btn btn-danger';

    document.getElementById('modalBackdrop').style.display = 'flex';
  }

  function closeModal() {
    modalState.open = false;
    document.getElementById('modalBackdrop').style.display = 'none';
  }

  function hideMsg() {
    const ok = document.getElementById('msgOk');
    const er = document.getElementById('msgErr');
    ok.style.display = 'none'; ok.textContent = '';
    er.style.display = 'none'; er.textContent = '';
  }

  function showOk(msg) {
    const ok = document.getElementById('msgOk');
    ok.textContent = msg;
    ok.style.display = 'block';
  }

  function showErr(msg) {
    const er = document.getElementById('msgErr');
    er.textContent = msg;
    er.style.display = 'block';
  }

  function confirmModal() {
    hideMsg();

    const ctoId = modalState.ctoId;
    const cliente = (document.getElementById('modalCliente').value || '').trim();
    const usuario = (document.getElementById('modalUsuario').value || '').trim();
    const obs = (document.getElementById('modalObs').value || '').trim();

    if (!cliente) {
      showErr('Preencha o campo CLIENTE.');
      return;
    }

    const btn = document.getElementById('modalConfirm');

    if (!(window.google && google.script && google.script.run)) {
      showErr('google.script.run indisponível. Publique/execute como WebApp (Apps Script).');
      return;
    }
    btn.disabled = true;

    const onDone = (res) => {
      btn.disabled = false;
      showOk(`OK. Ativos: ${res.ativos}/${res.capacidade} (${res.ocupacao}%).`);
      loadData();
      setTimeout(() => closeModal(), 700);
    };

    const onFail = (err) => {
      btn.disabled = false;
      showErr(err?.message || String(err));
    };

    if (modalState.action === 'add') {
      google.script.run
        .withSuccessHandler(onDone)
        .withFailureHandler(onFail)
        .adicionarClienteValidated(currentToken(), ctoId, cliente, usuario, obs);
    } else {
      google.script.run
        .withSuccessHandler(onDone)
        .withFailureHandler(onFail)
        .removerClienteValidated(currentToken(), ctoId, cliente, usuario, obs);
    }
  }

  
  // Bind modal actions (Enter confirma, Esc fecha)
  (function bindCtoModalKeys(){
    const backdrop = document.getElementById('modalBackdrop');
    if (!backdrop) return;
    backdrop.addEventListener('keydown', function(e){
      if (e.key === 'Escape') { e.preventDefault(); closeModal(); }
      if (e.key === 'Enter') {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        // Enter em textarea não confirma
        if (tag === 'textarea') return;
        e.preventDefault();
        confirmModal();
      }
    });
  })();


  // ========= Modal Caixa/CDO =========
  function openCaixaModal() {
    // modo criação: precisa ter latlng
    if (!caixaState.latlng) {
      showCaixaErr('Clique no mapa para definir a posição.');
      return;
    }

    document.getElementById('caixaTitle').textContent = 'Nova Caixa/CDO';
    document.getElementById('caixaTipo').value = 'CE';
    document.getElementById('caixaId').value = '';
    document.getElementById('caixaObs').value = '';
    document.getElementById('caixaImg').value = '';
    document.getElementById('caixaImgPreview').style.display = 'none';
    caixaState.pendingImg = null;

    hideCaixaMsg();

    document.getElementById('caixaBackdrop').style.display = 'flex';
  }

  function closeCaixaModal() {
    document.getElementById('caixaBackdrop').style.display = 'none';
  }

  function hideCaixaMsg() {
    const ok = document.getElementById('caixaMsgOk');
    const er = document.getElementById('caixaMsgErr');
    ok.style.display = 'none'; ok.textContent = '';
    er.style.display = 'none'; er.textContent = '';
  }

  function showCaixaOk(msg) {
    const ok = document.getElementById('caixaMsgOk');
    ok.textContent = msg;
    ok.style.display = 'block';
  }

  function showCaixaErr(msg) {
    const er = document.getElementById('caixaMsgErr');
    er.textContent = msg;
    er.style.display = 'block';
  }

  function onCaixaImgPicked(ev) {
    const f = ev.target.files && ev.target.files[0];
    if (!f) {
      caixaState.pendingImg = null;
      document.getElementById('caixaImgPreview').style.display = 'none';
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = String(reader.result || '');
      caixaState.pendingImg = { dataUrl, name: f.name || 'foto.jpg', mime: f.type || 'image/jpeg' };
      const img = document.getElementById('caixaImgPreview');
      img.src = dataUrl;
      img.style.display = 'block';
    };
    reader.readAsDataURL(f);
  }

  function confirmCaixaModal() {
    hideCaixaMsg();

    const id = (document.getElementById('caixaId').value || '').trim();
    const tipo = (document.getElementById('caixaTipo').value || 'CE').trim();
    const obs = (document.getElementById('caixaObs').value || '').trim();

    if (!id) {
      showCaixaErr('Preencha o ID.');
      return;
    }
    if (!caixaState.latlng) {
      showCaixaErr('Posição não definida. Ative o modo adicionar e clique no mapa.');
      return;
    }

    const btn = document.getElementById('caixaConfirm');
    btn.disabled = true;

    const payload = {
      id,
      tipo,
      lat: caixaState.latlng.lat,
      lng: caixaState.latlng.lng,
      obs,
      img: caixaState.pendingImg ? {
        dataUrl: caixaState.pendingImg.dataUrl,
        name: caixaState.pendingImg.name,
        mime: caixaState.pendingImg.mime
      } : null
    };

        // Overlay enquanto envia (principalmente quando há imagem)
    if (payload.img) {
      showSavingOverlay('Salvando imagem...', 'Enviando para o Drive e atualizando a planilha.');
    } else {
      showSavingOverlay('Salvando...', 'Atualizando a planilha e o mapa.');
    }

    google.script.run
      .withSuccessHandler((res) => {
        hideSavingOverlay();
        btn.disabled = false;
        showCaixaOk('Salvo! Abrindo no mapa...');

        // marca para abrir popup depois do reload
        __OPEN_CAIXA_ID_AFTER_RELOAD__ = res.id;

        setCaixaAddMode(false);
        caixaState.latlng = null;
        loadData();
        setTimeout(() => closeCaixaModal(), 400);
      })
      .withFailureHandler((err) => {
        hideSavingOverlay();
        btn.disabled = false;
        showCaixaErr(err?.message || String(err));
      })
      .addCaixaValidated(currentToken(), payload);
  }

  // ========= Atualizar foto via popup =========
  function openUpdateFotoCaixa(id) {
    const el = document.getElementById('file_' + id);
    if (el) el.click();
  }

  function onUpdateFotoPicked(id, inputEl) {
    const f = inputEl.files && inputEl.files[0];
    if (!f) return;

    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = String(reader.result || '');
            showSavingOverlay('Atualizando imagem...', 'Enviando a nova foto para o Drive.');

      google.script.run
        .withSuccessHandler(() => {
          hideSavingOverlay();
          __OPEN_CAIXA_ID_AFTER_RELOAD__ = id;
          loadData();
        })
        .withFailureHandler((err) => { hideSavingOverlay(); alert(err?.message || String(err)); })
        .updateCaixaFoto(currentToken(), id, { dataUrl, name: f.name || 'foto.jpg', mime: f.type || 'image/jpeg' });
    };
    reader.readAsDataURL(f);
  }

  function deleteCaixa(id) {
    if (!confirm('Excluir "' + id + '"?')) return;
    google.script.run
      .withSuccessHandler(() => loadData())
      .withFailureHandler((err) => alert(err?.message || String(err)))
      .deleteCaixaValidated(currentToken(), id);
  }


  // ========= Drive helper (converter link de visualização em link direto de imagem) =========
  function toDriveDirectUrl(url) {
    const u = String(url || '');
    // https://drive.google.com/file/d/FILEID/view?...
    const m1 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (m1) return `https://drive.google.com/uc?export=view&id=${m1[1]}`;

    // https://drive.google.com/open?id=FILEID
    const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (m2) return `https://drive.google.com/uc?export=view&id=${m2[1]}`;

    // já direto
    if (u.includes('drive.google.com/uc?export=view')) return u;

    return u;
  }

  // ========= Escape helpers =========
  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str) {
    // para inserir em onclick com segurança
    return String(str ?? '').replaceAll("'", "\\'");
  }

  // Boot
  
  // Inicialização do mapa após login (evita mapa em branco no iOS/Safari)
  function scheduleMapInit(){
    // espera fechar modal + estabilizar layout
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        setTimeout(()=>{
          try { safeInit(); } catch(e) {}
          // força recalcular tamanho do Leaflet
          setTimeout(()=>{
            try{
              if(window.__maplibreMap && window.__maplibreMap.invalidateSize){
                window.__maplibreMap.invalidateSize(true);
                const c = window.__maplibreMap.getCenter ? window.__maplibreMap.getCenter() : null;
                if(c && window.__maplibreMap.panTo){ window.__maplibreMap.panTo(c, {animate:false}); }
              }
            }catch(e){}
          }, 140);
        }, 80);
      });
    });
  }
  window.scheduleMapInit = scheduleMapInit;

function safeInit(){
  if (window.__mapInitInProgress) return;
  window.__mapInitInProgress = true;
  try {
    if (!document.getElementById('map')) throw new Error('Elemento #map não encontrado');
    if (typeof maplibregl === 'undefined' || !maplibregl || !maplibregl.Map) {
      setTimeout(safeInit, 150);
      return;
    }
    initMap();
    window.__mapInitInProgress = false;
  } catch (e) {
      showError(e);
    }
  }

  window.safeInit = safeInit;
  document.addEventListener('DOMContentLoaded', function(){
  bindAuthBar();
  updateAuthBar();
  bootstrapAuth();

  const fab = document.getElementById('fabLegend');
  if (fab){
    fab.addEventListener('click', ()=>{ toggleMinimize('legend'); });
  }

  // Mobile-first: iniciar legenda minimizada em telas pequenas
  if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches){
    const lg = document.getElementById('legend');
    if (lg && !lg.classList.contains('minimized')) lg.classList.add('minimized');
  }
});

// ===== Perto de mim (geolocalização + lista) =====
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btnNearMe');
  const backdrop = document.getElementById('nearmeBackdrop');
  const listEl = document.getElementById('nearmeList');
  const subEl = document.getElementById('nearmeSub');
  const closeBtn = document.getElementById('nearmeClose');

  function openModal() {
    if (!backdrop) return;
    backdrop.style.display = 'flex';
  }
  function closeModal() {
    if (!backdrop) return;
    backdrop.style.display = 'none';
  }
  function fmtKm(m){ return (m/1000).toFixed(2) + ' km'; }

  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (backdrop) backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  function getMapReady(cb){
    const start = Date.now();
    const t = setInterval(() => {
      const theMap = window.__maplibreMap || window.map || (typeof map !== 'undefined' ? map : null);
      if (theMap && typeof theMap.getCenter === 'function') {
        clearInterval(t);
        cb(theMap);
        return;
      }
      if (Date.now() - start > 8000) {
        clearInterval(t);
        try { cb(null); } catch(_) {}
      }
    }, 120);
  }

  function getDisplayName(item){
    const layer = item.layer;
    const p = (layer && layer.feature && layer.feature.properties) ? layer.feature.properties : null;
    const keys = ['CTO_ID','cto_id','ID','id','NOME','nome','CAIXA_ID','caixa_id','COD','cod'];
    if (p) {
      for (const k of keys) {
        if (p[k] != null && String(p[k]).trim() !== '') return String(p[k]).trim();
      }
    }
    return item.label;
  }

  function renderList(theMap, top){
    if (!listEl) return;
    listEl.innerHTML = '';
    top.forEach((item, idx) => {
      const name = getDisplayName(item);
      const btnItem = document.createElement('button');
      btnItem.type = 'button';
      btnItem.className = 'nearme-item';
      btnItem.innerHTML = `
        <div class="nearme-pill">${item.label}</div>
        <div class="nearme-main">
          <div class="name">${name}</div>
          <div class="meta">#${idx+1}</div>
        </div>
        <div class="nearme-dist">${fmtKm(item.dist)}</div>
      `;
      btnItem.addEventListener('click', () => {
        const target = item.layer.getLatLng();
        closeModal();
        theMap.setView(target, 17);
        if (item.layer.openPopup) item.layer.openPopup();
      });
      listEl.appendChild(btnItem);
    });
  }

  if(!btn) return;

  btn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocalização não suportada no dispositivo.');
      return;
    }

    if (subEl) subEl.textContent = 'Obtendo localização...';
    if (listEl) listEl.innerHTML = '';
    openModal();

    getMapReady((theMap) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const user = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          try { theMap.easeTo({ center: [user.lng, user.lat], zoom: Math.max(theMap.getZoom(), 16), duration: 450 }); } catch(_) {}

          // Marker do usuário (MapLibre)
          try {
            if (window._userMarker) { try { window._userMarker.remove(); } catch(_){} }
            const el = document.createElement('div');
            el.style.width = '14px';
            el.style.height = '14px';
            el.style.borderRadius = '999px';
            el.style.background = '#42a5f5';
            el.style.border = '3px solid #1e88e5';
            el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.18)';
            const popup = new maplibregl.Popup({ offset: 10 }).setText('Você está aqui');
            window._userMarker = new maplibregl.Marker({ element: el, anchor: 'center' })
              .setLngLat([user.lng, user.lat])
              .setPopup(popup)
              .addTo(theMap);
            popup.addTo(theMap);
          } catch(_) {}

          const nearest = [];
          function collect(layerGroup, label) {
            if (!layerGroup || !layerGroup.eachLayer) return;
            layerGroup.eachLayer((layer) => {
              if (layer && layer.getLatLng) {
                const ll = layer.getLatLng();
                if (!ll) return;
                const dist = userLatLng.distanceTo(ll);
                nearest.push({ label, dist, layer });
              }
            });
          }

          collect(window.ctosLayer, 'CTO');
          collect(window.caixasLayer, 'Caixa');

          if (!nearest.length) {
            if (subEl) subEl.textContent = 'Nenhum ponto carregado.';
            if (listEl) listEl.innerHTML = '<div style="padding:14px;opacity:.75;">Não encontrei pontos carregados para calcular distância.</div>';
            return;
          }

          nearest.sort((a,b)=>a.dist-b.dist);
          const top = nearest.slice(0, 12);

          if (subEl) subEl.textContent = `Top ${top.length} mais próximos`;
          renderList(theMap, top);
        },
        (err) => {
          closeModal();
          alert('Erro ao obter localização: ' + err.message);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  });
});

</script>
<!-- Modal (Adicionar/Remover Cliente) -->
<div class="modal-backdrop" id="modalBackdrop">
<div aria-labelledby="modalTitle" aria-modal="true" class="modal" role="dialog">
<header>
<div id="modalTitle">Ação</div>
<div aria-label="Fechar" class="close-x" onclick="closeModal()">✕</div>
</header>
<div class="body">
<div class="field">
<div class="label">CTO:</div>
<input class="input" id="modalCto" readonly="" type="text"/>
</div>
<div class="field">
<div class="label">Cliente:</div>
<input class="input" id="modalCliente" placeholder="ex: 1" type="text"/>
</div>
<div class="field">
<div class="label">Usuário:</div>
<input class="input" id="modalUsuario" placeholder="ex: Ryan" type="text"/>
</div>
<div class="field">
<div class="label">Obs:</div>
<input class="input" id="modalObs" placeholder="opcional" type="text"/>
</div>
<div class="msg msg-ok" id="msgOk" style="display:none;"></div>
<div class="msg msg-err" id="msgErr" style="display:none;"></div>
</div>
<div class="footer">
<button class="btn btn-secondary" onclick="closeModal()" type="button">Cancelar</button>
<button class="btn btn-primary" id="modalConfirm" onclick="confirmModal()" type="button">Confirmar</button>
</div>
</div>
</div>
<!-- Modal (Adicionar Caixa / CDO) -->
<div class="modal-backdrop" id="caixaBackdrop">
<div aria-labelledby="caixaTitle" aria-modal="true" class="modal" role="dialog">
<header>
<div id="caixaTitle">Nova Caixa/CDO</div>
<div aria-label="Fechar" class="close-x" onclick="closeCaixaModal()">✕</div>
</header>
<div class="body">
<div class="msg ok" id="caixaMsgOk" style="display:none"></div>
<div class="msg err" id="caixaMsgErr" style="display:none"></div>
<div class="field">
<div class="label">Tipo:</div>
<select class="input" id="caixaTipo">
<option value="CE">CE</option>
<option value="CDO">CDO</option>
</select>
</div>
<div class="field">
<div class="label">ID:</div>
<input class="input" id="caixaId" placeholder="ex: CE-01 ou CDO-02" type="text"/>
</div>
<div class="field">
<div class="label">Obs:</div>
<input class="input" id="caixaObs" placeholder="observação (opcional)" type="text"/>
</div>
<div class="field">
<div class="label">Foto (opcional):</div>
<input accept="image/*" class="input" id="caixaImg" onchange="onCaixaImgPicked(this)" type="file"/>
</div>
<div class="field">
<img alt="Prévia" id="caixaImgPreview" style="display:none; max-width:100%; border-radius:10px; border:1px solid rgba(0,0,0,0.08);"/>
</div>
</div>
<footer>
<button class="btn" onclick="closeCaixaModal()">Cancelar</button>
<button class="btn btn-primary" id="caixaConfirm" onclick="confirmCaixaModal()">Confirmar</button>
</footer>
</div>
</div>
<!-- Near Me (Geolocalização) -->
<button id="btnNearMe" style="
  position: fixed;
  right: 16px;
  bottom: 80px;
  z-index: 9999;
  width: 58px;
  height: 58px;
  border-radius: 50%;
  border: none;
  background: #1e88e5;
  color: #fff;
  font-size: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer;
" title="Perto de mim">📍</button>
<!-- Modal: Perto de mim -->
<div aria-labelledby="nearmeTitle" aria-modal="true" class="nearme-modal-backdrop" id="nearmeBackdrop" role="dialog">
<div class="nearme-modal">
<header>
<div>
<div class="title" id="nearmeTitle">Perto de mim</div>
<div class="sub" id="nearmeSub">Carregando...</div>
</div>
<button aria-label="Fechar" class="nearme-close" id="nearmeClose">✕</button>
</header>
<div class="nearme-list" id="nearmeList"></div>
</div>
</div>
<script>
(function(){
  function qs(id){ return document.getElementById(id); }

  function openDrawer(){
    var drawer = qs('drawer');
    var ov = qs('drawerOverlay');
    var btn = qs('menuBtn');
    if (!drawer || !ov || !btn) return;
    drawer.classList.add('open');
    ov.classList.add('open');
    btn.classList.add('hidden');
    btn.setAttribute('aria-expanded', 'true');
    ov.setAttribute('aria-hidden', 'false');
  }

  function closeDrawer(){
    var drawer = qs('drawer');
    var ov = qs('drawerOverlay');
    var btn = qs('menuBtn');
    if (!drawer || !ov || !btn) return;
    drawer.classList.remove('open');
    ov.classList.remove('open');
    btn.classList.remove('hidden');
    btn.setAttribute('aria-expanded', 'false');
    ov.setAttribute('aria-hidden', 'true');
  }

  function movePanelsIntoDrawer(){
  var content = qs('drawerContent');
  if (!content) return;

  function mkSection(title, icon, el, open){
    var details = document.createElement('details');
    details.className = 'drawer-sec';
    if (open) details.setAttribute('open','open');

    var summary = document.createElement('summary');
    summary.innerHTML =
      '<div class="sec-left">' +
        '<div class="sec-ico" aria-hidden="true">'+ icon +'</div>' +
        '<div class="sec-title">'+ title +'</div>' +
      '</div>' +
      '<div class="sec-right" aria-hidden="true">›</div>';

    var body = document.createElement('div');
    body.className = 'drawer-sec-body';

    // Normaliza painel dentro do drawer
    el.classList.add('in-drawer');

    body.appendChild(el);
    details.appendChild(summary);
    details.appendChild(body);
    content.appendChild(details);
  }

  // Limpa (caso recarregue)
  while (content.firstChild) content.removeChild(content.firstChild);

  // Ordem e títulos profissionais
  var dash = qs('dash');
  if (dash) mkSection('Resumo', '📊', dash, true);

  var controls = qs('controls');
  if (controls) mkSection('Filtros', '🎛️', controls, true);


  // Rotas (Admin)
  try{
    if (typeof isAdmin_ === 'function' && isAdmin_()){
      var rotPanel = document.getElementById('rotasAdminPanel');
      if (!rotPanel) rotPanel = buildRotasPanelEl_();
      mkSection('Rotas', '🧵', rotPanel, false);
      // bind + populate from current data (if available)
      setTimeout(function(){
        try{ bindRotasAdminUI_(); }catch(_){ }
        try{ refreshRotasSelect_(window.__DATA__||{}); }catch(_){ }
      }, 50);
    }
  }catch(_){ }

  // USER / AUTH goes to the bottom of the menu (fixed footer)
  var auth = document.querySelector('.auth-bar');
  var footerEl = qs('drawerFooter');
  if (footerEl) footerEl.innerHTML = '';
  
  // Move UI scale slider (textScaleRange) into a fixed box above the user area
  try{
    var range = document.getElementById('textScaleRange');
    if (range && footerEl){
      var row = range.closest('.row') || range.parentElement;
      if (row){
        row.classList.add('ui-scale-row');
        // Build fixed container
        var box = document.getElementById('uiScaleBox');
        if (!box){
          box = document.createElement('div');
          box.id = 'uiScaleBox';
        } else {
          box.innerHTML = '';
        }
        // Update label text if present
        var lbl = row.querySelector('.label');
        if (lbl) lbl.textContent = 'Escala do HUD';
        // Put the row inside the box
        box.appendChild(row);
        // Insert box before auth
        footerEl.appendChild(box);
      }
    }
  }catch(_){}
if (auth){
    auth.classList.add('in-drawer','auth-in-drawer');
    // Move auth into a dedicated footer outside the scroll area
    if (footerEl){
      footerEl.appendChild(auth);
    } else {
      // Fallback: stick it to the end of the drawer content
      content.appendChild(auth);
    }
  }
}

function bind(){
    var btn = qs('menuBtn');
    var closeBtn = qs('drawerClose');
    var ov = qs('drawerOverlay');
    if (btn) btn.addEventListener('click', openDrawer);
    if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (ov) ov.addEventListener('click', closeDrawer);

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closeDrawer();
    });

    // Swipe simples (puxa da esquerda / fecha)
    var startX = null;
    window.addEventListener('touchstart', function(e){
      if (!e.touches || !e.touches[0]) return;
      startX = e.touches[0].clientX;
    }, {passive:true});

    window.addEventListener('touchend', function(e){
      if (startX === null) return;
      var endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : startX;
      var dx = endX - startX;
      startX = null;

      var drawer = qs('drawer');
      var isOpen = drawer && drawer.classList.contains('open');

      // abre: swipe -> direita a partir da borda esquerda
      if (!isOpen && dx > 70 && endX < 180) openDrawer();

      // fecha: swipe -> esquerda dentro do drawer
      if (isOpen && dx < -70) closeDrawer();
    }, {passive:true});
  }

  // Rodar após DOM pronto
  window.addEventListener('DOMContentLoaded', function(){
    movePanelsIntoDrawer();
    try{ if (typeof initTextScaleSlider==='function') initTextScaleSlider(); }catch(_){ }
    bind();
  });
})();
</script>

<script>





/* ===== V15: admin close (hide) + reliable reopen + rotas scroll ===== */
(function(){
  function getBackdrop(){ return document.querySelector('.admin-backdrop'); }
  function getModal(){ return document.querySelector('.admin-modal'); }

  function hideAdmin(){
    const bd = getBackdrop();
    const modal = getModal();
    if (modal){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    if (bd){
      bd.style.display = 'none';
      bd.style.pointerEvents = 'none';
      bd.setAttribute('aria-hidden','true');
      bd.classList.add('hidden');
    }
    document.body.classList.remove('modal-open');
  }

  function showAdmin(){
    const bd = getBackdrop();
    const modal = getModal();
    if (bd){
      bd.style.display = '';
      bd.style.pointerEvents = 'auto';
      bd.removeAttribute('aria-hidden');
      bd.classList.remove('hidden');
    }
    if (modal){
      modal.style.display = '';
      modal.removeAttribute('aria-hidden');
    }
  }

  // Wrap existing open/close if present
  const _open = window.openAdminModal;
  if (typeof _open === 'function' && !_open.__wrapped){
    window.openAdminModal = function(){
      const r = _open.apply(this, arguments);
      // make sure shown
      showAdmin();
      // bind close button and scroll hooks
      ensureCloseButton();
      bindRotasScroll();
      return r;
    };
    window.openAdminModal.__wrapped = true;
  }

  const _close = window.closeAdminModal;
  if (typeof _close === 'function' && !_close.__wrapped){
    window.closeAdminModal = function(){
      let r;
      try{ r = _close.apply(this, arguments); }catch(_){}
      hideAdmin();
      return r;
    };
    window.closeAdminModal.__wrapped = true;
  }

  function closeAdminModalSafe(){
    try{
      if (typeof window.closeAdminModal === 'function'){ window.closeAdminModal(); return; }
    }catch(_){}
    hideAdmin();
  }

  // ESC closes
  document.addEventListener('keydown', function(ev){
    if (ev.key === 'Escape') closeAdminModalSafe();
  });

  // Backdrop click closes (only outside modal)
  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (t && t.classList && t.classList.contains('admin-backdrop')){
      closeAdminModalSafe();
    }
  }, true);

  function ensureCloseButton(){
    const modal = getModal();
    if (!modal) return;
    let btn = modal.querySelector('.admin-close');
    if (!btn){
      btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'admin-close';
      btn.setAttribute('aria-label','Fechar');
      modal.appendChild(btn);
    }
    btn.onclick = closeAdminModalSafe;
  }

  function bindRotasScroll(){
    const p = document.getElementById('rotasAdminPanel');
    if(!p) return;
    // Allow wheel/touch to scroll inside panel; stop propagation to map
    p.addEventListener('wheel', function(ev){ ev.stopPropagation(); }, {passive:true});
    p.addEventListener('touchmove', function(ev){ ev.stopPropagation(); }, {passive:true});
  }

  const obs = new MutationObserver(function(){
    ensureCloseButton();
    bindRotasScroll();
  });
  obs.observe(document.documentElement, { childList:true, subtree:true });

  window.addEventListener('load', function(){
    ensureCloseButton();
    bindRotasScroll();
  });

  // If backdrop exists but modal hidden, keep it non-blocking
  setInterval(function(){
    const bd = getBackdrop();
    const modal = getModal();
    if (bd && (!modal || modal.style.display === 'none')){
      bd.style.pointerEvents = 'none';
      bd.style.display = 'none';
      bd.classList.add('hidden');
    }
  }, 1200);
})();

</script>





<script>
/* ===== V19: fix points parsing when textarea contains literal \n ===== */
(function(){
  // Try to locate the existing parser by name; if not found, patch save handler extraction.
  function normalizeText(t){ return String(t||'').replace(/\\n/g, '\n'); }


  // Patch ROUTE_ADMIN.getPointsFromText if exists
  if (window.ROUTE_ADMIN && typeof window.ROUTE_ADMIN.getPointsFromTextarea === 'function'){
    const orig = window.ROUTE_ADMIN.getPointsFromTextarea;
    window.ROUTE_ADMIN.getPointsFromTextarea = function(text){
      return orig.call(this, normalizeText(text));
    };
  }

  // Patch global helper if exists
  if (typeof window.parsePointsFromTextarea_ === 'function'){
    const orig = window.parsePointsFromTextarea_;
    window.parsePointsFromTextarea_ = function(text){
      return orig(normalizeText(text));
    };
  }
})();
</script>

</body>
</html>
