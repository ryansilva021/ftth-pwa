<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTTH-PWA Mapa</title>

  <script>
    // Configura√ß√µes do projeto (SEM LOGIN por enquanto)
    window.WORKER_URL = "https://ftth-pwa.lupiing37.workers.dev";
    window.__BUILD_ID__ = "FTTH-2026-02-25-MAP-NOLOGIN";

    // Aten√ß√£o: MapLibre usa [lng, lat] no center
    window.PROJECT_CENTER = [-43.166, -22.412];
    window.PROJECT_ZOOM = 12;
  </script>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;background:#111a2e}
    .left{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;color:#9ca3af}
    button{padding:8px 10px;border:none;border-radius:8px;background:#22c55e;color:#000;font-weight:700;cursor:pointer}
    #map{width:100vw;height:calc(100vh - 56px)}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div><b>üó∫Ô∏è FTTH Mapa</b></div>
      <div class="badge" id="badge">modo sem login</div>
    </div>
    <div class="right">
      <!-- Placeholder (sem login por enquanto) -->
      <button id="btnLogin" style="display:none;">Login</button>
    </div>
  </header>

  <div id="map"></div>

  <script>
    // Garante que tudo rode ap√≥s o DOM existir (evita badge=null e tela branca)
    window.addEventListener("DOMContentLoaded", () => {
      const badge = document.getElementById("badge");
      if (badge) badge.textContent = `BUILD: ${window.__BUILD_ID__}`;

      function initMap() {
        const map = new maplibregl.Map({
          container: "map",
          style: {
            version: 8,
            sources: {
              osm: {
                type: "raster",
                tiles: [
                  "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png",
                ],
                tileSize: 256,
                attribution: "&copy; OpenStreetMap contributors",
              },
            },
            layers: [{ id: "osm", type: "raster", source: "osm" }],
          },
          center: window.PROJECT_CENTER,
          zoom: window.PROJECT_ZOOM,
          attributionControl: true,
        });

        map.addControl(new maplibregl.NavigationControl(), "top-right");

        map.on("load", async () => {
          try {
            const res = await fetch(`${window.WORKER_URL}/api/ctos`);
            if (!res.ok) throw new Error(`Worker respondeu ${res.status}`);
            const ctos = await res.json();

            console.log("CTOs carregadas:", ctos.length);

            const geojson = {
              type: "FeatureCollection",
              features: (ctos || []).map((cto) => ({
                type: "Feature",
                geometry: { type: "Point", coordinates: [cto.lng, cto.lat] },
                properties: {
                  cto_id: cto.cto_id ?? "",
                  bairro: cto.bairro ?? "",
                  rua: cto.rua ?? "",
                  capacidade: cto.capacidade ?? "",
                },
              })),
            };

            // Evita duplicar source/layer em hot reload
            if (map.getSource("ctos")) {
              map.getSource("ctos").setData(geojson);
            } else {
              map.addSource("ctos", { type: "geojson", data: geojson });

              map.addLayer({
                id: "ctos-layer",
                type: "circle",
                source: "ctos",
                paint: {
                  "circle-radius": 6,
                  "circle-color": "#22c55e",
                  "circle-stroke-width": 1,
                  "circle-stroke-color": "#000",
                },
              });

              map.on("click", "ctos-layer", (e) => {
                const p = e.features?.[0]?.properties || {};
                new maplibregl.Popup()
                  .setLngLat(e.lngLat)
                  .setHTML(
                    `<b>${p.cto_id || ""}</b><br>
                     Bairro: ${p.bairro || ""}<br>
                     Rua: ${p.rua || ""}<br>
                     Capacidade: ${p.capacidade || ""}`
                  )
                  .addTo(map);
              });

              map.on("mouseenter", "ctos-layer", () => (map.getCanvas().style.cursor = "pointer"));
              map.on("mouseleave", "ctos-layer", () => (map.getCanvas().style.cursor = ""));
            }
          } catch (err) {
            console.error("Erro ao carregar CTOs:", err);
            if (badge) badge.textContent = `ERRO: ${String(err?.message ?? err)}`;
          }
        });

        return map;
      }

      initMap();
    });
  </script>
</body>
</html>
