<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FTTH-PWA Mapa</title>

  <script>
    window.WORKER_URL = "https://ftth-pwa.lupiing37.workers.dev";
    window.__BUILD_ID__ = "FTTH-2026-02-25-MOBILE-GPS-REGISTRO-STEP3-AUTOSYNC";
window.PROJECT_CENTER = [-43.166, -22.412]; // [lng, lat]
    window.PROJECT_ZOOM = 12;
  </script>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --muted:#9ca3af;
      --border:#1f2a44;
      --ok:#22c55e;
      --warn:#f59e0b;
      --blue:#3b82f6;
      --purple:#a855f7;
      --orange:#f97316;
      --radius:16px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px calc(10px + var(--safe-top));
      background:var(--panel); position:sticky; top:0; z-index:5;
    }
    .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;color:var(--muted);max-width:65vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{
      display:flex;gap:6px;align-items:center;
      font-size:12px;color:#cbd5e1;background:var(--bg);
      border:1px solid var(--border);border-radius:999px;padding:8px 12px;
      min-height:40px;
    }
    .chip input{transform:scale(1.2); accent-color: var(--ok);}
    #map{width:100vw;height:calc(100vh - 64px);}

    /* Floating buttons (mobile-first) */
    .fabCol{
      position:fixed; right:14px; bottom:calc(14px + var(--safe-bottom)); z-index:6;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab{
      width:52px;height:52px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(17,26,46,.92); color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      font-size:20px;
    }
    .fab:active{transform:scale(0.98)}
    .fabSmall{width:44px;height:44px;font-size:18px}

    /* Bottom sheet */
    .sheetBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      z-index:10; display:none;
    }
    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      z-index:11; display:none;
      background:rgba(17,26,46,.98); border-top:1px solid rgba(255,255,255,.10);
      border-radius: 20px 20px 0 0;
      padding:12px 12px calc(12px + var(--safe-bottom));
      max-height:78vh; overflow:auto;
    }
    .sheetHandle{width:44px;height:5px;border-radius:99px;background:rgba(255,255,255,.25);margin:6px auto 10px}
    .sheetTitle{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sheetTitle h3{margin:0;font-size:16px}
    .sheetTitle .x{font-size:22px;line-height:1; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15)}
    .kv{font-size:12px;color:var(--muted);margin:6px 0 12px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.15); color:#fff; font-weight:700; min-height:44px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btnPrimary{background:var(--ok); color:#001b09; border:none;}
    .btnWarn{background:var(--warn); color:#1b1200; border:none;}
    .btnBlue{background:var(--blue); color:#00112a; border:none;}
    .btn:active{transform:scale(0.99)}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:#cbd5e1}
    .field input,.field select,.field textarea{
      border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22); color:#fff; padding:12px 12px;
      font-size:15px; outline:none;
    }
    .field textarea{min-height:84px; resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    a{color:#93c5fd}

    /* MapLibre popup readability on mobile */
    .maplibregl-popup-content{
      border-radius:14px !important;
      padding:12px 12px !important;
      font-size:14px !important;
      line-height:1.35 !important;
      max-width: 80vw !important;
    }
  
    /* Login overlay */
    .login-screen{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(2,6,23,.82);
      backdrop-filter: blur(10px);
      z-index:99999;
      padding:24px;
    }
    .login-screen.show{ display:flex; }
    .login-card{
      width:min(380px, 92vw);
      border-radius:18px;
      padding:18px 16px 14px;
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(2,6,23,.92));
      border:1px solid rgba(148,163,184,.18);
      box-shadow:0 20px 70px rgba(0,0,0,.55);
    }
    .login-title{ color:#fff; font-weight:900; font-size:18px; letter-spacing:.2px; }
    .login-sub{ color:rgba(226,232,240,.78); margin:6px 0 14px; font-size:13px; }
    .login-label{ display:block; color:rgba(226,232,240,.82); font-size:12px; margin:10px 0 6px; }
    .login-input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.65);
      color:#fff;
      outline:none;
      font-size:14px;
    }
    .login-input:focus{ border-color: rgba(59,130,246,.5); box-shadow:0 0 0 4px rgba(59,130,246,.18); }
    .login-btn{
      margin-top:14px;
      width:100%;
      padding:12px 12px;
      border:none;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(34,197,94,1), rgba(22,163,74,1));
      color:#04110a;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(34,197,94,.25);
    }
    .login-btn:active{ transform: translateY(1px); }
    .login-error{ min-height:18px; margin-top:10px; color:#fca5a5; font-size:12px; text-align:center; }

    header .right{ display:flex; align-items:center; gap:10px; }
    .userpill{
      display:flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.90);
      font-size:12px;
      white-space:nowrap;
    }
    .logoutBtn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(239,68,68,.12);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .logoutBtn:hover{ filter:brightness(1.08); }
</style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="login-screen" class="login-screen" aria-hidden="true">
    <div class="login-card">
      <div class="login-title">FTTH ‚Ä¢ Login</div>
      <div class="login-sub">Entre para acessar o mapa</div>

      <label class="login-label" for="login-user">Usu√°rio</label>
      <input id="login-user" class="login-input" autocomplete="username" placeholder="ex: admin" />

      <label class="login-label" for="login-pass">Senha</label>
      <input id="login-pass" class="login-input" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

      <button id="login-btn" class="login-btn">Entrar</button>
      <div id="login-error" class="login-error"></div>
    </div>
  </div>

  <header>
    <div class="left">
      <div><b>üó∫Ô∏è FTTH</b></div>
      <div class="badge" id="badge">mobile</div>
      <div class="controls">
        <label class="chip"><input id="toggleCTOs" type="checkbox" checked /> CTOs</label>
        <label class="chip"><input id="toggleCaixas" type="checkbox" checked /> Caixas</label>
        <label class="chip"><input id="toggleRotas" type="checkbox" checked /> Rotas</label>
      </div>
    </div>
    <div class="right">
      <div class="userpill" id="userPill">üë§ <span id="userName">‚Äî</span></div>
      <button class="logoutBtn" id="btnLogout" title="Sair">Sair</button>
    </div>
  </header>

  <div id="map"></div>

  <!-- Floating actions -->
  <div class="fabCol" aria-label="A√ß√µes">
    <div class="fab" id="btnGPS" title="Minha localiza√ß√£o">üìç</div>
    <div class="fab fabSmall" id="btnFollow" title="Seguir GPS (liga/desliga)">üß≠</div>
    <div class="fab fabSmall" id="btnPend" title="Pendentes">üßæ</div>
    <div class="fab fabSmall" id="btnSync" title="Sincronizar pendentes">üîÑ</div>
    <div class="fab fabSmall" id="btnReg" title="Registrar (√∫ltimo selecionado)">‚úçÔ∏è</div>
  </div>

  <!-- Bottom sheet + backdrop -->
  <div class="sheetBackdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHandle"></div>
    <div class="sheetTitle">
      <h3 id="sheetHeading">Detalhes</h3>
      <div class="x" id="sheetClose" role="button" aria-label="Fechar">‚úï</div>
    </div>
    <div class="kv" id="sheetSub"></div>
    <div id="sheetBody"></div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const IS_FILE_ORIGIN = (location.protocol === "file:" || location.origin === "null");
      const badge = document.getElementById("badge");
      if (badge) badge.textContent = `BUILD: ${window.__BUILD_ID__}`;

      const elToggleCTOs = document.getElementById("toggleCTOs");
      const elToggleCaixas = document.getElementById("toggleCaixas");
      const elToggleRotas = document.getElementById("toggleRotas");

      const btnGPS = document.getElementById("btnGPS");
      const btnFollow = document.getElementById("btnFollow");
      const btnPend = document.getElementById("btnPend");
      const btnSync = document.getElementById("btnSync");
      const btnReg = document.getElementById("btnReg");

      const sheet = document.getElementById("sheet");
      const sheetBackdrop = document.getElementById("sheetBackdrop");
      const sheetClose = document.getElementById("sheetClose");
      const sheetHeading = document.getElementById("sheetHeading");
      const sheetSub = document.getElementById("sheetSub");
      const sheetBody = document.getElementById("sheetBody");

      // Estado
      let selected = null; // {type:'cto'|'caixa'|'rota', props, lngLat}
      let map = null;

      // Movimenta√ß√µes por CTO (para lista de clientes online + hist√≥rico)
      let movByCto = new Map(); // cto_id -> [{ts,tipo,cliente,usuario,obs,raw}]
      let onlineClientsByCto = new Map(); // cto_id -> [{cliente, last_ts, last_tipo, usuario, obs}]

      // GPS
      let watchId = null;
      let followOn = false;
      let userMarker = null;

      function openSheet(title, subtitle, bodyHTML) {
        sheetHeading.textContent = title || "Detalhes";
        sheetSub.innerHTML = subtitle || "";
        sheetBody.innerHTML = bodyHTML || "";
        sheetBackdrop.style.display = "block";
        sheet.style.display = "block";
      }

      function showPopup(title, message) {
        openSheet(title || "Aviso", message || "", `
          <div class="btnRow">
            <button class="btn btnPrimary" id="btnOk">OK</button>
          </div>
        `);
        const ok = document.getElementById("btnOk");
        if (ok) ok.onclick = closeSheet;
      }

      let offlinePopupShown = false;
      function onBecameOffline() {
        if (offlinePopupShown) return;
        offlinePopupShown = true;
        if (badge) badge.textContent = "üî¥ Offline (registros ser√£o salvos no aparelho)";
        showPopup("Sem internet", "Voc√™ est√° offline. Pode continuar registrando ‚Äî os registros ficam salvos no aparelho e ser√£o sincronizados quando a internet voltar.");
      }
      function onBecameOnline() {
        offlinePopupShown = false;
        if (IS_FILE_ORIGIN) {
          if (badge) badge.textContent = "üü¢ Online (sync desativado em file://)";
          return;
        }
        if (badge) badge.textContent = "üü¢ Online ‚Äî sincronizando...";
        syncQueue({ silentIfEmpty: true, showPopups: false });
      }

      function closeSheet() {
        sheetBackdrop.style.display = "none";
        sheet.style.display = "none";
      }
      sheetBackdrop.addEventListener("click", closeSheet);
      sheetClose.addEventListener("click", closeSheet);

      function setLayerVisible(layerId, visible) {
        if (!map?.getLayer(layerId)) return;
        map.setLayoutProperty(layerId, "visibility", visible ? "visible" : "none");
      }

      function wireToggles() {
        elToggleCTOs?.addEventListener("change", () => {
          const on = elToggleCTOs.checked;
          setLayerVisible("ctos-glow", on);
          setLayerVisible("ctos-x-outline", on);
          setLayerVisible("ctos-x", on);
          setLayerVisible("ctos-x-blink-outline", on);
          setLayerVisible("ctos-x-blink", on);
        });
        elToggleCaixas?.addEventListener("change", () => {
          const on = elToggleCaixas.checked;
          setLayerVisible("caixas-outline", on);
          setLayerVisible("caixas-layer", on);
        });
        elToggleRotas?.addEventListener("change", () => setLayerVisible("rotas-layer", elToggleRotas.checked));
      }

      
      // =========================
      // AUTH (Login via Worker)
      // =========================
      const AUTH_TOKEN_KEY = "ftth_token";
      const AUTH_USER_KEY  = "ftth_auth_user";
      const AUTH_ROLE_KEY  = "ftth_auth_role";

      function getAuthToken(){ return localStorage.getItem(AUTH_TOKEN_KEY) || ""; }
      function getAuthUser(){ return localStorage.getItem(AUTH_USER_KEY) || ""; }
      function getAuthRole(){ return localStorage.getItem(AUTH_ROLE_KEY) || "user"; }

      function setAuth(token, user, role){
        if (token) localStorage.setItem(AUTH_TOKEN_KEY, token);
        if (user)  localStorage.setItem(AUTH_USER_KEY, user);
        if (role)  localStorage.setItem(AUTH_ROLE_KEY, role);
      }
function applyPermissionsToUI(){
  const role = getAuthRole();
  const isAdmin = role === "admin";
  document.documentElement.dataset.role = role;
  // Esconde/desabilita tudo marcado como admin-only (se existir no HTML)
  document.querySelectorAll("[data-requires-admin]").forEach((el)=>{
    el.style.display = isAdmin ? "" : "none";
  });
}


      function clearAuth(){
        localStorage.removeItem(AUTH_TOKEN_KEY);
        // mant√©m o nome do user salvo para facilitar o pr√≥ximo login
      }

      function showLogin(msg){
        const el = document.getElementById("login-screen");
        const err = document.getElementById("login-error");
        if (err) err.textContent = msg || "";
        if (el) {
          el.classList.add("show");
          el.setAttribute("aria-hidden", "false");
        }
        // Prefill
        const u = document.getElementById("login-user");
        if (u && !u.value) u.value = getAuthUser() || localStorage.getItem("ftth_user") || "";
        setTimeout(()=> document.getElementById("login-user")?.focus(), 50);
      }

      function hideLogin(){
        const el = document.getElementById("login-screen");
        const err = document.getElementById("login-error");
        if (err) err.textContent = "";
        if (el) {
          el.classList.remove("show");
          el.setAttribute("aria-hidden", "true");
        }
      }

      function authHeaders(extra={}){
        const t = getAuthToken();
        const h = { ...extra };
        if (t) h["Authorization"] = "Bearer " + t;
        return h;
      }

      async function authFetch(url, opts={}){
        const headers = authHeaders(opts.headers || {});
        const res = await fetch(url, { ...opts, headers });
        if (res.status === 401){
          // token inv√°lido/expirado
          clearAuth();
          showLogin("Sess√£o expirada. Fa√ßa login novamente.");
        }
        return res;
      }

async function fetchMeRole(){
  try{
    const res = await authFetch(`${window.WORKER_URL}/api/me`);
    if (!res.ok) return null;
    const data = await res.json().catch(()=>null);
    const role = String(data?.role || "user");
    localStorage.setItem(AUTH_ROLE_KEY, role);
    return role;
  }catch(_){ return null; }
}

      async function doLogin(){
        const btn = document.getElementById("login-btn");
        const err = document.getElementById("login-error");
        const uEl = document.getElementById("login-user");
        const pEl = document.getElementById("login-pass");

        const user = (uEl?.value || "").trim();
        const password = (pEl?.value || "").trim();

        if (!user || !password){
          if (err) err.textContent = "Informe usu√°rio e senha.";
          return;
        }

        if (btn) { btn.disabled = true; btn.textContent = "Entrando..."; }
        if (err) err.textContent = "";

        try{
          const res = await fetch(`${window.WORKER_URL}/api/login`, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ user, password })
          });
          const data = await res.json().catch(()=> ({}));
          if (data && data.ok && data.token){
            setAuth(data.token, user, data.role || "user");
            // mant√©m compat com fluxo antigo
            localStorage.setItem("ftth_user", user);
            hideLogin();
            const el = document.getElementById('userName');
            if (el) el.textContent = `${user} (${getAuthRole()})`;
            // inicia app
            if (!window.__APP_STARTED__){
              window.__APP_STARTED__ = true;
              document.getElementById("login-btn")?.addEventListener("click", doLogin);
      document.getElementById("login-pass")?.addEventListener("keydown", (e)=>{ if (e.key==="Enter") doLogin(); });
      document.getElementById("login-user")?.addEventListener("keydown", (e)=>{ if (e.key==="Enter") doLogin(); });

      // Start only if authenticated
      if (!checkAuthOrShowLogin()) return;
      // best-effort: atualiza role via /api/me
      fetchMeRole().then(()=>{
        const u = getAuthUser() || localStorage.getItem('ftth_user') || '‚Äî';
        const el = document.getElementById('userName');
        if (el) el.textContent = `${u} (${getAuthRole()})`;
        applyPermissionsToUI();
      });
      window.__APP_STARTED__ = true;
      initMap();
            }
            // limpa senha do campo
            if (pEl) pEl.value = "";
          } else {
            if (err) err.textContent = "Usu√°rio ou senha inv√°lidos.";
          }
        }catch(e){
          if (err) err.textContent = "Falha ao conectar. Verifique sua internet.";
        } finally{
          if (btn) { btn.disabled = false; btn.textContent = "Entrar"; }
        }
      }

      function doLogout(){
        clearAuth();
        showLogin("Voc√™ saiu. Fa√ßa login para continuar.");
      }

      function checkAuthOrShowLogin(){
        const token = getAuthToken();
        if (!token){
          showLogin("");
          return false;
        }
        hideLogin();
        const u = getAuthUser() || localStorage.getItem('ftth_user') || '‚Äî';
        const el = document.getElementById('userName');
        if (el) el.textContent = `${u} (${getAuthRole()})`;
        applyPermissionsToUI();
        return true;
      }

async function fetchJSON(path) {
        const res = await authFetch(`${window.WORKER_URL}${path}`);
        if (!res.ok) throw new Error(`${path} -> ${res.status}`);
        return await res.json();
      }

      function openExternalNav(lng, lat, label) {
        const ll = `${lat},${lng}`;
        const q = encodeURIComponent(label || "Destino");
        // iOS: Apple Maps works well; Android: Google Maps. We can offer both, default by platform.
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        const apple = `https://maps.apple.com/?daddr=${encodeURIComponent(ll)}&q=${q}`;
        const google = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(ll)}&destination_place_id=&travelmode=driving`;

        // Open best first; also show alternative in sheet
        window.open(isIOS ? apple : google, "_blank", "noopener");
      }

      function showSelectedSheet() {
        if (!selected) {
          openSheet("Nenhuma sele√ß√£o", "Toque em uma CTO/caixa/rota no mapa.", `<div class="hint">Dica: use üìç para achar sua posi√ß√£o.</div>`);
          return;
        }

        const { type, props, lngLat } = selected;

        if (type === "cto") {
          const ctoId = String(props.cto_id || "").trim();
          const title = `CTO ${ctoId || ""}`;
          const subtitle = `üìå ${props.bairro || ""} ‚Ä¢ ${props.rua || ""}`;

          const online = (onlineClientsByCto.get(ctoId) || []);
          const hist = (movByCto.get(ctoId) || []);

          const onlineHTML = online.length ? `
            <div style="margin-top:12px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:800;">üü¢ Clientes online (${online.length})</div>
                <div class="badge">√∫ltima a√ß√£o por cliente</div>
              </div>
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px;">
                ${online.slice(0, 25).map((c) => `
                  <div style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;">
                    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                      <div><b>${escapeHTML(c.cliente)}</b></div>
                      <div class="badge">${escapeHTML(fmtTs(c.last_ts))}</div>
                    </div>
                    <div class="hint">A√ß√£o: <b>${escapeHTML(String(c.last_tipo||""))}</b>${c.usuario ? ` ‚Ä¢ por <b>${escapeHTML(c.usuario)}</b>` : ""}</div>
                    ${c.obs ? `<div class="hint">üìù ${escapeHTML(c.obs)}</div>` : ``}
                  </div>
                `).join("")}
                ${online.length > 25 ? `<div class="hint">Mostrando 25 de ${online.length}.</div>` : ``}
              </div>
            </div>
          ` : `
            <div style="margin-top:12px;">
              <div style="font-weight:800;">üü¢ Clientes online (0)</div>
              <div class="hint">Nenhum cliente ‚Äúonline‚Äù encontrado para esta CTO (baseado na √∫ltima movimenta√ß√£o por cliente).</div>
            </div>
          `;

          const histHTML = hist.length ? `
            <div style="margin-top:14px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:800;">üßæ Hist√≥rico (${hist.length})</div>
                <div class="badge">mais recente primeiro</div>
              </div>
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px;">
                ${hist.slice(0, 30).map((h) => `
                  <div style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;">
                    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                      <div><b>${escapeHTML(String(h.tipo||""))}</b>${h.cliente ? ` ‚Ä¢ ${escapeHTML(h.cliente)}` : ""}</div>
                      <div class="badge">${escapeHTML(fmtTs(h.ts))}</div>
                    </div>
                    <div class="hint">${h.usuario ? `üë§ ${escapeHTML(h.usuario)}` : "üë§ -"}${h.obs ? ` ‚Ä¢ üìù ${escapeHTML(h.obs)}` : ""}</div>
                  </div>
                `).join("")}
                ${hist.length > 30 ? `<div class="hint">Mostrando 30 de ${hist.length}.</div>` : ``}
              </div>
            </div>
          ` : `
            <div style="margin-top:14px;">
              <div style="font-weight:800;">üßæ Hist√≥rico (0)</div>
              <div class="hint">Ainda n√£o h√° registros de movimenta√ß√£o para esta CTO.</div>
            </div>
          `;

          const body = `
            <div class="btnRow">
              <button class="btn btnBlue" id="goNav">üß≠ Navegar</button>
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">Capacidade: <b>${props.capacidade ?? ""}</b></div>
            ${onlineHTML}
            ${histHTML}
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goNav").onclick = () => openExternalNav(lngLat.lng, lngLat.lat, title);
          document.getElementById("goReg").onclick = () => openRegistro("MOVIMENTACOES", ctoId || "");
          return;
        }


        if (type === "caixa") {
          const title = `${props.tipo || "Caixa"} ${props.id || ""}`;
          const subtitle = props.obs ? `üìù ${escapeHTML(props.obs)}` : `üìå ${props.dt_criacao || ""}`;
          const img = props.img_url ? `<a href="${props.img_url}" target="_blank" rel="noopener">Ver imagem</a>` : "";
          const body = `
            <div class="btnRow">
              <button class="btn btnBlue" id="goNav">üß≠ Navegar</button>
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">${img}</div>
            <div class="hint">Criado: ${props.dt_criacao || ""}<br>Atualizado: ${props.dt_atualizacao || ""}</div>
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goNav").onclick = () => openExternalNav(lngLat.lng, lngLat.lat, title);
          document.getElementById("goReg").onclick = () => openRegistro("LOG_EVENTOS", `${props.tipo || "CAIXA"}:${props.id || ""}`);
          return;
        }

        if (type === "rota") {
          const title = `Rota ${props.rota_id || ""}`;
          const subtitle = `Pontos: ${props.pontos || ""} ‚Ä¢ Tipos: ${escapeHTML(String(props.tipos || ""))}`;
          const body = `
            <div class="btnRow">
              <button class="btn btnPrimary" id="goReg">‚úçÔ∏è Registrar</button>
            </div>
            <div class="hint">Peso m√©dio: ${props.peso_medio || ""}</div>
          `;
          openSheet(title, subtitle, body);
          document.getElementById("goReg").onclick = () => openRegistro("LOG_EVENTOS", `ROTA:${props.rota_id || ""}`);
        }
      }

      function escapeHTML(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function normTs(v) {
        const s = String(v ?? "").trim();
        if (!s) return "";
        return s;
      }
      function pick(o, keys) {
        for (const k of keys) {
          if (o && o[k] != null && String(o[k]).trim() !== "") return o[k];
        }
        return "";
      }
      function normalizeMov(mv) {
        const cto_id = String(pick(mv, ["cto_id","CTO_ID","cto","CTO","ctoId"])).trim();
        const tipo = String(pick(mv, ["tipo","Tipo","action","ACTION"])).trim().toUpperCase();
        const cliente = String(pick(mv, ["cliente","Cliente","client","CLIENTE"])).trim();
        const usuario = String(pick(mv, ["usuario","Usuario","user","USER"])).trim();
        const obs = String(pick(mv, ["observacao","Observacao","obs","OBS","details","DETAILS"])).trim();
        const ts = normTs(pick(mv, ["data","DATA","ts","TS","created_at","createdAt","dt_criacao","dt","timestamp"]));
        return { cto_id, tipo, cliente, usuario, obs, ts, raw: mv };
      }
      function fmtTs(ts) {
        const s = String(ts || "");
        if (!s) return "";
        return s.replace("T"," ").slice(0,16);
      }


      // Registro (offline-first): salva em localStorage (fila) e mostra export
      
      async function ensureSubmitKey() {
        const embedded = (window.SUBMIT_KEY || "").trim();
        if (embedded) return embedded;

        let k = localStorage.getItem("ftth_submit_key") || "";
        if (!k) {
          k = prompt("Chave de sincroniza√ß√£o (SUBMIT_KEY):") || "";
          k = k.trim();
          if (k) localStorage.setItem("ftth_submit_key", k);
        }
        return k;
      }

      async function syncQueue(opts = {}) {
        const { silentIfEmpty = false, showPopups = false } = opts;
        if (IS_FILE_ORIGIN) {
          if (badge) badge.textContent = "‚ö†Ô∏è Sync desativado em arquivo local (abra via https)";
          if (showPopups) showPopup("Sync desativado", "Voc√™ est√° abrindo o app como arquivo local (file://). Para sincronizar sem erros de CORS, abra pelo endere√ßo https do Pages.");
          return;
        }
        const q = getQueue();
        if (!q.length) {
          if (!silentIfEmpty) {
            if (badge) badge.textContent = "Sem pend√™ncias para sincronizar";
            if (showPopups) showPopup("Sem pend√™ncias", "N√£o h√° registros pendentes para sincronizar.");
          }
          return;
        }

        if (!navigator.onLine) {
          if (badge) badge.textContent = "üî¥ Offline ‚Äî pend√™ncias mantidas";
          if (showPopups) onBecameOffline();
          return;
        }

        const key = await ensureSubmitKey();
        if (!key) {
          if (badge) badge.textContent = "Sync cancelado (sem chave)";
          if (showPopups) showPopup("Chave ausente", "SUBMIT_KEY n√£o configurada no app.");
          return;
        }

        let sent = 0;
        let failed = 0;
        const nextQueue = [];

        if (badge) badge.textContent = `Sincronizando ${q.length}...`;

        for (let i = 0; i < q.length; i++) {
          const item = q[i];
          try {
            const res = await fetch(`${window.WORKER_URL}/api/submit`, {
              method: "POST",
              headers: authHeaders({ "content-type": "application/json" }),
              body: JSON.stringify({ items: [item] })
            });

            const txt = await res.text();
            let data = null;
            try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

            if (!res.ok || data?.ok === false) throw new Error(data?.error || `HTTP ${res.status}`);
            sent++;
          } catch (err) {
            failed++;
            nextQueue.push({ ...item, last_error: String(err?.message ?? err), last_error_at: new Date().toISOString() });
          }
        }

        setQueue(nextQueue);

        if (failed === 0) {
          if (badge) badge.textContent = `‚úÖ Sync OK ‚Ä¢ enviados: ${sent}`;
          if (showPopups) showPopup("Sincronizado", `Enviados: ${sent}.`);
        } else {
          if (badge) badge.textContent = `‚ö†Ô∏è Sync parcial ‚Ä¢ enviados: ${sent} ‚Ä¢ falhas: ${failed}`;
          if (showPopups) showPopup("Sincroniza√ß√£o parcial", `Enviados: ${sent}. Falharam: ${failed}. Os itens com falha continuam pendentes.`);
        }
      }

function getQueue() {
        try { return JSON.parse(localStorage.getItem("ftth_queue") || "[]"); } catch { return []; }
      }
      function setQueue(q) {
        localStorage.setItem("ftth_queue", JSON.stringify(q));
      }

      function openPendentes() {
        const q = getQueue();
        const title = `Pendentes (${q.length})`;
        if (!q.length) {
          showPopup(title, "Nenhum registro pendente.");
          return;
        }

        const rows = q.slice().reverse().map((it) => {
          const kind = (it.kind || "").toUpperCase();
          const ts = (it.ts || "").replace("T", " ").slice(0, 19);
          const ref = it.ref || (it.payload && (it.payload.CTO_ID || it.payload.ENTITY_ID)) || "";
          const err = it.last_error ? `<div class="hint">‚ùå ${escapeHTML(it.last_error)}</div>` : "";
          return `
            <div style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;margin:8px 0;">
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                <div><b>${escapeHTML(kind || "ITEM")}</b> <span class="badge">${escapeHTML(ref)}</span></div>
                <div class="badge">${escapeHTML(ts)}</div>
              </div>
              ${err}
            </div>
          `;
        }).join("");

        openSheet(
          title,
          "Registros salvos no aparelho. Use üîÑ para sincronizar.",
          `
            <div class="btnRow">
              <button class="btn btnPrimary" id="btnSyncNow">üîÑ Sincronizar agora</button>
              <button class="btn btnWarn" id="btnClearQ">üóëÔ∏è Limpar fila</button>
            </div>
            <div class="hint">Limpar fila apaga registros pendentes deste aparelho.</div>
            ${rows}
          `
        );

        const sn = document.getElementById("btnSyncNow");
        if (sn) sn.onclick = () => { closeSheet(); syncQueue({ silentIfEmpty: true, showPopups: true }); };

        const cq = document.getElementById("btnClearQ");
        if (cq) cq.onclick = () => {
          openSheet("Confirmar", "Apagar TODOS os pendentes deste aparelho?", `
            <div class="btnRow">
              <button class="btn btnWarn" id="yesClear">Apagar</button>
              <button class="btn" id="noClear">Cancelar</button>
            </div>
          `);
          document.getElementById("yesClear").onclick = () => { setQueue([]); closeSheet(); if (badge) badge.textContent = "Fila limpa"; };
          document.getElementById("noClear").onclick = closeSheet;
        };
      }


      function openRegistro(kind, refId) {
        // kind: "MOVIMENTACOES" | "LOG_EVENTOS"
        const qlen = getQueue().length;

        const title = kind === "MOVIMENTACOES" ? "Registrar movimenta√ß√£o" : "Registrar evento";
        const subtitle = `üìå Refer√™ncia: <b>${escapeHTML(refId || "")}</b> ‚Ä¢ Pendentes: <b>${qlen}</b>`;

        const body = `
          <div class="field">
            <label>Usu√°rio</label>
            <input id="f_user" placeholder="ex: ryan" />
            <div class="hint">Se estiver logado, o usu√°rio √© preenchido automaticamente.</div>
          </div>

          ${kind === "MOVIMENTACOES" ? `
          <div class="field">
            <label>CTO_ID</label>
            <input id="f_cto" value="${escapeHTML(refId || "")}" placeholder="CTO_ID" />
          </div>
          <div class="field">
            <label>Tipo</label>
            <select id="f_tipo">
              <option value="ATIVACAO">ATIVACAO</option>
              <option value="MANUTENCAO">MANUTENCAO</option>
              <option value="DESATIVACAO">DESATIVACAO</option>
              <option value="OUTRO">OUTRO</option>
            </select>
          </div>
          <div class="field">
            <label>Cliente</label>
            <input id="f_cliente" placeholder="Nome/ID do cliente" />
          </div>
          <div class="field">
            <label>Observa√ß√£o</label>
            <textarea id="f_obs" placeholder="Detalhes do servi√ßo..."></textarea>
          </div>
          ` : `
          <div class="field">
            <label>A√ß√£o</label>
            <select id="f_action">
              <option value="CREATE">CREATE</option>
              <option value="UPDATE">UPDATE</option>
              <option value="DELETE">DELETE</option>
              <option value="NOTE">NOTE</option>
            </select>
          </div>
          <div class="field">
            <label>Entidade</label>
            <input id="f_entity" value="${escapeHTML(refId || "")}" placeholder="ex: CAIXA:123" />
          </div>
          <div class="field">
            <label>Detalhes</label>
            <textarea id="f_details" placeholder="O que aconteceu..."></textarea>
          </div>
          `}

          <div class="btnRow">
            <button class="btn btnPrimary" id="btnSave">üíæ Salvar no aparelho</button>
            <button class="btn btnWarn" id="btnExport">‚¨áÔ∏è Exportar pendentes</button>
          </div>

          <div class="hint">
            Sem login: por enquanto o registro fica <b>offline</b> no aparelho (fila).<br>
            No pr√≥ximo passo a gente liga um endpoint de escrita (Worker ‚Üí Sheets) e envia tudo automaticamente.
          </div>
        `;

        openSheet(title, subtitle, body);

        // Prefill user remembered
        const savedUser = localStorage.getItem("ftth_user") || "";
        
            const authUser = (typeof getAuthUser==="function" ? getAuthUser() : "");
const elUser = document.getElementById("f_user");
        if (elUser) elUser.value = savedUser;

        document.getElementById("btnSave").onclick = () => {
          const user = (document.getElementById("f_user").value || "").trim();
          if (user) localStorage.setItem("ftth_user", user);

          const now = new Date().toISOString();
          const item = { kind, ts: now, user, ref: refId || "", gps: lastGPS(), payload: {} };

          if (kind === "MOVIMENTACOES") {
            item.payload = {
              DATA: now,
              CTO_ID: (document.getElementById("f_cto").value || "").trim(),
              Tipo: document.getElementById("f_tipo").value || "",
              Cliente: (document.getElementById("f_cliente").value || "").trim(),
              Usuario: user,
              Observacao: (document.getElementById("f_obs").value || "").trim(),
            };
          } else {
            item.payload = {
              TS: now,
              USER: user,
              ROLE: "", // pode ser preenchido depois
              ACTION: document.getElementById("f_action").value || "",
              ENTITY: (document.getElementById("f_entity").value || "").trim(),
              ENTITY_ID: (document.getElementById("f_entity").value || "").trim(),
              DETAILS: (document.getElementById("f_details").value || "").trim(),
            };
          }

          const q = getQueue();
          q.push(item);
          setQueue(q);
          if (badge) badge.textContent = `‚úî Registro salvo ‚Ä¢ Pendentes: ${q.length}`;

          if (kind === "MOVIMENTACOES") {
            const cto = item.payload.CTO_ID || "";
            const cliente = item.payload.Cliente || "";
            showPopup(
              "‚úÖ Cadastrado com sucesso",
              `Cliente <b>${escapeHTML(cliente || "-")}</b> cadastrado na CTO <b>${escapeHTML(cto || "-")}</b>.`,
              '<button class="btn btnPrimary" id="btnOk">OK</button>'
            );
            const ok = document.getElementById("btnOk");
            if (ok) ok.onclick = () => { closeSheet(); showSelectedSheet(); };
          } else {
            showSelectedSheet(); // volta pro detalhe
          }
        };

        document.getElementById("btnExport").onclick = () => {
          const q = getQueue();
          const blob = new Blob([JSON.stringify(q, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `ftth_pendentes_${new Date().toISOString().replaceAll(":","-")}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
        };
      }

      function lastGPS() {
        // store last known gps to attach in records
        try {
          const s = localStorage.getItem("ftth_last_gps");
          return s ? JSON.parse(s) : null;
        } catch { return null; }
      }

      function setLastGPS(lng, lat, acc) {
        localStorage.setItem("ftth_last_gps", JSON.stringify({ lng, lat, acc, ts: new Date().toISOString() }));
      }

      function startGPS() {
        if (!navigator.geolocation) {
          if (badge) badge.textContent = "ERRO: geolocaliza√ß√£o n√£o suportada";
          return;
        }
        if (watchId != null) return;

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const lng = pos.coords.longitude;
            const lat = pos.coords.latitude;
            const acc = pos.coords.accuracy;

            setLastGPS(lng, lat, acc);

            if (!userMarker) {
              userMarker = new maplibregl.Marker({ color: "#1e3a8a" })
                .setLngLat([lng, lat])
                .addTo(map);
            } else {
              userMarker.setLngLat([lng, lat]);
            }

            if (followOn) {
              map.easeTo({ center: [lng, lat], zoom: Math.max(map.getZoom(), 15), duration: 500 });
            }
          },
          (err) => {
            if (badge) badge.textContent = `GPS: ${err.message}`;
          },
          { enableHighAccuracy: true, maximumAge: 3000, timeout: 12000 }
        );
      }

      function stopGPS() {
        if (watchId != null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
      }

      function initMap() {
        map = new maplibregl.Map({
          container: "map",
          style: {
            version: 8,
            sources: {
              osm: {
                type: "raster",
                tiles: [
                  "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png",
                ],
                tileSize: 256,
                attribution: "&copy; OpenStreetMap contributors",
              },
            },
            layers: [{ id: "osm", type: "raster", source: "osm" }],
          },
          center: window.PROJECT_CENTER,
          zoom: window.PROJECT_ZOOM,
          attributionControl: true,
        });

        map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-right");

        wireToggles();

        btnGPS.addEventListener("click", () => {
          startGPS();
          const gps = lastGPS();
          if (gps) map.easeTo({ center: [gps.lng, gps.lat], zoom: Math.max(map.getZoom(), 15), duration: 500 });
          else if (badge) badge.textContent = "GPS: permitindo/aguardando...";
        });

        btnFollow.addEventListener("click", () => {
          followOn = !followOn;
          startGPS();
          btnFollow.style.background = followOn ? "rgba(34,197,94,.95)" : "rgba(17,26,46,.92)";
          btnFollow.textContent = followOn ? "üß≠" : "üß≠";
          if (badge) badge.textContent = followOn ? "GPS: seguindo" : "GPS: livre";
        });

        btnPend.addEventListener("click", () => openPendentes());
        btnSync.addEventListener("click", () => syncQueue({ silentIfEmpty: false, showPopups: true }));

        btnReg.addEventListener("click", () => {
          if (selected?.type === "cto") openRegistro("MOVIMENTACOES", selected.props?.cto_id || "");
          else if (selected) openRegistro("LOG_EVENTOS", (selected.props?.id ? `${selected.props.tipo}:${selected.props.id}` : (selected.props?.rota_id ? `ROTA:${selected.props.rota_id}` : "")));
          else showSelectedSheet();
        });

        map.on("load", async () => {
          try {
            // CTOs
            const ctos = await fetchJSON("/api/ctos");
            const movs = await fetchJSON("/api/movimentacoes");

            const usedByCto = new Map();
            // Agrupa movimenta√ß√µes por CTO + calcula "online" por cliente (√∫ltima movimenta√ß√£o)
            const tmpByCto = new Map(); // cto_id -> normalized[]
            const lastByCtoCliente = new Map(); // cto_id -> Map(cliente -> lastMov)

            for (const mv0 of movs) {
              const nm = normalizeMov(mv0);
              const id = String(nm.cto_id || "").trim();
              if (!id) continue;

              usedByCto.set(id, (usedByCto.get(id) || 0) + 1);

              if (!tmpByCto.has(id)) tmpByCto.set(id, []);
              tmpByCto.get(id).push(nm);

              const cliKey = (nm.cliente || "").trim();
              if (cliKey) {
                if (!lastByCtoCliente.has(id)) lastByCtoCliente.set(id, new Map());
                const mCli = lastByCtoCliente.get(id);
                const prev = mCli.get(cliKey);
                const useNew = !prev || (!prev.ts && nm.ts) || (prev.ts && nm.ts && String(nm.ts) > String(prev.ts));
                if (useNew) mCli.set(cliKey, nm);
              }
            }

            movByCto = new Map();
            onlineClientsByCto = new Map();

            for (const [id, arr] of tmpByCto.entries()) {
              const sorted = arr.slice().sort((a,b) => String(b.ts||"").localeCompare(String(a.ts||"")));
              movByCto.set(id, sorted);

              const mCli = lastByCtoCliente.get(id) || new Map();
              const online = [];
              for (const [cliente, last] of mCli.entries()) {
                const t = String(last.tipo || "").toUpperCase();
                if (t === "DESATIVACAO") continue;
                online.push({ cliente, last_ts: last.ts, last_tipo: last.tipo, usuario: last.usuario, obs: last.obs });
              }
              online.sort((a,b) => String(b.last_ts||"").localeCompare(String(a.last_ts||"")));
              onlineClientsByCto.set(id, online);
            }

            const ctosGeo = {
              type: "FeatureCollection",
              features: ctos.map((cto) => {
                const cap = Number(cto.capacidade || 0) || 0;
                const used = usedByCto.get(String(cto.cto_id || "").trim()) || 0;
                const pct = cap > 0 ? used / cap : 0;
                return ({
                  type: "Feature",
                  geometry: { type: "Point", coordinates: [cto.lng, cto.lat] },
                  properties: { ...cto, used, cap, pct },
                });
              }),
            };
            map.addSource("ctos", { type: "geojson", data: ctosGeo });

            // √çcone "X" desenhado em canvas -> ImageData (evita erro de tamanho 0)

            // Glow vermelho (sombra) para CTO cheia (pct >= 1)
            function ensureCtoGlowIcon() {
              if (map.hasImage("cto-glow")) return;

              const size = 128;
              const c = document.createElement("canvas");
              c.width = size; c.height = size;
              const ctx = c.getContext("2d");
              ctx.clearRect(0, 0, size, size);

              const cx = size/2, cy = size/2;
              const rOuter = 56;
              const rInner = 10;

              const g = ctx.createRadialGradient(cx, cy, rInner, cx, cy, rOuter);
              g.addColorStop(0.0, "rgba(239,68,68,0.40)");
              g.addColorStop(0.55, "rgba(239,68,68,0.18)");
              g.addColorStop(1.0, "rgba(239,68,68,0.00)");

              ctx.fillStyle = g;
              ctx.beginPath();
              ctx.arc(cx, cy, rOuter, 0, Math.PI*2);
              ctx.closePath();
              ctx.fill();

              const img = ctx.getImageData(0, 0, size, size);
              map.addImage("cto-glow", { width: size, height: size, data: img.data });
            }

            function ensureCtoXIcon() {
              if (map.hasImage("cto-x")) return;

              const size = 96;
              const c = document.createElement("canvas");
              c.width = size; c.height = size;
              const ctx = c.getContext("2d");
              ctx.clearRect(0, 0, size, size);

              // X shape (white base; color applied via icon-color using SDF)
              const pad = 22;
              ctx.strokeStyle = "#ffffff";
              ctx.lineWidth = 20;
              ctx.lineCap = "round";
              ctx.lineJoin = "round";
              ctx.beginPath();
              ctx.moveTo(pad, pad); ctx.lineTo(size - pad, size - pad);
              ctx.moveTo(size - pad, pad); ctx.lineTo(pad, size - pad);
              ctx.stroke();

              const img = ctx.getImageData(0, 0, size, size);
              map.addImage("cto-x", { width: size, height: size, data: img.data }, { sdf: true });
            }
            ensureCtoXIcon();
            ensureCtoGlowIcon();

            // Layers CTO: outline preto + X colorido + blink quando cheia
            // Outline (preto) - sempre por baixo
            map.addLayer({
              id: "ctos-glow",
              type: "symbol",
              source: "ctos",
              filter: [">=", ["get", "pct"], 1],
              layout: {
                "icon-image": "cto-glow",
                "icon-size": 0.36,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: {
                "icon-opacity": 0.8
              }
            });

                        map.addLayer({
              id: "ctos-x-outline",
              type: "symbol",
              source: "ctos",
              layout: {
                "icon-image": "cto-x",
                "icon-size": 0.23,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: {
                "icon-color": "#000000",
                "icon-opacity": 1
              }
            });

            // X colorido (por ocupa√ß√£o)
            map.addLayer({
              id: "ctos-x",
              type: "symbol",
              source: "ctos",
              layout: {
                "icon-image": "cto-x",
                "icon-size": 0.17,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: {
                "icon-color": [
                  "case",
                  [">=", ["get", "pct"], 1], "#ef4444",
                  [">=", ["get", "pct"], 0.7], "#f59e0b",
                  "#22c55e"
                ],
                "icon-opacity": 1
              }
            });

            // Blink outline (preto) s√≥ CTO cheia
            map.addLayer({
              id: "ctos-x-blink-outline",
              type: "symbol",
              source: "ctos",
              filter: [">=", ["get", "pct"], 1],
              layout: {
                "icon-image": "cto-x",
                "icon-size": 0.17,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: { "icon-color": "#000000", "icon-opacity": 0.85 }
            });

            // Blink colorido (vermelho) s√≥ CTO cheia
            map.addLayer({
              id: "ctos-x-blink",
              type: "symbol",
              source: "ctos",
              filter: [">=", ["get", "pct"], 1],
              layout: {
                "icon-image": "cto-x",
                "icon-size": 0.17,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: { "icon-color": "#ef4444", "icon-opacity": 1 }
            });

            // anima√ß√£o piscar (opacidade) - s√≥ se vis√≠vel
            let blinkOn = true;
            setInterval(() => {
              try {
                const vis = map.getLayoutProperty("ctos-x-blink", "visibility");
                if (vis === "none") return;
                blinkOn = !blinkOn;
                map.setPaintProperty("ctos-x-blink", "icon-opacity", 1);
                map.setPaintProperty("ctos-x-blink-outline", "icon-opacity", 1);
              
                map.setPaintProperty("ctos-glow", "icon-opacity", blinkOn ? 0.95 : 0.10);} catch (_) {}
            }, 900);

            // Visibilidade inicial conforme toggle            setLayerVisible("ctos-glow", elToggleCTOs?.checked ?? true);
            setLayerVisible("ctos-glow", elToggleCTOs?.checked ?? true);
            setLayerVisible("ctos-x-outline", elToggleCTOs?.checked ?? true);
            setLayerVisible("ctos-x", elToggleCTOs?.checked ?? true);
            setLayerVisible("ctos-x-blink-outline", elToggleCTOs?.checked ?? true);
            setLayerVisible("ctos-x-blink", elToggleCTOs?.checked ?? true);


// Caixas (CE/CDO) - √≠cones via Canvas (sem fontes)
            const caixas = await fetchJSON("/api/caixas_emenda_cdo");
            const caixasGeo = {
              type: "FeatureCollection",
              features: caixas.map((cx) => ({
                type: "Feature",
                geometry: { type: "Point", coordinates: [cx.lng, cx.lat] },
                properties: cx,
              })),
            };
            map.addSource("caixas", { type: "geojson", data: caixasGeo });

            function ensureCaixaIcons() {
              // √çcones vazados (hollow) em SDF para permitir icon-color (laranja/roxo) e contorno preto.
              // CE: quadrado vazado
              if (!map.hasImage("ce-square")) {
                const size = 96;
                const c = document.createElement("canvas");
                c.width = size; c.height = size;
                const ctx = c.getContext("2d");
                ctx.clearRect(0,0,size,size);

                // desenha um bloco branco e recorta o miolo para ficar vazado
                const pad = 18;
                const w = size - pad*2;
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(pad, pad, w, w);

                

                const img = ctx.getImageData(0,0,size,size);
                map.addImage("ce-square", { width:size, height:size, data: img.data }, { sdf:true });
              }


              // CDO: tri√¢ngulo vazado
              if (!map.hasImage("cdo-tri")) {
                const size = 96;
                const c = document.createElement("canvas");
                c.width = size; c.height = size;
                const ctx = c.getContext("2d");
                ctx.clearRect(0,0,size,size);

                ctx.fillStyle = "#ffffff";
                ctx.beginPath();
                ctx.moveTo(size/2, 14);
                ctx.lineTo(size-14, size-14);
                ctx.lineTo(14, size-14);
                ctx.closePath();
                ctx.fill();

                // recorta o miolo para ficar vazado (hollow)
                

                const img = ctx.getImageData(0,0,size,size);
                map.addImage("cdo-tri", { width:size, height:size, data: img.data }, { sdf:true });
              }
            }
            ensureCaixaIcons();

            map.addLayer({
              id: "caixas-outline",
              type: "symbol",
              source: "caixas",
              layout: {
                "icon-image": [
                  "case",
                  ["==", ["upcase", ["to-string", ["get","tipo"]]], "CE"], "ce-square",
                  "cdo-tri"
                ],
                "icon-size": 0.22,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: {
                "icon-color": "#000000",
                "icon-opacity": 0.85
              }
            });

            map.addLayer({
              id: "caixas-layer",
              type: "symbol",
              source: "caixas",
              layout: {
                "icon-image": [
                  "case",
                  ["==", ["upcase", ["to-string", ["get","tipo"]]], "CE"], "ce-square",
                  "cdo-tri"
                ],
                "icon-size": 0.20,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true
              },
              paint: {
                "icon-color": [
                  "case",
                  ["==", ["upcase", ["to-string", ["get","tipo"]]], "CE"], "#f97316",  // CE laranja
                  "#a855f7" // CDO roxo
                ],
                "icon-opacity": 0.95
              }
            });

            setLayerVisible("caixas-outline", elToggleCaixas?.checked ?? true);
            setLayerVisible("caixas-layer", elToggleCaixas?.checked ?? true);


            // Rotas (GeoJSON FeatureCollection)
            const rotas = await fetchJSON("/api/rotas_fibras");
            map.addSource("rotas", { type: "geojson", data: rotas });
            map.addLayer({
              id: "rotas-layer",
              type: "line",
              source: "rotas",
              layout: { "line-join": "round", "line-cap": "round" },
              paint: {
                "line-color": [
                  "case",
                  ["in","BACKBONE",["to-string",["get","tipos"]]], "#1e40af", // backbone azul (escuro)
                  ["in","RAMAL",["to-string",["get","tipos"]]], "#000000",    // ramal preto
                  ["in","DROP",["to-string",["get","tipos"]]], "#22c55e",     // drop verde
                  "#f59e0b" // rota padr√£o laranja
                ],
                "line-width": [
                  "case",
                  ["in","BACKBONE",["to-string",["get","tipos"]]], 6,
                  ["in","RAMAL",["to-string",["get","tipos"]]], 3.5,
                  ["in","DROP",["to-string",["get","tipos"]]], 2,
                  3
                ],
                "line-opacity": 0.92
              },
            });
            try { map.moveLayer("rotas-layer", "ctos-glow"); } catch(e) { try { map.moveLayer("rotas-layer", "ctos-x-outline"); } catch(_){} }
            setLayerVisible("rotas-layer", elToggleRotas?.checked ?? true);

            // Intera√ß√µes: toque seleciona e abre sheet (mobile-first)
            map.on("click", "ctos-x", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "cto", props, lngLat: e.lngLat };
              showSelectedSheet();
            });
            map.on("click", "caixas-layer", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "caixa", props, lngLat: e.lngLat };
              showSelectedSheet();
            });
            map.on("click", "rotas-layer", (e) => {
              const props = e.features?.[0]?.properties || {};
              selected = { type: "rota", props, lngLat: e.lngLat };
              showSelectedSheet();
            });

            // Cursor desktop (n√£o atrapalha mobile)
            map.on("mouseenter", "ctos-x", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "ctos-x", () => (map.getCanvas().style.cursor = ""));
            map.on("mouseenter", "caixas-layer", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "caixas-layer", () => (map.getCanvas().style.cursor = ""));
            map.on("mouseenter", "rotas-layer", () => (map.getCanvas().style.cursor = "pointer"));
            map.on("mouseleave", "rotas-layer", () => (map.getCanvas().style.cursor = ""));

            if (badge) badge.textContent = `BUILD: ${window.__BUILD_ID__} ‚Ä¢ OK${IS_FILE_ORIGIN ? " ‚Ä¢ (file:// sem sync)" : ""}`;
          } catch (err) {
            console.error(err);
            if (badge) badge.textContent = `ERRO: ${String(err?.message ?? err)}`;
          }
        });

        return map;
      }

      window.addEventListener("offline", onBecameOffline);
      window.addEventListener("online", onBecameOnline);
      if (!navigator.onLine) onBecameOffline();
      setInterval(() => {
        if (IS_FILE_ORIGIN) return;
        if (navigator.onLine) syncQueue({ silentIfEmpty: true, showPopups: false });
      }, 45000);

      document.getElementById("login-btn")?.addEventListener("click", doLogin);
      document.getElementById("login-pass")?.addEventListener("keydown", (e)=>{ if (e.key==="Enter") doLogin(); });
      document.getElementById("login-user")?.addEventListener("keydown", (e)=>{ if (e.key==="Enter") doLogin(); });

      // Start only if authenticated
      if (!checkAuthOrShowLogin()) return;
      // best-effort: atualiza role via /api/me
      fetchMeRole().then(()=>{
        const u = getAuthUser() || localStorage.getItem('ftth_user') || '‚Äî';
        const el = document.getElementById('userName');
        if (el) el.textContent = `${u} (${getAuthRole()})`;
        applyPermissionsToUI();
      });
      window.__APP_STARTED__ = true;
      initMap();
    });
  </script>
</body>
</html>
